{% extends "base.html" %}

{% block title %}Triggers - Stock Candidates{% endblock %}

{% block page_title %}ðŸŽ¯ Trigger Events{% endblock %}
{% block page_description %}Stock candidates identified by custom trigger rules{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="card-title mb-3">
                                <i class="fas fa-filter"></i> Select Date
                            </h5>
                            <select id="triggerDateSelect" class="form-select">
                                <option value="">Loading dates...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div id="summaryStats" class="text-end">
                                <h6 class="text-muted mb-2">Summary</h6>
                                <div id="statsContent">
                                    <span class="badge bg-primary me-2">Triggers: <span id="triggerCount">0</span></span>
                                    <span class="badge bg-success">Stocks: <span id="stockCount">0</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading trigger events...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="alert alert-danger" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i> 
        <span id="errorMessage">Error loading data</span>
    </div>

    <!-- No Data State -->
    <div id="noDataState" class="alert alert-info" style="display: none;">
        <i class="fas fa-info-circle"></i> 
        No trigger events found. Run the triggers script to generate data.
        <br><br>
        <code>python db_scripts/run_triggers.py [--date YYYY-MM-DD]</code>
    </div>

    <!-- Triggers Content -->
    <div id="triggersContent" style="display: none;">
        <!-- Trigger sections will be dynamically inserted here -->
    </div>
</div>

<style>
    .trigger-section {
        margin-bottom: 2rem;
    }
    
    .trigger-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px 8px 0 0;
        margin-bottom: 0;
    }
    
    .trigger-table {
        background: white;
        border-radius: 0 0 8px 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .trigger-table table {
        margin-bottom: 0;
    }
    
    .badge-market-cap {
        font-size: 0.85rem;
        padding: 0.4em 0.6em;
    }
    
    .metadata-cell {
        font-size: 0.9rem;
    }
    
    .metadata-cell .badge {
        margin: 0.1rem;
    }
    
    .ticker-link {
        font-weight: bold;
        font-size: 1.1rem;
    }
    
    .sortable-header {
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s ease;
    }
    
    .sortable-header:hover {
        background-color: rgba(0,0,0,0.05);
    }
    
    .sortable-header i {
        margin-left: 5px;
        font-size: 0.8em;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentDate = null;
let triggerDataStore = {}; // Store data for each trigger for sorting
let triggerSortState = {}; // Track sort state for each trigger

// Load available dates on page load
document.addEventListener('DOMContentLoaded', function() {
    loadTriggerDates();
});

function loadTriggerDates() {
    fetch('/api/frontend/triggers/dates')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('triggerDateSelect');
            
            if (data.error) {
                showError('Failed to load dates: ' + data.error);
                return;
            }
            
            if (!data.dates || data.dates.length === 0) {
                select.innerHTML = '<option value="">No trigger data available</option>';
                showNoData();
                return;
            }
            
            // Populate date dropdown
            select.innerHTML = data.dates.map(date => 
                `<option value="${date}">${date}</option>`
            ).join('');
            
            // Load most recent date by default
            currentDate = data.dates[0];
            select.value = currentDate;
            loadTriggerEvents(currentDate);
            
            // Add change event listener
            select.addEventListener('change', function() {
                currentDate = this.value;
                if (currentDate) {
                    loadTriggerEvents(currentDate);
                }
            });
        })
        .catch(error => {
            console.error('Error loading dates:', error);
            showError('Failed to load trigger dates');
        });
}

function loadTriggerEvents(date) {
    showLoading();
    
    fetch(`/api/frontend/triggers/events?date=${date}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError('Failed to load events: ' + data.error);
                return;
            }
            
            if (!data.events || Object.keys(data.events).length === 0) {
                showNoData();
                return;
            }
            
            displayTriggerEvents(data);
        })
        .catch(error => {
            console.error('Error loading events:', error);
            showError('Failed to load trigger events');
        });
}

function displayTriggerEvents(data) {
    const container = document.getElementById('triggersContent');
    
    // Update summary stats
    document.getElementById('triggerCount').textContent = data.total_triggers || 0;
    document.getElementById('stockCount').textContent = data.total_stocks || 0;
    
    // Clear container
    container.innerHTML = '';
    
    // Sort triggers alphabetically
    const triggerNames = Object.keys(data.events).sort();
    
    // Create a section for each trigger
    triggerNames.forEach(triggerName => {
        const stocks = data.events[triggerName];
        
        // Store data for sorting
        triggerDataStore[triggerName] = stocks;
        triggerSortState[triggerName] = { column: null, direction: 'asc' };
        
        const section = createTriggerSection(triggerName, stocks);
        container.appendChild(section);
    });
    
    // Show content, hide loading
    showContent();
}

function createTriggerSection(triggerName, stocks) {
    const section = document.createElement('div');
    section.className = 'trigger-section';
    const triggerKey = triggerName.replace(/\s+/g, '_');
    
    // Header
    const header = document.createElement('div');
    header.className = 'trigger-header';
    header.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-bolt"></i> ${triggerName}
            </h5>
            <span class="badge bg-light text-dark">${stocks.length} stocks</span>
        </div>
    `;
    
    // Table
    const tableContainer = document.createElement('div');
    tableContainer.className = 'trigger-table';
    
    const table = document.createElement('table');
    table.className = 'table table-hover mb-0';
    table.id = `trigger-table-${triggerKey}`;
    
    // Table header with sortable columns
    table.innerHTML = `
        <thead class="table-light">
            <tr>
                <th class="sortable-header" onclick="sortTriggerTable('${triggerName}', 'ticker')" style="width: 10%;">
                    Ticker <i class="fas fa-sort text-muted" id="sort-icon-${triggerKey}-ticker"></i>
                </th>
                <th class="sortable-header" onclick="sortTriggerTable('${triggerName}', 'company_name')" style="width: 20%;">
                    Company <i class="fas fa-sort text-muted" id="sort-icon-${triggerKey}-company_name"></i>
                </th>
                <th class="sortable-header" onclick="sortTriggerTable('${triggerName}', 'sector')" style="width: 15%;">
                    Sector <i class="fas fa-sort text-muted" id="sort-icon-${triggerKey}-sector"></i>
                </th>
                <th class="sortable-header" onclick="sortTriggerTable('${triggerName}', 'industry')" style="width: 15%;">
                    Industry <i class="fas fa-sort text-muted" id="sort-icon-${triggerKey}-industry"></i>
                </th>
                <th class="sortable-header" onclick="sortTriggerTable('${triggerName}', 'market_cap')" style="width: 10%;">
                    Market Cap <i class="fas fa-sort text-muted" id="sort-icon-${triggerKey}-market_cap"></i>
                </th>
                <th style="width: 30%;">Metrics</th>
            </tr>
        </thead>
        <tbody id="tbody-${triggerKey}">
        </tbody>
    `;
    
    const tbody = table.querySelector('tbody');
    
    // Add rows for each stock
    stocks.forEach(stock => {
        const row = createStockRow(stock);
        tbody.appendChild(row);
    });
    
    tableContainer.appendChild(table);
    section.appendChild(header);
    section.appendChild(tableContainer);
    
    return section;
}

function createStockRow(stock) {
    const row = document.createElement('tr');
    
    // Format market cap
    let marketCapFormatted = 'N/A';
    if (stock.market_cap) {
        const cap = stock.market_cap;
        if (cap >= 1e12) {
            marketCapFormatted = `$${(cap / 1e12).toFixed(1)}T`;
        } else if (cap >= 1e9) {
            marketCapFormatted = `$${(cap / 1e9).toFixed(1)}B`;
        } else if (cap >= 1e6) {
            marketCapFormatted = `$${(cap / 1e6).toFixed(1)}M`;
        }
    }
    
    // Build metrics HTML
    let metricsHtml = '';
    const metadata = stock.metadata || {};
    
    // Add return metrics
    ['return_1d', 'return_5d', 'return_20d', 'return_60d'].forEach(key => {
        if (metadata[key] !== null && metadata[key] !== undefined) {
            const value = metadata[key];
            const colorClass = value >= 0 ? 'bg-success' : 'bg-danger';
            const label = key.replace('return_', '').toUpperCase();
            metricsHtml += `<span class="badge ${colorClass} me-1">${label}: ${value.toFixed(2)}%</span>`;
        }
    });
    
    // Add volume change
    if (metadata.volume_change) {
        metricsHtml += `<span class="badge bg-warning text-dark me-1">Vol: ${metadata.volume_change.toFixed(0)}%</span>`;
    }
    
    // Add price
    if (metadata.price) {
        metricsHtml += `<span class="badge bg-info text-dark me-1">$${metadata.price.toFixed(2)}</span>`;
    }
    
    row.innerHTML = `
        <td>
            <a href="/ticker/${stock.ticker}" class="text-decoration-none ticker-link">
                ${stock.ticker}
            </a>
        </td>
        <td>${stock.company_name || 'N/A'}</td>
        <td><small>${stock.sector || 'N/A'}</small></td>
        <td><small>${stock.industry || 'N/A'}</small></td>
        <td>
            <span class="badge badge-market-cap bg-secondary">${marketCapFormatted}</span>
        </td>
        <td class="metadata-cell">
            ${metricsHtml}
        </td>
    `;
    
    return row;
}

function showLoading() {
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('errorState').style.display = 'none';
    document.getElementById('noDataState').style.display = 'none';
    document.getElementById('triggersContent').style.display = 'none';
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('errorState').style.display = 'block';
    document.getElementById('noDataState').style.display = 'none';
    document.getElementById('triggersContent').style.display = 'none';
}

function showNoData() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('errorState').style.display = 'none';
    document.getElementById('noDataState').style.display = 'block';
    document.getElementById('triggersContent').style.display = 'none';
}

function showContent() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('errorState').style.display = 'none';
    document.getElementById('noDataState').style.display = 'none';
    document.getElementById('triggersContent').style.display = 'block';
}

function sortTriggerTable(triggerName, column) {
    const state = triggerSortState[triggerName];
    const triggerKey = triggerName.replace(/\s+/g, '_');
    
    // Toggle direction if same column, otherwise default to ascending
    if (state.column === column) {
        state.direction = state.direction === 'asc' ? 'desc' : 'asc';
    } else {
        state.direction = 'asc';
    }
    state.column = column;
    
    // Update sort icons
    updateSortIcons(triggerKey, column, state.direction);
    
    // Sort the data
    const stocks = triggerDataStore[triggerName];
    const sortedStocks = sortStocks(stocks, column, state.direction);
    
    // Redraw table body
    redrawTriggerTable(triggerKey, sortedStocks);
}

function updateSortIcons(triggerKey, activeColumn, direction) {
    // Reset all icons for this trigger
    const allIcons = document.querySelectorAll(`[id^="sort-icon-${triggerKey}-"]`);
    allIcons.forEach(icon => {
        icon.className = 'fas fa-sort text-muted';
    });
    
    // Set active icon
    const activeIcon = document.getElementById(`sort-icon-${triggerKey}-${activeColumn}`);
    if (activeIcon) {
        activeIcon.className = direction === 'asc' ? 'fas fa-sort-up text-primary' : 'fas fa-sort-down text-primary';
    }
}

function sortStocks(stocks, column, direction) {
    return [...stocks].sort((a, b) => {
        let aVal = a[column];
        let bVal = b[column];
        
        // Handle null/undefined values
        if (aVal == null && bVal == null) return 0;
        if (aVal == null) return 1;
        if (bVal == null) return -1;
        
        // Special handling for market_cap (numeric comparison)
        if (column === 'market_cap') {
            aVal = aVal || 0;
            bVal = bVal || 0;
            return direction === 'asc' ? aVal - bVal : bVal - aVal;
        }
        
        // String comparison (case insensitive)
        if (typeof aVal === 'string' && typeof bVal === 'string') {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
        }
        
        if (aVal < bVal) return direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return direction === 'asc' ? 1 : -1;
        return 0;
    });
}

function redrawTriggerTable(triggerKey, stocks) {
    const tbody = document.getElementById(`tbody-${triggerKey}`);
    if (!tbody) return;
    
    tbody.innerHTML = '';
    stocks.forEach(stock => {
        const row = createStockRow(stock);
        tbody.appendChild(row);
    });
}
</script>
{% endblock %}

