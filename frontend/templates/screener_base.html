{% extends "base.html" %}

{% block content %}

            <div>
                <button type="button" class="btn btn-success btn-sm me-2" id="commitFlagsBtn" onclick="commitFlags()" style="display: none;">
                    <i class="fas fa-save"></i> Commit Flags (0)
                </button>

            </div>

<!-- Market Cap Categories -->
{% set categories = [
    {'key': 'mega', 'label': 'Mega Cap', 'description': 'Over $100B', 'color': 'danger'},
    {'key': 'large', 'label': 'Large Cap', 'description': '$20B - $100B', 'color': 'warning'},
    {'key': 'mid', 'label': 'Mid Cap', 'description': '$2B - $20B', 'color': 'info'},
    {'key': 'small', 'label': 'Small Cap', 'description': '$200M - $2B', 'color': 'primary'},
    {'key': 'micro', 'label': 'Micro Cap', 'description': 'Up to $200M', 'color': 'success'}
] %}

{% for category in categories %}
<div class="mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="text-{{ category.color }} mb-0">
                {{ category.label }}
                <small class="text-muted">({{ category.description }})</small>
            </h2>
            <p class="text-muted mb-0" id="subtitle-{{ category.key }}"></p>
        </div>
        <button type="button" class="btn btn-outline-{{ category.color }} btn-sm select-all-btn" onclick="selectAll{{ category.label|replace(' ', '') }}()">
            Select All
        </button>
    </div>
    
    <div id="loading-{{ category.key }}" class="loading">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Loading {{ category.label }} stocks...</p>
    </div>
    
    <div id="error-{{ category.key }}" class="error" style="display: none;"></div>
    
    <div id="results-{{ category.key }}" style="display: none;">
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead class="table-dark sticky-top" id="tableHeader-{{ category.key }}">
                    <!-- Table header will be generated by JavaScript -->
                </thead>
                <tbody id="stockTableBody-{{ category.key }}">
                </tbody>
            </table>
        </div>
    </div>
</div>

{% if not loop.last %}
<div class="section-divider"></div>
{% endif %}

{% endfor %}
{% endblock %}

{% block extra_js %}
<script>
    // Page configuration - to be overridden by individual pages
    let pageConfig = {
        type: 'returns',
        returnDays: '',
        apiMicro: '',
        apiSmall: '',
        apiMid: '',
        apiLarge: '',
        apiMega: ''
    };

    // Market cap categories
    const marketCapCategories = [
        {key: 'mega', label: 'Mega Cap', description: 'Over $100B'},
        {key: 'large', label: 'Large Cap', description: '$20B - $100B'},
        {key: 'mid', label: 'Mid Cap', description: '$2B - $20B'},
        {key: 'small', label: 'Small Cap', description: '$200M - $2B'},
        {key: 'micro', label: 'Micro Cap', description: 'Up to $200M'}
    ];

    // Global subtitle helpers
    const RETURN_THRESHOLDS = {1:5,5:10,20:15,60:20,120:30};
    let thresholdPct = null;
    let categoryCounts = {};

    function updateSubtitles() {
        const descEl = document.getElementById('pageDescription');
        if (!descEl) return;

        let text = '';
        if (pageConfig.type === 'returns' && thresholdPct) {
            text += `Threshold applied - ${thresholdPct}%. `;
        } else if (pageConfig.type === 'sea_change') {
            text += `SeaChange Criteria: Dollar Volume >$200M, Volume >3x 20D avg, Low >5% above prev close OR Close >15% above prev close (Last 120 days). `;
        }
        
        // Show counts for all categories
        const countStrs = marketCapCategories.map(cat => {
            const count = categoryCounts[cat.key] !== undefined ? categoryCounts[cat.key] : '...';
            return `${cat.label}: ${count}`;
        });
        text += countStrs.join(' | ');

        descEl.textContent = text;

        // Update individual subtitles
        marketCapCategories.forEach(cat => {
            const subtitleEl = document.getElementById(`subtitle-${cat.key}`);
            if (subtitleEl && categoryCounts[cat.key] !== undefined) {
                subtitleEl.textContent = `${categoryCounts[cat.key]} stocks found`;
            }
        });
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
        marketCapCategories.forEach(cat => loadStocksForCategory(cat.key));
    });

    function initializePage() {
        const columns = COLUMN_CONFIGS[pageConfig.type].columns;
        
        // Set the return period label for returns pages
        if (pageConfig.type === 'returns' && pageConfig.returnDays) {
            const returnColumn = columns.find(col => col.key === 'price_change_pct');
            if (returnColumn) {
                returnColumn.label = `${pageConfig.returnDays} Return`;
            }
        }
        
        // Generate table headers for each category
        marketCapCategories.forEach(cat => {
            const headerEl = document.getElementById(`tableHeader-${cat.key}`);
            if (headerEl) {
                headerEl.innerHTML = generateTableHeader(columns, cat.key);
            }
        });

        // Determine threshold based on page configuration
        if (pageConfig.type === 'returns') {
            const days = parseInt(pageConfig.returnDays);
            thresholdPct = RETURN_THRESHOLDS[days] || null;
        } else {
            thresholdPct = null;
        }
    }

    function loadStocksForCategory(categoryKey) {
        const loading = document.getElementById(`loading-${categoryKey}`);
        const error = document.getElementById(`error-${categoryKey}`);
        const results = document.getElementById(`results-${categoryKey}`);
        
        loading.style.display = 'block';
        error.style.display = 'none';
        results.style.display = 'none';
        
        const apiUrl = pageConfig[`api${categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1)}`];
        if (!apiUrl) {
            loading.style.display = 'none';
            error.textContent = 'API endpoint not configured';
            error.style.display = 'block';
            return;
        }
        
        fetch(appendRewindDate(apiUrl))
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                loading.style.display = 'none';
                
                if (data.error) {
                    error.textContent = data.error;
                    error.style.display = 'block';
                    return;
                }
                
                // Format volume and dollar_volume fields
                data = data.map(stock => {
                    if (stock.volume) {
                        // Format volume in millions/billions
                        if (stock.volume >= 1e9) {
                            stock.volume = `${(stock.volume / 1e9).toFixed(2)}B`;
                        } else if (stock.volume >= 1e6) {
                            stock.volume = `${(stock.volume / 1e6).toFixed(2)}M`;
                        } else if (stock.volume >= 1e3) {
                            stock.volume = `${(stock.volume / 1e3).toFixed(2)}K`;
                        } else {
                            stock.volume = stock.volume.toLocaleString();
                        }
                    }
                    
                    if (stock.dollar_volume) {
                        // Format dollar volume
                        if (stock.dollar_volume >= 1e9) {
                            stock.dollar_volume = `$${(stock.dollar_volume / 1e9).toFixed(2)}B`;
                        } else if (stock.dollar_volume >= 1e6) {
                            stock.dollar_volume = `$${(stock.dollar_volume / 1e6).toFixed(2)}M`;
                        } else if (stock.dollar_volume >= 1e3) {
                            stock.dollar_volume = `$${(stock.dollar_volume / 1e3).toFixed(2)}K`;
                        } else {
                            stock.dollar_volume = `$${stock.dollar_volume.toLocaleString()}`;
                        }
                    }
                    
                    return stock;
                });
                
                // Apply default sorting based on page type
                let defaultSortColumn = null;
                let defaultSortDirection = 'desc';
                
                if (pageConfig.type === 'sea_change') {
                    // Sort by latest event date
                    defaultSortColumn = 'sea_change_events';
                    data = sortStockData(data, defaultSortColumn, defaultSortDirection);
                } else if (pageConfig.type === 'returns' && pageConfig.returnDays) {
                    // Sort by the appropriate return column
                    const days = pageConfig.returnDays.replace('-Day', '');
                    // For 1-day returns, the enriched return_1d column might not exist, so use return_pct as fallback
                    if (days === '1') {
                        defaultSortColumn = 'return_pct';
                    } else {
                        defaultSortColumn = `return_${days.toLowerCase()}d`;
                    }
                    data = sortStockData(data, defaultSortColumn, defaultSortDirection);
                } else if (pageConfig.type === 'gapper') {
                    // Sort by price change percentage (gap)
                    defaultSortColumn = 'price_change_pct';
                    data = sortStockData(data, defaultSortColumn, defaultSortDirection);
                } else if (pageConfig.type === 'volume') {
                    // Sort by volume ratio
                    defaultSortColumn = 'volume_ratio';
                    data = sortStockData(data, defaultSortColumn, defaultSortDirection);
                }
                
                // Update sort state to reflect the default sort
                if (defaultSortColumn) {
                    if (!sortState[categoryKey]) {
                        sortState[categoryKey] = { column: '', direction: 'asc' };
                    }
                    sortState[categoryKey].column = defaultSortColumn;
                    sortState[categoryKey].direction = defaultSortDirection;
                }
                
                displayStocks(data, `stockTableBody-${categoryKey}`);
                
                // Update sort icons to reflect the default sort
                if (defaultSortColumn) {
                    updateSortIcons(categoryKey, defaultSortColumn, defaultSortDirection);
                }
                results.style.display = 'block';
                categoryCounts[categoryKey] = data.length;
                updateSubtitles();
            })
            .catch(err => {
                loading.style.display = 'none';
                error.textContent = 'Error loading stocks: ' + err.message;
                error.style.display = 'block';
            });
    }

    // Select All functions for each category
    function selectAllMegaCap() { selectAllInCategory('mega'); }
    function selectAllLargeCap() { selectAllInCategory('large'); }
    function selectAllMidCap() { selectAllInCategory('mid'); }
    function selectAllSmallCap() { selectAllInCategory('small'); }
    function selectAllMicroCap() { selectAllInCategory('micro'); }

    function selectAllInCategory(categoryKey) {
        const tbody = document.getElementById(`stockTableBody-${categoryKey}`);
        if (!tbody) return;
        
        const checkboxes = tbody.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => {
            cb.checked = true;
            const ticker = cb.getAttribute('data-ticker');
            if (ticker) {
                selectedStocks.add(ticker);
            }
        });
        updateSelectedStocksUI();
    }
</script>
{% endblock %}
