{% extends "base.html" %}

{% block title %}{{ ticker }} - Stock Metrics{% endblock %}

{% block extra_styles %}
.stock-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.ticker-info h1 {
    font-family: 'JetBrains Mono', monospace;
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--accent-green);
    margin-bottom: 0.25rem;
}

.company-name {
    font-size: 1.1rem;
    color: var(--text-secondary);
}

.header-tags {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
}

.tag {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    background: var(--bg-card-hover);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.price-display {
    text-align: right;
}

.current-price {
    font-family: 'JetBrains Mono', monospace;
    font-size: 2rem;
    font-weight: 700;
}

.price-positive { color: var(--accent-green); }
.price-negative { color: var(--accent-red); }

.price-subtext {
    font-size: 0.85rem;
    color: var(--text-muted);
}

/* Data Sections Container (main_view style) */
.data-sections {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
    margin-bottom: 1.5rem;
}

/* Section Wrapper */
.section-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    align-items: stretch;
}

/* Individual Section */
.data-section {
    display: flex;
    flex-direction: column;
    background: var(--bg-card);
    border-radius: 6px;
    padding: 0.4rem 0.5rem;
    border-left: 3px solid var(--border-color);
    flex: 1 1 auto;
    min-width: fit-content;
}

.data-section.price-section {
    border-left-color: var(--accent-blue);
    flex: 1.2;
}

.data-section.technical-section {
    border-left-color: var(--accent-purple);
    flex: 1;
}

.data-section.returns-section {
    border-left-color: var(--accent-green);
    flex: 1.5;
}

.data-section.valuation-section {
    border-left-color: var(--accent-yellow);
    flex: 1;
}

.data-section.growth-section {
    border-left-color: #ff79c6;
    flex: 1.6;
}

.data-section.short-section {
    border-left-color: var(--accent-red);
    flex: 1.2;
}

.data-section.events-section {
    border-left-color: var(--accent-yellow);
    background: rgba(210, 153, 34, 0.05);
    flex: 1;
}

.data-section.info-section {
    border-left-color: var(--text-muted);
    flex: 1.5;
}

/* Full-width row layout */
.section-group.full-row {
    flex-wrap: nowrap;
}

.section-header {
    font-size: 0.6rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    margin-bottom: 0.15rem;
    opacity: 0.7;
    line-height: 1;
}

.section-row {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    justify-content: flex-start;
    width: 100%;
}

.section-row .data-cell {
    flex: 1 1 auto;
}

.data-cell {
    display: flex;
    flex-direction: column;
    min-width: 0;
    line-height: 1;
}

.data-cell.inline {
    flex-direction: row;
    align-items: baseline;
    gap: 0.2rem;
}

.data-label {
    font-size: 0.55rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.2px;
    margin-bottom: 0;
    line-height: 1;
}

.data-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    color: var(--text-primary);
    line-height: 1.1;
}

.data-value.lg {
    font-size: 1.1rem;
    font-weight: 600;
}

.data-value.sm {
    font-size: 0.8rem;
}

.data-value.positive {
    color: var(--accent-green);
}

.data-value.negative {
    color: var(--accent-red);
}

.data-value.muted {
    color: var(--text-muted);
}

.data-value.highlight {
    color: var(--accent-purple);
    font-weight: 600;
}

.data-value.warn {
    color: var(--accent-yellow);
}

/* Compact return display */
.returns-inline {
    display: flex;
    gap: 0.3rem;
    align-items: center;
    justify-content: space-between;
    flex: 1;
}

.return-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 36px;
    flex: 1;
}

.return-item .data-label {
    font-size: 0.52rem;
}

.return-item .data-value {
    font-size: 0.88rem;
}

/* Growth timeline display */
.growth-timeline {
    display: flex;
    gap: 0.25rem;
    align-items: center;
    flex: 1;
}

.growth-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.08rem 0.2rem;
    border-radius: 3px;
    min-width: 40px;
    flex: 1;
}

.growth-item .data-label {
    font-size: 0.5rem;
}

.growth-item .data-value {
    font-size: 0.82rem;
}

.growth-item.past {
    opacity: 0.7;
}

.growth-item.current {
    background: rgba(163, 113, 247, 0.15);
}

.growth-item.future {
    background: rgba(88, 166, 255, 0.1);
}

.growth-avg {
    border-left: 1px solid var(--border-color);
    padding-left: 0.25rem;
    margin-left: 0.1rem;
}

/* Valuation pairs */
.val-pair {
    display: flex;
    gap: 0.4rem;
    align-items: flex-end;
    flex: 1;
}

.val-item {
    display: flex;
    flex-direction: column;
}

.val-item.forward .data-label {
    color: var(--accent-blue);
}

.valuation-section .section-row {
    gap: 0.7rem;
}

/* Short interest bar */
.short-bar {
    display: flex;
    align-items: center;
    gap: 0.2rem;
}

.short-bar-container {
    width: 40px;
    height: 4px;
    background: var(--border-color);
    border-radius: 2px;
    overflow: hidden;
}

.short-bar-fill {
    height: 100%;
    border-radius: 2px;
    background: var(--accent-red);
    transition: width 0.3s;
}

/* RSI Bar */
.rsi-cell {
    display: flex;
    align-items: center;
    gap: 0.2rem;
}

.rsi-bar-container {
    width: 30px;
    height: 4px;
    background: var(--border-color);
    border-radius: 2px;
    overflow: hidden;
}

.rsi-bar {
    height: 100%;
    border-radius: 2px;
    transition: width 0.3s ease;
}

.rsi-bar.high {
    background: linear-gradient(90deg, var(--accent-green), #4eca5f);
}

.rsi-bar.mid {
    background: linear-gradient(90deg, var(--accent-yellow), #e5b526);
}

.rsi-bar.low {
    background: linear-gradient(90deg, var(--accent-red), #ff6b5e);
}

/* Event badges and date pills */
.event-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    padding: 0.08rem 0.25rem;
    border-radius: 3px;
    display: inline-block;
}

.event-badge.spike {
    background: rgba(210, 153, 34, 0.2);
    color: var(--accent-yellow);
}

.event-badge.gap {
    background: rgba(248, 81, 73, 0.2);
    color: var(--accent-red);
}

.date-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.15rem;
}

.date-pill {
    display: inline-block;
    padding: 0.05rem 0.2rem;
    border-radius: 2px;
    font-size: 0.7rem;
    font-family: 'JetBrains Mono', monospace;
    white-space: nowrap;
}

.date-pill.spike {
    background: rgba(210, 153, 34, 0.15);
    color: var(--accent-yellow);
}

.date-pill.gap {
    background: rgba(248, 81, 73, 0.15);
    color: var(--accent-red);
}

/* Value class helpers */
.value-positive { color: var(--accent-green); }
.value-negative { color: var(--accent-red); }

/* Responsive */
@media (max-width: 900px) {
    .section-group.full-row {
        flex-wrap: wrap;
    }
    
    .section-group .data-section {
        min-width: 150px;
    }
}

@media (max-width: 768px) {
    .section-group {
        flex-direction: column;
        gap: 0.3rem;
    }
    
    .section-group.full-row {
        flex-wrap: wrap;
    }
    
    .data-section {
        width: 100%;
    }
    
    .returns-inline,
    .growth-timeline {
        flex-wrap: wrap;
    }
}

/* Chart Section */
.chart-section {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color);
}

.chart-header h2 {
    font-size: 0.9rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin: 0;
}

.chart-timeframe {
    display: flex;
    gap: 0.4rem;
}

.timeframe-btn {
    padding: 0.35rem 0.6rem;
    border-radius: 6px;
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 0.75rem;
    font-family: 'JetBrains Mono', monospace;
    transition: all 0.2s;
}

.timeframe-btn:hover {
    border-color: var(--accent-blue);
    color: var(--text-primary);
}

.timeframe-btn.active {
    background: var(--accent-blue);
    border-color: var(--accent-blue);
    color: var(--bg-dark);
}

#chartContainer {
    width: 100%;
    height: 450px;
    position: relative;
}

#rsiChartContainer {
    width: 100%;
    height: 120px;
    position: relative;
    margin-top: 0.5rem;
    border-top: 1px solid var(--border-color);
    padding-top: 0.5rem;
}

.rsi-label {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    font-size: 0.7rem;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
    z-index: 10;
    background: rgba(13, 17, 23, 0.8);
    padding: 0.15rem 0.35rem;
    border-radius: 4px;
}

.chart-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 450px;
    color: var(--text-muted);
}

.chart-legend {
    display: flex;
    gap: 1rem;
    margin-top: 0.75rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border-color);
    font-size: 0.75rem;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    color: var(--text-secondary);
}

.legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 2px;
}

.legend-dot.bullish { background: var(--accent-green); }
.legend-dot.bearish { background: var(--accent-red); }

.chart-stats {
    display: flex;
    gap: 1.5rem;
    margin-top: 0.5rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
}

.chart-stat {
    color: var(--text-secondary);
}

.chart-stat span {
    color: var(--text-primary);
    margin-left: 0.25rem;
}

/* Loading States */
.loading {
    text-align: center;
    padding: 4rem;
    color: var(--text-secondary);
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-color);
    border-top-color: var(--accent-green);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.error-message {
    text-align: center;
    padding: 4rem;
    color: var(--accent-red);
}

.back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-secondary);
    text-decoration: none;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    transition: color 0.2s;
}

.back-link:hover {
    color: var(--accent-blue);
}

.updated-at {
    text-align: center;
    margin-top: 1.5rem;
    color: var(--text-muted);
    font-size: 0.8rem;
}

/* Notes Section */
.notes-section {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
}

.notes-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color);
}

.notes-header h2 {
    font-size: 0.9rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.notes-header h2 .notes-icon {
    font-size: 1.1rem;
}

.notes-actions {
    display: flex;
    gap: 0.5rem;
}

.notes-btn {
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 0.75rem;
    font-family: 'JetBrains Mono', monospace;
    transition: all 0.2s;
}

.notes-btn:hover {
    border-color: var(--accent-blue);
    color: var(--text-primary);
}

.notes-btn.primary {
    background: var(--accent-blue);
    border-color: var(--accent-blue);
    color: var(--bg-dark);
}

.notes-btn.primary:hover {
    background: var(--accent-green);
    border-color: var(--accent-green);
}

.notes-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.notes-content {
    min-height: 100px;
}

.notes-display {
    font-size: 0.9rem;
    line-height: 1.6;
    color: var(--text-primary);
    white-space: pre-wrap;
    word-wrap: break-word;
}

.notes-display.empty {
    color: var(--text-muted);
    font-style: italic;
}

.notes-textarea {
    width: 100%;
    min-height: 200px;
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--bg-dark);
    color: var(--text-primary);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    font-size: 0.9rem;
    line-height: 1.6;
    resize: vertical;
    transition: border-color 0.2s;
}

.notes-textarea:focus {
    outline: none;
    border-color: var(--accent-blue);
}

.notes-textarea::placeholder {
    color: var(--text-muted);
}

.notes-meta {
    margin-top: 0.5rem;
    font-size: 0.7rem;
    color: var(--text-muted);
    text-align: right;
}

.notes-save-status {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    margin-left: 0.5rem;
}

.notes-save-status.saving {
    color: var(--accent-yellow);
}

.notes-save-status.saved {
    color: var(--accent-green);
}

.notes-save-status.error {
    color: var(--accent-red);
}

/* Preference Controls */
.preference-controls {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
}

.pref-btn {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 0.9rem;
    border-radius: 8px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 0.85rem;
    font-family: 'JetBrains Mono', monospace;
    transition: all 0.2s;
}

.pref-btn:hover {
    border-color: var(--accent-purple);
    color: var(--text-primary);
    background: var(--bg-card-hover);
}

.pref-btn.active.favorite {
    background: rgba(255, 215, 0, 0.15);
    border-color: #ffd700;
    color: #ffd700;
}

.pref-btn.active.dislike {
    background: rgba(248, 81, 73, 0.15);
    border-color: var(--accent-red);
    color: var(--accent-red);
}

.pref-btn .icon {
    font-size: 1rem;
}

.pref-status {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.pref-status.saving {
    color: var(--accent-yellow);
}

.pref-status.saved {
    color: var(--accent-green);
}
{% endblock %}

{% block content %}
<a href="/" class="back-link">‚Üê Back to Home</a>

<div id="loading" class="loading">
    <div class="loading-spinner"></div>
    <p>Loading stock data...</p>
</div>

<div id="error" class="error-message" style="display: none;">
    <p>Stock not found or error loading data.</p>
    <a href="/" class="btn btn-secondary" style="margin-top: 1rem;">Go Back</a>
</div>

<div id="stock-content" style="display: none;">
    <!-- Header -->
    <div class="stock-header">
        <div class="ticker-info">
            <h1 id="ticker">{{ ticker }}</h1>
            <div class="company-name" id="companyName">Loading...</div>
            <div class="header-tags">
                <span class="tag" id="sector">--</span>
                <span class="tag" id="industry">--</span>
            </div>
            <div class="preference-controls">
                <button class="pref-btn favorite" id="favBtn" onclick="togglePreference('favorite')">
                    <span class="icon">‚≠ê</span> Favorite
                </button>
                <button class="pref-btn dislike" id="dislikeBtn" onclick="togglePreference('dislike')">
                    <span class="icon">üëé</span> Dislike
                </button>
            </div>
            <div class="pref-status" id="prefStatus"></div>
        </div>
        <div class="price-display">
            <div class="current-price" id="currentPrice">--</div>
            <div class="price-subtext" id="range52Week">52W: --</div>
        </div>
    </div>

    <!-- Main View Style Metrics -->
    <div class="data-sections" id="dataSections">
        <!-- Row 1: Price, Technical, Returns -->
        <div class="section-group full-row">
            <!-- Price & Market Section -->
            <div class="data-section price-section">
                <div class="section-header">Price & Market</div>
                <div class="section-row">
                    <div class="data-cell">
                        <span class="data-label">Price</span>
                        <span class="data-value lg" id="priceValue">--</span>
                    </div>
                    <div class="data-cell">
                        <span class="data-label">MktCap</span>
                        <span class="data-value" id="marketCap">--</span>
                    </div>
                    <div class="data-cell">
                        <span class="data-label">Volume</span>
                        <span class="data-value sm" id="volume">--</span>
                    </div>
                    <div class="data-cell">
                        <span class="data-label">$Vol</span>
                        <span class="data-value sm" id="dollarVolume">--</span>
                    </div>
                </div>
            </div>
            
            <!-- Technical Section -->
            <div class="data-section technical-section">
                <div class="section-header">Technical</div>
                <div class="section-row">
                    <div class="data-cell">
                        <span class="data-label">RSI</span>
                        <div class="rsi-cell">
                            <span class="data-value" id="rsiMktcap">--</span>
                            <div class="rsi-bar-container"><div class="rsi-bar mid" id="rsiBar" style="width:0%"></div></div>
                        </div>
                    </div>
                    <div class="data-cell">
                        <span class="data-label">ATR%</span>
                        <span class="data-value" id="atr20">--</span>
                    </div>
                    <div class="data-cell">
                        <span class="data-label">Vol/Avg</span>
                        <span class="data-value" id="volVs10dAvg">--</span>
                    </div>
                </div>
            </div>
            
            <!-- Returns Section -->
            <div class="data-section returns-section">
                <div class="section-header">Returns</div>
                <div class="returns-inline">
                    <div class="return-item"><span class="data-label">1D</span><span class="data-value" id="dr1">--</span></div>
                    <div class="return-item"><span class="data-label">5D</span><span class="data-value" id="dr5">--</span></div>
                    <div class="return-item"><span class="data-label">20D</span><span class="data-value" id="dr20">--</span></div>
                    <div class="return-item"><span class="data-label">60D</span><span class="data-value" id="dr60">--</span></div>
                    <div class="return-item"><span class="data-label">120D</span><span class="data-value" id="dr120">--</span></div>
                </div>
            </div>
        </div>
        
        <!-- Row 2: Valuation, Revenue Growth, EPS Growth -->
        <div class="section-group full-row">
            <!-- Valuation Section -->
            <div class="data-section valuation-section">
                <div class="section-header">Valuation</div>
                <div class="section-row">
                    <div class="val-pair">
                        <div class="val-item">
                            <span class="data-label">P/E</span>
                            <span class="data-value" id="pe">--</span>
                        </div>
                        <div class="val-item forward">
                            <span class="data-label">Fwd</span>
                            <span class="data-value" id="fpe">--</span>
                        </div>
                    </div>
                    <div class="val-pair">
                        <div class="val-item">
                            <span class="data-label">P/S</span>
                            <span class="data-value" id="psTtm">--</span>
                        </div>
                        <div class="val-item forward">
                            <span class="data-label">Fwd</span>
                            <span class="data-value" id="fps">--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Revenue Growth Section -->
            <div class="data-section growth-section">
                <div class="section-header">Revenue Growth</div>
                <div class="growth-timeline">
                    <div class="growth-item past"><span class="data-label">T-1</span><span class="data-value" id="revGrowthTMinus1">--</span></div>
                    <div class="growth-item current"><span class="data-label">T</span><span class="data-value" id="revGrowthT">--</span></div>
                    <div class="growth-item future"><span class="data-label">T+1</span><span class="data-value" id="revGrowthTPlus1">--</span></div>
                    <div class="growth-item future"><span class="data-label">T+2</span><span class="data-value" id="revGrowthTPlus2">--</span></div>
                    <div class="growth-avg"><div class="data-cell"><span class="data-label">Avg</span><span class="data-value" id="avgRevGrowth">--</span></div></div>
                </div>
            </div>
            
            <!-- EPS Growth Section -->
            <div class="data-section growth-section">
                <div class="section-header">EPS Growth</div>
                <div class="growth-timeline">
                    <div class="growth-item past"><span class="data-label">T-1</span><span class="data-value" id="epsGrowthTMinus1">--</span></div>
                    <div class="growth-item current"><span class="data-label">T</span><span class="data-value" id="epsGrowthT">--</span></div>
                    <div class="growth-item future"><span class="data-label">T+1</span><span class="data-value" id="epsGrowthTPlus1">--</span></div>
                    <div class="growth-item future"><span class="data-label">T+2</span><span class="data-value" id="epsGrowthTPlus2">--</span></div>
                    <div class="growth-avg"><div class="data-cell"><span class="data-label">Avg</span><span class="data-value" id="avgEpsGrowth">--</span></div></div>
                </div>
            </div>
        </div>
        
        <!-- Row 3: Short Interest, Info -->
        <div class="section-group full-row">
            <!-- Short Interest Section -->
            <div class="data-section short-section">
                <div class="section-header">Short Interest</div>
                <div class="section-row">
                    <div class="data-cell">
                        <span class="data-label">Float%</span>
                        <div class="short-bar">
                            <span class="data-value" id="shortFloat">--</span>
                            <div class="short-bar-container"><div class="short-bar-fill" id="shortBarFill" style="width:0%"></div></div>
                        </div>
                    </div>
                    <div class="data-cell">
                        <span class="data-label">Ratio</span>
                        <span class="data-value" id="shortRatio">--</span>
                    </div>
                    <div class="data-cell">
                        <span class="data-label">Interest</span>
                        <span class="data-value sm" id="shortInterest">--</span>
                    </div>
                    <div class="data-cell">
                        <span class="data-label">LowFloat</span>
                        <span class="data-value" id="lowFloat">--</span>
                    </div>
                </div>
            </div>
            
            <!-- Info Section -->
            <div class="data-section info-section">
                <div class="section-header">Info</div>
                <div class="section-row">
                    <div class="data-cell">
                        <span class="data-label">Industry</span>
                        <span class="data-value muted sm" id="industryInfo">--</span>
                    </div>
                    <div class="data-cell">
                        <span class="data-label">Country</span>
                        <span class="data-value muted sm" id="countryInfo">--</span>
                    </div>
                    <div class="data-cell">
                        <span class="data-label">IPO</span>
                        <span class="data-value muted" id="ipoYear">--</span>
                    </div>
                    <div class="data-cell">
                        <span class="data-label">52W</span>
                        <span class="data-value muted sm" id="range52Info">--</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Events Section (Volume Spikes & Gappers) -->
        <div class="section-group full-row" id="eventsSection" style="display: none;">
            <div class="data-section events-section">
                <div class="section-header">Volume Events</div>
                <div class="section-row" id="eventsContent">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Candlestick Chart -->
    <div class="chart-section">
        <div class="chart-header">
            <h2>Price Chart</h2>
            <div class="chart-timeframe">
                <button class="timeframe-btn" data-days="30">1M</button>
                <button class="timeframe-btn" data-days="90">3M</button>
                <button class="timeframe-btn" data-days="180">6M</button>
                <button class="timeframe-btn active" data-days="365">1Y</button>
            </div>
        </div>
        <div id="chartLoading" class="chart-loading">
            <div class="loading-spinner"></div>
            <span>Loading chart...</span>
        </div>
        <div id="chartContainer"></div>
        <div id="rsiChartContainer">
            <div class="rsi-label">RSI MktCap (1-100)</div>
        </div>
        <div class="chart-legend">
            <div class="legend-item">
                <div class="legend-dot bullish"></div>
                <span>Bullish</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot bearish"></div>
                <span>Bearish</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #00ff00;"></div>
                <span>50 DMA</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #ff0000;"></div>
                <span>200 DMA</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #00bcd4;"></div>
                <span>RSI MktCap</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #f5f5dc;"></div>
                <span>EPS (A=Actual, E=Est)</span>
            </div>
        </div>
        <div class="chart-stats" id="chartStats"></div>
    </div>

    <!-- Notes Section -->
    <div class="notes-section">
        <div class="notes-header">
            <h2><span class="notes-icon">üìù</span> Notes</h2>
            <div class="notes-actions">
                <button class="notes-btn" id="editNotesBtn" onclick="toggleEditMode()">Edit</button>
                <button class="notes-btn primary" id="saveNotesBtn" onclick="saveNotes()" style="display: none;">Save</button>
                <button class="notes-btn" id="cancelNotesBtn" onclick="cancelEdit()" style="display: none;">Cancel</button>
                <span class="notes-save-status" id="saveStatus"></span>
            </div>
        </div>
        <div class="notes-content">
            <div class="notes-display" id="notesDisplay">Loading notes...</div>
            <textarea class="notes-textarea" id="notesTextarea" style="display: none;" placeholder="Add your notes here... You can write multiple paragraphs of analysis, thesis, key metrics to watch, etc."></textarea>
        </div>
        <div class="notes-meta" id="notesMeta"></div>
    </div>

    <div class="updated-at" id="updatedAt"></div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Lightweight Charts by TradingView -->
<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
<script>
const ticker = '{{ ticker }}';
let chart = null;
let rsiChart = null;
let candlestickSeries = null;
let volumeSeries = null;
let dma50Series = null;
let dma200Series = null;
let rsiSeries = null;
let allOhlcData = [];
let allEarningsData = [];
let currentTimeframe = 365;

function formatNumber(num, decimals = 2) {
    if (num == null) return '--';
    return Number(num).toFixed(decimals);
}

function formatLargeNumber(num) {
    if (num == null) return '--';
    if (num >= 1e12) return '$' + (num / 1e12).toFixed(1) + 'T';
    if (num >= 1e9) return '$' + (num / 1e9).toFixed(1) + 'B';
    if (num >= 1e6) return '$' + (num / 1e6).toFixed(1) + 'M';
    if (num >= 1e3) return '$' + (num / 1e3).toFixed(1) + 'K';
    return '$' + num.toLocaleString();
}

function formatVolume(num) {
    if (num == null) return '--';
    if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
    if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
    if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
    return num.toLocaleString();
}

function formatReturn(value) {
    if (value == null) return { text: '--', className: '' };
    const formatted = (value >= 0 ? '+' : '') + formatNumber(value, 1) + '%';
    const className = value >= 0 ? 'value-positive' : 'value-negative';
    return { text: formatted, className };
}

function setReturnValue(elementId, value) {
    const el = document.getElementById(elementId);
    const { text, className } = formatReturn(value);
    el.textContent = text;
    el.classList.remove('value-positive', 'value-negative', 'positive', 'negative', 'muted');
    if (value == null) {
        el.classList.add('muted');
    } else if (value >= 0) {
        el.classList.add('positive');
    } else {
        el.classList.add('negative');
    }
}

function setGrowthValue(elementId, value, isHighlight = false) {
    const el = document.getElementById(elementId);
    if (value == null) {
        el.textContent = '--';
        el.className = 'data-value muted';
    } else {
        const sign = value >= 0 ? '+' : '';
        el.textContent = sign + formatNumber(value, 0) + '%';
        let className = 'data-value ';
        if (value >= 0) {
            className += 'positive';
        } else {
            className += 'negative';
        }
        if (isHighlight && value > 25) {
            className += ' highlight';
        }
        el.className = className;
    }
}

function getRsiClass(rsi) {
    if (rsi == null) return '';
    if (rsi >= 70) return 'positive';
    if (rsi >= 30) return '';
    return 'negative';
}

function getRsiBarClass(rsi) {
    if (rsi == null) return 'mid';
    if (rsi >= 70) return 'high';
    if (rsi >= 30) return 'mid';
    return 'low';
}

function formatDatePills(dates, type) {
    if (!dates || dates.length === 0) return '';
    const sliced = dates.slice(0, 3);
    let html = sliced.map(d => `<span class="date-pill ${type}">${formatShortDate(d)}</span>`).join('');
    if (dates.length > 3) {
        html += `<span class="date-pill ${type}">+${dates.length - 3}</span>`;
    }
    return html;
}

function formatShortDate(dateStr) {
    if (!dateStr) return '';
    const parts = dateStr.split('-');
    if (parts.length === 3) {
        return parts[1] + '/' + parts[2];
    }
    return dateStr;
}

async function loadStockData() {
    try {
        const response = await fetch(`/api/frontend/stock/${ticker}`);
        const data = await response.json();
        
        if (data.error) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            return;
        }
        
        // Header
        document.getElementById('ticker').textContent = data.ticker;
        document.getElementById('companyName').textContent = data.company_name || 'Unknown Company';
        document.getElementById('sector').textContent = data.sector || '--';
        document.getElementById('industry').textContent = data.industry || '--';
        
        // Price in header
        if (data.current_price != null) {
            document.getElementById('currentPrice').textContent = '$' + formatNumber(data.current_price, 2);
            document.getElementById('currentPrice').classList.add('price-positive');
        }
        document.getElementById('range52Week').textContent = '52W: ' + (data.range_52_week || '--');
        
        // === Price & Market Section ===
        document.getElementById('priceValue').textContent = data.current_price ? '$' + formatNumber(data.current_price, 2) : '--';
        document.getElementById('marketCap').textContent = formatLargeNumber(data.market_cap);
        document.getElementById('volume').textContent = formatVolume(data.volume);
        document.getElementById('dollarVolume').textContent = data.dollar_volume ? formatLargeNumber(data.dollar_volume) : '--';
        
        // === Technical Section ===
        const rsiValue = data.rsi_mktcap;
        document.getElementById('rsiMktcap').textContent = rsiValue != null ? rsiValue : '--';
        if (rsiValue != null) {
            document.getElementById('rsiMktcap').className = 'data-value ' + getRsiClass(rsiValue);
            const rsiBar = document.getElementById('rsiBar');
            rsiBar.style.width = rsiValue + '%';
            rsiBar.className = 'rsi-bar ' + getRsiBarClass(rsiValue);
        }
        
        const atr = data.atr20;
        const atrEl = document.getElementById('atr20');
        atrEl.textContent = atr != null ? formatNumber(atr, 1) + '%' : '--';
        if (atr > 5) atrEl.classList.add('warn');
        
        const volVsAvg = data.vol_vs_10d_avg;
        const volVsEl = document.getElementById('volVs10dAvg');
        volVsEl.textContent = volVsAvg != null ? formatNumber(volVsAvg, 1) + 'x' : '--';
        if (volVsAvg > 1.5) volVsEl.classList.add('highlight');
        
        // === Returns Section ===
        setReturnValue('dr1', data.dr_1);
        setReturnValue('dr5', data.dr_5);
        setReturnValue('dr20', data.dr_20);
        setReturnValue('dr60', data.dr_60);
        setReturnValue('dr120', data.dr_120);
        
        // === Valuation Section ===
        document.getElementById('pe').textContent = data.pe != null ? formatNumber(data.pe, 0) : '--';
        document.getElementById('fpe').textContent = data.fpe != null ? formatNumber(data.fpe, 0) : '--';
        document.getElementById('psTtm').textContent = data.ps_ttm != null ? formatNumber(data.ps_ttm, 1) : '--';
        document.getElementById('fps').textContent = data.fps != null ? formatNumber(data.fps, 1) : '--';
        
        // === Revenue Growth Section ===
        setGrowthValue('revGrowthTMinus1', data.rev_growth_t_minus_1);
        setGrowthValue('revGrowthT', data.rev_growth_t);
        setGrowthValue('revGrowthTPlus1', data.rev_growth_t_plus_1);
        setGrowthValue('revGrowthTPlus2', data.rev_growth_t_plus_2);
        setGrowthValue('avgRevGrowth', data.avg_rev_growth, true);
        
        // === EPS Growth Section ===
        setGrowthValue('epsGrowthTMinus1', data.eps_growth_t_minus_1);
        setGrowthValue('epsGrowthT', data.eps_growth_t);
        setGrowthValue('epsGrowthTPlus1', data.eps_growth_t_plus_1);
        setGrowthValue('epsGrowthTPlus2', data.eps_growth_t_plus_2);
        setGrowthValue('avgEpsGrowth', data.avg_eps_growth);
        
        // === Short Interest Section ===
        const shortFloat = data.short_float;
        const shortFloatEl = document.getElementById('shortFloat');
        shortFloatEl.textContent = shortFloat != null ? formatNumber(shortFloat, 1) + '%' : '--';
        if (shortFloat > 20) shortFloatEl.classList.add('highlight');
        if (shortFloat != null) {
            document.getElementById('shortBarFill').style.width = Math.min(shortFloat * 2, 100) + '%';
        }
        
        document.getElementById('shortRatio').textContent = data.short_ratio != null ? formatNumber(data.short_ratio, 1) : '--';
        document.getElementById('shortInterest').textContent = data.short_interest != null ? formatLargeNumber(data.short_interest) : '--';
        
        const lowFloatEl = document.getElementById('lowFloat');
        lowFloatEl.textContent = data.low_float ? '‚úì' : '--';
        lowFloatEl.className = 'data-value ' + (data.low_float ? 'highlight' : 'muted');
        
        // === Info Section ===
        document.getElementById('industryInfo').textContent = data.industry || '--';
        document.getElementById('countryInfo').textContent = data.country || '--';
        document.getElementById('ipoYear').textContent = data.ipo_date ? data.ipo_date.slice(0, 4) : '--';
        document.getElementById('range52Info').textContent = data.range_52_week || '--';
        
        // === Volume Events Section ===
        const spikeCount = data.spike_day_count || 0;
        const gapperCount = data.gapper_day_count || 0;
        
        if (spikeCount > 0 || gapperCount > 0) {
            document.getElementById('eventsSection').style.display = 'flex';
            let eventsHtml = '';
            
            // Last Event
            if (data.last_event_date) {
                const eventType = data.last_event_type === 'volume_spike' ? 'spike' : 'gap';
                const eventLabel = data.last_event_type === 'volume_spike' ? 'Spike' : 'Gap';
                eventsHtml += `
                    <div class="data-cell">
                        <span class="data-label">Last Event</span>
                        <span class="event-badge ${eventType}">${eventLabel} ${data.last_event_date.slice(5)}</span>
                    </div>
                `;
            }
            
            // Volume Spikes
            if (spikeCount > 0) {
                const avgSpike = data.avg_volume_spike ? formatNumber(data.avg_volume_spike, 1) + 'x' : '--';
                eventsHtml += `
                    <div class="data-cell">
                        <span class="data-label">Spikes</span>
                        <span class="data-value highlight">${spikeCount} <span class="muted sm">(${avgSpike} avg)</span></span>
                    </div>
                `;
                
                if (data.volume_spike_days && data.volume_spike_days.length > 0) {
                    eventsHtml += `
                        <div class="data-cell">
                            <span class="data-label">Spike Dates</span>
                            <div class="date-pills">${formatDatePills(data.volume_spike_days, 'spike')}</div>
                        </div>
                    `;
                }
            }
            
            // Gappers
            if (gapperCount > 0) {
                const avgReturn = data.avg_return_gapper ? formatNumber(data.avg_return_gapper * 100, 1) + '%' : '--';
                const returnClass = data.avg_return_gapper >= 0 ? 'positive' : 'negative';
                eventsHtml += `
                    <div class="data-cell">
                        <span class="data-label">Gaps</span>
                        <span class="data-value highlight">${gapperCount} <span class="${returnClass} sm">(${avgReturn} avg)</span></span>
                    </div>
                `;
                
                if (data.gap_days && data.gap_days.length > 0) {
                    eventsHtml += `
                        <div class="data-cell">
                            <span class="data-label">Gap Dates</span>
                            <div class="date-pills">${formatDatePills(data.gap_days, 'gap')}</div>
                        </div>
                    `;
                }
            }
            
            document.getElementById('eventsContent').innerHTML = eventsHtml;
        }
        
        // Updated at
        if (data.updated_at) {
            document.getElementById('updatedAt').textContent = 'Last updated: ' + data.updated_at;
        }
        
        // Show content
        document.getElementById('loading').style.display = 'none';
        document.getElementById('stock-content').style.display = 'block';
        
        // Load chart
        loadChartData();
        
    } catch (error) {
        console.error('Error loading stock data:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
    }
}

// ============================================
// Chart Functions
// ============================================

async function loadChartData() {
    try {
        const [ohlcResponse, earningsResponse] = await Promise.all([
            fetch(`/api/frontend/ohlc/${ticker}`),
            fetch(`/api/frontend/earnings-eps/${ticker}`)
        ]);
        
        const data = await ohlcResponse.json();
        const earningsData = await earningsResponse.json();
        
        if (data.error || !Array.isArray(data) || data.length === 0) {
            document.getElementById('chartLoading').innerHTML = '<span style="color: var(--text-muted);">No chart data available</span>';
            return;
        }
        
        allOhlcData = data;
        allEarningsData = Array.isArray(earningsData) ? earningsData : [];
        
        initChart();
        updateChart(currentTimeframe);
        setupTimeframeButtons();
        
        if (data.length > 0) {
            const latestData = data[data.length - 1];
            if (latestData.close != null) {
                const priceElement = document.getElementById('currentPrice');
                priceElement.textContent = '$' + formatNumber(latestData.close, 2);
            }
        }
        
    } catch (error) {
        console.error('Error loading chart data:', error);
        document.getElementById('chartLoading').innerHTML = '<span style="color: var(--text-muted);">Failed to load chart</span>';
    }
}

function initChart() {
    document.getElementById('chartLoading').style.display = 'none';
    
    const container = document.getElementById('chartContainer');
    const rsiContainer = document.getElementById('rsiChartContainer');
    
    chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: 450,
        layout: {
            background: { type: 'solid', color: 'transparent' },
            textColor: '#8b949e',
            fontFamily: "'JetBrains Mono', monospace",
        },
        grid: {
            vertLines: { color: 'rgba(48, 54, 61, 0.3)' },
            horzLines: { color: 'rgba(48, 54, 61, 0.3)' },
        },
        crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
            vertLine: {
                width: 1,
                color: 'rgba(88, 166, 255, 0.5)',
                style: LightweightCharts.LineStyle.Dashed,
            },
            horzLine: {
                width: 1,
                color: 'rgba(88, 166, 255, 0.5)',
                style: LightweightCharts.LineStyle.Dashed,
            },
        },
        rightPriceScale: {
            borderColor: '#30363d',
            scaleMargins: {
                top: 0.05,
                bottom: 0.15,
            },
        },
        timeScale: {
            borderColor: '#30363d',
            timeVisible: true,
            secondsVisible: false,
        },
        handleScroll: false,
        handleScale: false,
    });
    
    candlestickSeries = chart.addCandlestickSeries({
        upColor: '#3fb950',
        downColor: '#f85149',
        borderDownColor: '#f85149',
        borderUpColor: '#3fb950',
        wickDownColor: '#f85149',
        wickUpColor: '#3fb950',
    });
    
    dma50Series = chart.addLineSeries({
        color: '#00ff00',
        lineWidth: 2,
        lineStyle: LightweightCharts.LineStyle.Solid,
        priceLineVisible: false,
        lastValueVisible: false,
        crosshairMarkerVisible: false,
    });

    dma200Series = chart.addLineSeries({
        color: '#ff0000',
        lineWidth: 2,
        lineStyle: LightweightCharts.LineStyle.Solid,
        priceLineVisible: false,
        lastValueVisible: false,
        crosshairMarkerVisible: false,
    });
    
    volumeSeries = chart.addHistogramSeries({
        color: '#26a69a',
        priceFormat: {
            type: 'volume',
        },
        priceScaleId: '',
        scaleMargins: {
            top: 0.88,
            bottom: 0,
        },
    });
    
    rsiChart = LightweightCharts.createChart(rsiContainer, {
        width: rsiContainer.clientWidth,
        height: 120,
        layout: {
            background: { type: 'solid', color: 'transparent' },
            textColor: '#8b949e',
            fontFamily: "'JetBrains Mono', monospace",
        },
        grid: {
            vertLines: { color: 'rgba(48, 54, 61, 0.3)' },
            horzLines: { color: 'rgba(48, 54, 61, 0.3)' },
        },
        crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
            vertLine: {
                width: 1,
                color: 'rgba(88, 166, 255, 0.5)',
                style: LightweightCharts.LineStyle.Dashed,
            },
            horzLine: {
                width: 1,
                color: 'rgba(88, 166, 255, 0.5)',
                style: LightweightCharts.LineStyle.Dashed,
            },
        },
        rightPriceScale: {
            borderColor: '#30363d',
            scaleMargins: {
                top: 0.1,
                bottom: 0.1,
            },
            autoScale: true,
            minValue: 0,
            maxValue: 100,
        },
        timeScale: {
            borderColor: '#30363d',
            timeVisible: true,
            secondsVisible: false,
            visible: false,
        },
        handleScroll: false,
        handleScale: false,
    });
    
    rsiSeries = rsiChart.addAreaSeries({
        lineColor: '#00bcd4',
        topColor: 'rgba(0, 188, 212, 0.4)',
        bottomColor: 'rgba(0, 188, 212, 0.05)',
        lineWidth: 2,
        priceLineVisible: false,
        lastValueVisible: true,
        crosshairMarkerVisible: true,
    });
    
    window.addEventListener('resize', () => {
        if (chart) {
            chart.applyOptions({ width: container.clientWidth });
        }
        if (rsiChart) {
            rsiChart.applyOptions({ width: rsiContainer.clientWidth });
        }
    });
    
    chart.subscribeCrosshairMove(param => {
        if (param.time && rsiChart) {
            rsiChart.setCrosshairPosition(param.point?.y || 0, param.time, rsiSeries);
        }
    });
    
    rsiChart.subscribeCrosshairMove(param => {
        if (param.time && chart) {
            chart.setCrosshairPosition(param.point?.y || 0, param.time, candlestickSeries);
        }
    });
}

function updateChart(days) {
    if (!allOhlcData.length) return;
    
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - days);
    const cutoffStr = cutoffDate.toISOString().split('T')[0];
    
    const filteredData = allOhlcData.filter(d => d.time >= cutoffStr);
    
    if (filteredData.length === 0) {
        setChartData(allOhlcData);
    } else {
        setChartData(filteredData);
    }
    
    chart.timeScale().fitContent();
    if (rsiChart) {
        rsiChart.timeScale().fitContent();
    }
    updateChartStats(filteredData.length > 0 ? filteredData : allOhlcData);
}

function setChartData(data) {
    const candleData = data.map(d => ({
        time: d.time,
        open: d.open,
        high: d.high,
        low: d.low,
        close: d.close,
    }));
    candlestickSeries.setData(candleData);
    
    const dma50Data = data
        .filter(d => d.dma_50 != null)
        .map(d => ({
            time: d.time,
            value: d.dma_50,
        }));
    dma50Series.setData(dma50Data);
    
    const dma200Data = data
        .filter(d => d.dma_200 != null)
        .map(d => ({
            time: d.time,
            value: d.dma_200,
        }));
    dma200Series.setData(dma200Data);
    
    const volumeData = data.map(d => ({
        time: d.time,
        value: d.volume,
        color: d.close >= d.open ? 'rgba(63, 185, 80, 0.3)' : 'rgba(248, 81, 73, 0.3)',
    }));
    volumeSeries.setData(volumeData);
    
    const rsiData = data
        .filter(d => d.rsi_mktcap != null)
        .map(d => ({
            time: d.time,
            value: d.rsi_mktcap,
        }));
    rsiSeries.setData(rsiData);
    
    const dataTimeSet = new Set(data.map(d => d.time));
    const filteredEarnings = allEarningsData.filter(e => dataTimeSet.has(e.time));
    
    if (filteredEarnings.length > 0) {
        const markers = filteredEarnings.map(earning => {
            const actualText = earning.eps_actual != null ? `A: $${earning.eps_actual}` : '';
            const estText = earning.eps_estimated != null ? `E: $${earning.eps_estimated}` : '';
            let labelText = '';
            if (actualText && estText) {
                labelText = `${actualText} | ${estText}`;
            } else {
                labelText = actualText || estText || 'EPS';
            }
            
            let color = '#f5f5dc';
            if (earning.eps_actual != null && earning.eps_estimated != null) {
                color = earning.eps_actual >= earning.eps_estimated ? '#90EE90' : '#FFB6C1';
            }
            
            return {
                time: earning.time,
                position: 'belowBar',
                color: color,
                shape: 'arrowUp',
                text: labelText,
            };
        });
        
        candlestickSeries.setMarkers(markers);
    } else {
        candlestickSeries.setMarkers([]);
    }
    
    if (rsiChart && chart) {
        rsiChart.timeScale().fitContent();
    }
}

function setupTimeframeButtons() {
    document.querySelectorAll('.timeframe-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentTimeframe = parseInt(this.dataset.days);
            updateChart(currentTimeframe);
        });
    });
}

function updateChartStats(data) {
    if (!data || data.length === 0) return;
    
    const firstPrice = data[0].close;
    const lastPrice = data[data.length - 1].close;
    const changePercent = ((lastPrice - firstPrice) / firstPrice * 100).toFixed(2);
    const highest = Math.max(...data.map(d => d.high));
    const lowest = Math.min(...data.map(d => d.low));
    
    const statsHtml = `
        <div class="chart-stat">Change: <span class="${changePercent >= 0 ? 'text-green' : 'text-red'}">${changePercent >= 0 ? '+' : ''}${changePercent}%</span></div>
        <div class="chart-stat">High: <span>$${highest.toFixed(2)}</span></div>
        <div class="chart-stat">Low: <span>$${lowest.toFixed(2)}</span></div>
        <div class="chart-stat">Range: <span>$${(highest - lowest).toFixed(2)}</span></div>
    `;
    document.getElementById('chartStats').innerHTML = statsHtml;
}

// ============================================
// Notes Functions
// ============================================

let currentNotes = '';
let isEditMode = false;

async function loadNotes() {
    try {
        const response = await fetch(`/api/frontend/stock-notes/${ticker}`);
        const data = await response.json();
        
        currentNotes = data.notes || '';
        updateNotesDisplay();
        
        if (data.updated_at) {
            const date = new Date(data.updated_at);
            document.getElementById('notesMeta').textContent = `Last updated: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        } else {
            document.getElementById('notesMeta').textContent = '';
        }
    } catch (error) {
        console.error('Error loading notes:', error);
        document.getElementById('notesDisplay').textContent = 'Error loading notes';
        document.getElementById('notesDisplay').classList.add('empty');
    }
}

function updateNotesDisplay() {
    const display = document.getElementById('notesDisplay');
    if (currentNotes && currentNotes.trim()) {
        display.textContent = currentNotes;
        display.classList.remove('empty');
    } else {
        display.textContent = 'No notes yet. Click Edit to add your analysis.';
        display.classList.add('empty');
    }
}

function toggleEditMode() {
    isEditMode = true;
    document.getElementById('notesDisplay').style.display = 'none';
    document.getElementById('notesTextarea').style.display = 'block';
    document.getElementById('notesTextarea').value = currentNotes;
    document.getElementById('notesTextarea').focus();
    
    document.getElementById('editNotesBtn').style.display = 'none';
    document.getElementById('saveNotesBtn').style.display = 'inline-block';
    document.getElementById('cancelNotesBtn').style.display = 'inline-block';
    document.getElementById('saveStatus').textContent = '';
}

function cancelEdit() {
    isEditMode = false;
    document.getElementById('notesDisplay').style.display = 'block';
    document.getElementById('notesTextarea').style.display = 'none';
    
    document.getElementById('editNotesBtn').style.display = 'inline-block';
    document.getElementById('saveNotesBtn').style.display = 'none';
    document.getElementById('cancelNotesBtn').style.display = 'none';
    document.getElementById('saveStatus').textContent = '';
}

async function saveNotes() {
    const newNotes = document.getElementById('notesTextarea').value;
    const saveStatus = document.getElementById('saveStatus');
    const saveBtn = document.getElementById('saveNotesBtn');
    
    saveStatus.textContent = 'Saving...';
    saveStatus.className = 'notes-save-status saving';
    saveBtn.disabled = true;
    
    try {
        const response = await fetch(`/api/frontend/stock-notes/${ticker}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ notes: newNotes }),
        });
        
        const data = await response.json();
        
        if (response.ok) {
            currentNotes = newNotes;
            updateNotesDisplay();
            cancelEdit();
            
            saveStatus.textContent = '‚úì Saved';
            saveStatus.className = 'notes-save-status saved';
            
            if (data.updated_at) {
                const date = new Date(data.updated_at);
                document.getElementById('notesMeta').textContent = `Last updated: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
            }
            
            setTimeout(() => {
                saveStatus.textContent = '';
            }, 3000);
        } else {
            throw new Error(data.error || 'Failed to save notes');
        }
    } catch (error) {
        console.error('Error saving notes:', error);
        saveStatus.textContent = '‚úï Error saving';
        saveStatus.className = 'notes-save-status error';
    } finally {
        saveBtn.disabled = false;
    }
}

// ============================================
// Preference Functions
// ============================================

let currentPreference = null;

async function loadPreference() {
    try {
        const response = await fetch(`/api/frontend/stock-preferences/${ticker}`);
        const data = await response.json();
        
        currentPreference = data.preference;
        updatePreferenceUI();
    } catch (error) {
        console.error('Error loading preference:', error);
    }
}

function updatePreferenceUI() {
    const favBtn = document.getElementById('favBtn');
    const dislikeBtn = document.getElementById('dislikeBtn');
    
    // Reset both buttons
    favBtn.classList.remove('active');
    dislikeBtn.classList.remove('active');
    
    // Apply active state based on preference
    if (currentPreference === 'favorite') {
        favBtn.classList.add('active');
    } else if (currentPreference === 'dislike') {
        dislikeBtn.classList.add('active');
    }
}

async function togglePreference(prefType) {
    const prefStatus = document.getElementById('prefStatus');
    
    // If clicking same preference, toggle off
    const newPref = currentPreference === prefType ? null : prefType;
    
    prefStatus.textContent = 'Saving...';
    prefStatus.className = 'pref-status saving';
    
    try {
        const response = await fetch(`/api/frontend/stock-preferences/${ticker}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ preference: newPref }),
        });
        
        if (response.ok) {
            currentPreference = newPref;
            updatePreferenceUI();
            
            const statusText = newPref === 'favorite' ? '‚úì Added to favorites' :
                               newPref === 'dislike' ? '‚úì Marked as dislike' :
                               '‚úì Preference cleared';
            prefStatus.textContent = statusText;
            prefStatus.className = 'pref-status saved';
            
            setTimeout(() => {
                prefStatus.textContent = '';
            }, 2000);
        } else {
            throw new Error('Failed to update preference');
        }
    } catch (error) {
        console.error('Error updating preference:', error);
        prefStatus.textContent = 'Error saving';
        prefStatus.className = 'pref-status';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadStockData();
    loadNotes();
    loadPreference();
});
</script>
{% endblock %}
