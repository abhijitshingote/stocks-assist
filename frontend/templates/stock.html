{% extends "base.html" %}

{% block title %}{{ ticker }} - Stock Metrics{% endblock %}

{% block extra_styles %}
.stock-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.ticker-info h1 {
    font-family: 'JetBrains Mono', monospace;
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--accent-green);
    margin-bottom: 0.25rem;
}

.company-name {
    font-size: 1.1rem;
    color: var(--text-secondary);
}

.header-tags {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
}

.tag {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    background: var(--bg-card-hover);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.price-display {
    text-align: right;
}

.current-price {
    font-family: 'JetBrains Mono', monospace;
    font-size: 2rem;
    font-weight: 700;
}

.price-positive { color: var(--accent-green); }
.price-negative { color: var(--accent-red); }

.price-subtext {
    font-size: 0.85rem;
    color: var(--text-muted);
}

/* Compact Metrics Grid */
.metrics-compact {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0.75rem;
    margin-bottom: 1.5rem;
}

.metrics-compact-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 0.5rem 0.75rem;
}

@media (max-width: 900px) {
    .metrics-compact-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 0.4rem 0.5rem;
    }
}

.metric-cell {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
    padding: 0.4rem 0.3rem;
    border-bottom: 1px solid rgba(48, 54, 61, 0.2);
    background: rgba(48, 54, 61, 0.05);
    border-radius: 4px;
}

.metric-cell:nth-last-child(-n+6) {
    border-bottom: none;
}

@media (max-width: 900px) {
    .metric-cell:nth-last-child(-n+3) {
        border-bottom: none;
    }
    .metric-cell:nth-last-child(n+4) {
        border-bottom: 1px solid rgba(48, 54, 61, 0.2);
    }
}

.metric-cell .label {
    font-size: 0.7rem;
    color: var(--text-muted);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.metric-cell .value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1.2;
}

.value-positive { color: var(--accent-green); }
.value-negative { color: var(--accent-red); }

/* Highlight Badges */
.highlight-section {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.highlight-badge {
    flex: 1;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1rem 1.25rem;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.highlight-badge.volspike {
    border-left: 4px solid #ff9800;
}

.highlight-badge.gapper {
    border-left: 4px solid #9c27b0;
}

.highlight-badge.inactive {
    opacity: 0.4;
    border-left-color: var(--border-color);
}

.highlight-icon {
    font-size: 1.8rem;
    margin-top: 0.1rem;
}

.highlight-content {
    flex: 1;
}

.highlight-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.highlight-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-primary);
}

.highlight-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
}

.highlight-badge.volspike .highlight-value {
    color: #ff9800;
}

.highlight-badge.gapper .highlight-value {
    color: #9c27b0;
}

.highlight-badge.inactive .highlight-value {
    color: var(--text-muted);
}

.highlight-stats {
    font-size: 0.75rem;
    color: var(--text-secondary);
    line-height: 1.4;
}

.highlight-stat {
    margin-bottom: 0.25rem;
}

.highlight-stat:last-child {
    margin-bottom: 0;
}

.highlight-dates {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-top: 0.5rem;
    font-family: 'JetBrains Mono', monospace;
}

/* Chart Section */
.chart-section {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color);
}

.chart-header h2 {
    font-size: 0.9rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin: 0;
}

.chart-timeframe {
    display: flex;
    gap: 0.4rem;
}

.timeframe-btn {
    padding: 0.35rem 0.6rem;
    border-radius: 6px;
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 0.75rem;
    font-family: 'JetBrains Mono', monospace;
    transition: all 0.2s;
}

.timeframe-btn:hover {
    border-color: var(--accent-blue);
    color: var(--text-primary);
}

.timeframe-btn.active {
    background: var(--accent-blue);
    border-color: var(--accent-blue);
    color: var(--bg-dark);
}

#chartContainer {
    width: 100%;
    height: 450px;
    position: relative;
}

#rsiChartContainer {
    width: 100%;
    height: 120px;
    position: relative;
    margin-top: 0.5rem;
    border-top: 1px solid var(--border-color);
    padding-top: 0.5rem;
}

.rsi-label {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    font-size: 0.7rem;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
    z-index: 10;
    background: rgba(13, 17, 23, 0.8);
    padding: 0.15rem 0.35rem;
    border-radius: 4px;
}

.chart-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 450px;
    color: var(--text-muted);
}

.chart-legend {
    display: flex;
    gap: 1rem;
    margin-top: 0.75rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border-color);
    font-size: 0.75rem;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    color: var(--text-secondary);
}

.legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 2px;
}

.legend-dot.bullish { background: var(--accent-green); }
.legend-dot.bearish { background: var(--accent-red); }

.chart-stats {
    display: flex;
    gap: 1.5rem;
    margin-top: 0.5rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
}

.chart-stat {
    color: var(--text-secondary);
}

.chart-stat span {
    color: var(--text-primary);
    margin-left: 0.25rem;
}

/* Loading States */
.loading {
    text-align: center;
    padding: 4rem;
    color: var(--text-secondary);
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--border-color);
    border-top-color: var(--accent-green);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.error-message {
    text-align: center;
    padding: 4rem;
    color: var(--accent-red);
}

.back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-secondary);
    text-decoration: none;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    transition: color 0.2s;
}

.back-link:hover {
    color: var(--accent-blue);
}

.updated-at {
    text-align: center;
    margin-top: 1.5rem;
    color: var(--text-muted);
    font-size: 0.8rem;
}

/* Notes Section */
.notes-section {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
}

.notes-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color);
}

.notes-header h2 {
    font-size: 0.9rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.notes-header h2 .notes-icon {
    font-size: 1.1rem;
}

.notes-actions {
    display: flex;
    gap: 0.5rem;
}

.notes-btn {
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 0.75rem;
    font-family: 'JetBrains Mono', monospace;
    transition: all 0.2s;
}

.notes-btn:hover {
    border-color: var(--accent-blue);
    color: var(--text-primary);
}

.notes-btn.primary {
    background: var(--accent-blue);
    border-color: var(--accent-blue);
    color: var(--bg-dark);
}

.notes-btn.primary:hover {
    background: var(--accent-green);
    border-color: var(--accent-green);
}

.notes-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.notes-content {
    min-height: 100px;
}

.notes-display {
    font-size: 0.9rem;
    line-height: 1.6;
    color: var(--text-primary);
    white-space: pre-wrap;
    word-wrap: break-word;
}

.notes-display.empty {
    color: var(--text-muted);
    font-style: italic;
}

.notes-textarea {
    width: 100%;
    min-height: 200px;
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--bg-dark);
    color: var(--text-primary);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    font-size: 0.9rem;
    line-height: 1.6;
    resize: vertical;
    transition: border-color 0.2s;
}

.notes-textarea:focus {
    outline: none;
    border-color: var(--accent-blue);
}

.notes-textarea::placeholder {
    color: var(--text-muted);
}

.notes-meta {
    margin-top: 0.5rem;
    font-size: 0.7rem;
    color: var(--text-muted);
    text-align: right;
}

.notes-save-status {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    margin-left: 0.5rem;
}

.notes-save-status.saving {
    color: var(--accent-yellow);
}

.notes-save-status.saved {
    color: var(--accent-green);
}

.notes-save-status.error {
    color: var(--accent-red);
}
{% endblock %}

{% block content %}
<a href="/" class="back-link">‚Üê Back to Home</a>

<div id="loading" class="loading">
    <div class="loading-spinner"></div>
    <p>Loading stock data...</p>
</div>

<div id="error" class="error-message" style="display: none;">
    <p>Stock not found or error loading data.</p>
    <a href="/" class="btn btn-secondary" style="margin-top: 1rem;">Go Back</a>
</div>

<div id="stock-content" style="display: none;">
    <!-- Header -->
    <div class="stock-header">
        <div class="ticker-info">
            <h1 id="ticker">{{ ticker }}</h1>
            <div class="company-name" id="companyName">Loading...</div>
            <div class="header-tags">
                <span class="tag" id="sector">--</span>
                <span class="tag" id="industry">--</span>
            </div>
        </div>
        <div class="price-display">
            <div class="current-price" id="currentPrice">--</div>
            <div class="price-subtext" id="range52Week">52W: --</div>
        </div>
    </div>

    <!-- Volspike & Gapper Highlights -->
    <div class="highlight-section">
        <div class="highlight-badge volspike" id="volspikeBadge">
            <div class="highlight-icon">‚ö°</div>
            <div class="highlight-content">
                <div class="highlight-header">
                    <div class="highlight-title">Volume Spikes</div>
                    <div class="highlight-value" id="spikeCount">0</div>
                </div>
                <div class="highlight-stats" id="volspikeStats">
                    <div class="highlight-stat">Avg volume: <span id="avgVolumeSpike">--</span>x</div>
                </div>
                <div class="highlight-dates" id="volspikeDates"></div>
            </div>
        </div>
        <div class="highlight-badge gapper" id="gapperBadge">
            <div class="highlight-icon">üöÄ</div>
            <div class="highlight-content">
                <div class="highlight-header">
                    <div class="highlight-title">Gap Days</div>
                    <div class="highlight-value" id="gapperCount">0</div>
                </div>
                <div class="highlight-stats" id="gapperStats">
                    <div class="highlight-stat">Avg return: <span id="avgReturnGapper">--</span>%</div>
                </div>
                <div class="highlight-dates" id="gapperDates"></div>
            </div>
        </div>
    </div>

    <!-- Compact Metrics Grid -->
    <div class="metrics-compact">
        <div class="metrics-compact-grid">
            <!-- Row 1 -->
            <div class="metric-cell">
                <span class="label">1D</span>
                <span class="value" id="dr1">--</span>
            </div>
            <div class="metric-cell">
                <span class="label">5D</span>
                <span class="value" id="dr5">--</span>
            </div>
            <div class="metric-cell">
                <span class="label">20D</span>
                <span class="value" id="dr20">--</span>
            </div>
            <div class="metric-cell">
                <span class="label">60D</span>
                <span class="value" id="dr60">--</span>
            </div>
            <div class="metric-cell">
                <span class="label">Mkt Cap</span>
                <span class="value" id="marketCap">--</span>
            </div>
            <div class="metric-cell">
                <span class="label">ATR 20%</span>
                <span class="value" id="atr20">--</span>
            </div>

            <!-- Row 2 - Valuation Ratios Together -->
            <div class="metric-cell">
                <span class="label">P/E</span>
                <span class="value" id="pe">--</span>
            </div>
            <div class="metric-cell">
                <span class="label">Fwd P/E</span>
                <span class="value" id="fpe">--</span>
            </div>
            <div class="metric-cell">
                <span class="label">P/S</span>
                <span class="value" id="psTtm">--</span>
            </div>
            <div class="metric-cell">
                <span class="label">Fwd P/S</span>
                <span class="value" id="fps">--</span>
            </div>
            <div class="metric-cell">
                <span class="label">RSI</span>
                <span class="value" id="rsi">--</span>
            </div>
            <div class="metric-cell">
                <span class="label">RSI Mkt</span>
                <span class="value" id="rsiMktcap">--</span>
            </div>

            <!-- Row 3 -->
            <div class="metric-cell">
                <span class="label">Short Float</span>
                <span class="value" id="shortFloat">--</span>
            </div>
            <div class="metric-cell">
                <span class="label">Short Ratio</span>
                <span class="value" id="shortRatio">--</span>
            </div>
            <div class="metric-cell">
                <span class="label">Vol vs Avg</span>
                <span class="value" id="volVs10dAvg">--</span>
            </div>
            <div class="metric-cell">
                <span class="label">Vol</span>
                <span class="value" id="volume">--</span>
            </div>
        </div>
    </div>

    <!-- Candlestick Chart -->
    <div class="chart-section">
        <div class="chart-header">
            <h2>Price Chart</h2>
            <div class="chart-timeframe">
                <button class="timeframe-btn" data-days="30">1M</button>
                <button class="timeframe-btn" data-days="90">3M</button>
                <button class="timeframe-btn" data-days="180">6M</button>
                <button class="timeframe-btn active" data-days="365">1Y</button>
            </div>
        </div>
        <div id="chartLoading" class="chart-loading">
            <div class="loading-spinner"></div>
            <span>Loading chart...</span>
        </div>
        <div id="chartContainer"></div>
        <div id="rsiChartContainer">
            <div class="rsi-label">RSI MktCap (1-100)</div>
        </div>
        <div class="chart-legend">
            <div class="legend-item">
                <div class="legend-dot bullish"></div>
                <span>Bullish</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot bearish"></div>
                <span>Bearish</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #00ff00;"></div>
                <span>50 DMA</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #ff0000;"></div>
                <span>200 DMA</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #00bcd4;"></div>
                <span>RSI MktCap</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #f5f5dc;"></div>
                <span>EPS (A=Actual, E=Est)</span>
            </div>
        </div>
        <div class="chart-stats" id="chartStats"></div>
    </div>

    <!-- Notes Section -->
    <div class="notes-section">
        <div class="notes-header">
            <h2><span class="notes-icon">üìù</span> Notes</h2>
            <div class="notes-actions">
                <button class="notes-btn" id="editNotesBtn" onclick="toggleEditMode()">Edit</button>
                <button class="notes-btn primary" id="saveNotesBtn" onclick="saveNotes()" style="display: none;">Save</button>
                <button class="notes-btn" id="cancelNotesBtn" onclick="cancelEdit()" style="display: none;">Cancel</button>
                <span class="notes-save-status" id="saveStatus"></span>
            </div>
        </div>
        <div class="notes-content">
            <div class="notes-display" id="notesDisplay">Loading notes...</div>
            <textarea class="notes-textarea" id="notesTextarea" style="display: none;" placeholder="Add your notes here... You can write multiple paragraphs of analysis, thesis, key metrics to watch, etc."></textarea>
        </div>
        <div class="notes-meta" id="notesMeta"></div>
    </div>

    <div class="updated-at" id="updatedAt"></div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Lightweight Charts by TradingView -->
<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
<script>
const ticker = '{{ ticker }}';
let chart = null;
let rsiChart = null;
let candlestickSeries = null;
let volumeSeries = null;
let dma50Series = null;
let dma200Series = null;
let rsiSeries = null;
let allOhlcData = [];
let allEarningsData = [];
let currentTimeframe = 365;

function formatNumber(num, decimals = 2) {
    if (num == null) return '--';
    return Number(num).toFixed(decimals);
}

function formatLargeNumber(num) {
    if (num == null) return '--';
    if (num >= 1e12) return '$' + (num / 1e12).toFixed(1) + 'T';
    if (num >= 1e9) return '$' + (num / 1e9).toFixed(1) + 'B';
    if (num >= 1e6) return '$' + (num / 1e6).toFixed(1) + 'M';
    if (num >= 1e3) return '$' + (num / 1e3).toFixed(1) + 'K';
    return '$' + num.toLocaleString();
}

function formatVolume(num) {
    if (num == null) return '--';
    if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
    if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
    if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
    return num.toLocaleString();
}

function formatReturn(value) {
    if (value == null) return { text: '--', className: '' };
    const formatted = (value >= 0 ? '+' : '') + formatNumber(value, 1) + '%';
    const className = value >= 0 ? 'value-positive' : 'value-negative';
    return { text: formatted, className };
}

function setReturnValue(elementId, value) {
    const el = document.getElementById(elementId);
    const { text, className } = formatReturn(value);
    el.textContent = text;
    el.classList.remove('value-positive', 'value-negative');
    if (className) el.classList.add(className);
}

async function loadStockData() {
    try {
        const response = await fetch(`/api/frontend/stock/${ticker}`);
        const data = await response.json();
        
        if (data.error) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            return;
        }
        
        // Header
        document.getElementById('ticker').textContent = data.ticker;
        document.getElementById('companyName').textContent = data.company_name || 'Unknown Company';
        document.getElementById('sector').textContent = data.sector || '--';
        document.getElementById('industry').textContent = data.industry || '--';
        
        // Price
        if (data.current_price != null) {
            document.getElementById('currentPrice').textContent = '$' + formatNumber(data.current_price, 2);
            document.getElementById('currentPrice').classList.add('price-positive');
        }
        document.getElementById('range52Week').textContent = '52W: ' + (data.range_52_week || '--');
        
        // Volspike & Gapper Highlights
        const spikeCount = data.spike_day_count || 0;
        const gapperCount = data.gapper_day_count || 0;

        document.getElementById('spikeCount').textContent = spikeCount;
        document.getElementById('gapperCount').textContent = gapperCount;

        // Volume spike stats
        if (data.avg_volume_spike != null) {
            document.getElementById('avgVolumeSpike').textContent = formatNumber(data.avg_volume_spike, 1);
        }

        // Gapper stats
        if (data.avg_return_gapper != null) {
            document.getElementById('avgReturnGapper').textContent = formatNumber(data.avg_return_gapper * 100, 1);
        }

        // Volume spike dates
        if (data.volume_spike_days && spikeCount > 0) {
            try {
                const dates = data.volume_spike_days.split(',');
                if (dates.length > 0) {
                    document.getElementById('volspikeDates').textContent = 'Dates: ' + dates.slice(0, 5).join(', ') + (dates.length > 5 ? '...' : '');
                }
            } catch (e) {
                console.warn('Error parsing volume spike dates:', e);
            }
        }

        // Gapper dates
        if (data.gap_days && gapperCount > 0) {
            try {
                const dates = data.gap_days.split(',');
                if (dates.length > 0) {
                    document.getElementById('gapperDates').textContent = 'Dates: ' + dates.slice(0, 5).join(', ') + (dates.length > 5 ? '...' : '');
                }
            } catch (e) {
                console.warn('Error parsing gapper dates:', e);
            }
        }

        if (spikeCount === 0) {
            document.getElementById('volspikeBadge').classList.add('inactive');
        }
        if (gapperCount === 0) {
            document.getElementById('gapperBadge').classList.add('inactive');
        }
        
        // Returns
        setReturnValue('dr1', data.dr_1);
        setReturnValue('dr5', data.dr_5);
        setReturnValue('dr20', data.dr_20);
        setReturnValue('dr60', data.dr_60);
        
        // Valuation & metrics
        document.getElementById('marketCap').textContent = formatLargeNumber(data.market_cap);
        document.getElementById('pe').textContent = data.pe != null ? formatNumber(data.pe, 1) : '--';
        document.getElementById('psTtm').textContent = data.ps_ttm != null ? formatNumber(data.ps_ttm, 1) : '--';
        document.getElementById('fpe').textContent = data.fpe != null ? formatNumber(data.fpe, 1) : '--';
        document.getElementById('fps').textContent = data.fps != null ? formatNumber(data.fps, 1) : '--';
        
        // Technical
        document.getElementById('rsi').textContent = data.rsi != null ? data.rsi : '--';
        document.getElementById('rsiMktcap').textContent = data.rsi_mktcap != null ? data.rsi_mktcap : '--';
        document.getElementById('atr20').textContent = data.atr20 != null ? formatNumber(data.atr20, 1) + '%' : '--';
        document.getElementById('volVs10dAvg').textContent = data.vol_vs_10d_avg != null ? formatNumber(data.vol_vs_10d_avg, 1) + 'x' : '--';
        document.getElementById('volume').textContent = formatVolume(data.volume);
        
        // Growth
        
        // Short interest
        document.getElementById('shortFloat').textContent = data.short_float != null ? formatNumber(data.short_float, 1) + '%' : '--';
        document.getElementById('shortRatio').textContent = data.short_ratio != null ? formatNumber(data.short_ratio, 1) : '--';
        
        // Updated at
        if (data.updated_at) {
            document.getElementById('updatedAt').textContent = 'Last updated: ' + data.updated_at;
        }
        
        // Show content
        document.getElementById('loading').style.display = 'none';
        document.getElementById('stock-content').style.display = 'block';
        
        // Load chart
        loadChartData();
        
    } catch (error) {
        console.error('Error loading stock data:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
    }
}

// ============================================
// Chart Functions
// ============================================

async function loadChartData() {
    try {
        const [ohlcResponse, earningsResponse] = await Promise.all([
            fetch(`/api/frontend/ohlc/${ticker}`),
            fetch(`/api/frontend/earnings-eps/${ticker}`)
        ]);
        
        const data = await ohlcResponse.json();
        const earningsData = await earningsResponse.json();
        
        if (data.error || !Array.isArray(data) || data.length === 0) {
            document.getElementById('chartLoading').innerHTML = '<span style="color: var(--text-muted);">No chart data available</span>';
            return;
        }
        
        allOhlcData = data;
        allEarningsData = Array.isArray(earningsData) ? earningsData : [];
        
        initChart();
        updateChart(currentTimeframe);
        setupTimeframeButtons();
        
        if (data.length > 0) {
            const latestData = data[data.length - 1];
            if (latestData.close != null) {
                const priceElement = document.getElementById('currentPrice');
                priceElement.textContent = '$' + formatNumber(latestData.close, 2);
            }
        }
        
    } catch (error) {
        console.error('Error loading chart data:', error);
        document.getElementById('chartLoading').innerHTML = '<span style="color: var(--text-muted);">Failed to load chart</span>';
    }
}

function initChart() {
    document.getElementById('chartLoading').style.display = 'none';
    
    const container = document.getElementById('chartContainer');
    const rsiContainer = document.getElementById('rsiChartContainer');
    
    chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: 450,
        layout: {
            background: { type: 'solid', color: 'transparent' },
            textColor: '#8b949e',
            fontFamily: "'JetBrains Mono', monospace",
        },
        grid: {
            vertLines: { color: 'rgba(48, 54, 61, 0.3)' },
            horzLines: { color: 'rgba(48, 54, 61, 0.3)' },
        },
        crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
            vertLine: {
                width: 1,
                color: 'rgba(88, 166, 255, 0.5)',
                style: LightweightCharts.LineStyle.Dashed,
            },
            horzLine: {
                width: 1,
                color: 'rgba(88, 166, 255, 0.5)',
                style: LightweightCharts.LineStyle.Dashed,
            },
        },
        rightPriceScale: {
            borderColor: '#30363d',
            scaleMargins: {
                top: 0.05,
                bottom: 0.15,
            },
        },
        timeScale: {
            borderColor: '#30363d',
            timeVisible: true,
            secondsVisible: false,
        },
        handleScroll: false,
        handleScale: false,
    });
    
    candlestickSeries = chart.addCandlestickSeries({
        upColor: '#3fb950',
        downColor: '#f85149',
        borderDownColor: '#f85149',
        borderUpColor: '#3fb950',
        wickDownColor: '#f85149',
        wickUpColor: '#3fb950',
    });
    
    dma50Series = chart.addLineSeries({
        color: '#00ff00',
        lineWidth: 2,
        lineStyle: LightweightCharts.LineStyle.Solid,
        priceLineVisible: false,
        lastValueVisible: false,
        crosshairMarkerVisible: false,
    });

    dma200Series = chart.addLineSeries({
        color: '#ff0000',
        lineWidth: 2,
        lineStyle: LightweightCharts.LineStyle.Solid,
        priceLineVisible: false,
        lastValueVisible: false,
        crosshairMarkerVisible: false,
    });
    
    volumeSeries = chart.addHistogramSeries({
        color: '#26a69a',
        priceFormat: {
            type: 'volume',
        },
        priceScaleId: '',
        scaleMargins: {
            top: 0.88,
            bottom: 0,
        },
    });
    
    rsiChart = LightweightCharts.createChart(rsiContainer, {
        width: rsiContainer.clientWidth,
        height: 120,
        layout: {
            background: { type: 'solid', color: 'transparent' },
            textColor: '#8b949e',
            fontFamily: "'JetBrains Mono', monospace",
        },
        grid: {
            vertLines: { color: 'rgba(48, 54, 61, 0.3)' },
            horzLines: { color: 'rgba(48, 54, 61, 0.3)' },
        },
        crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
            vertLine: {
                width: 1,
                color: 'rgba(88, 166, 255, 0.5)',
                style: LightweightCharts.LineStyle.Dashed,
            },
            horzLine: {
                width: 1,
                color: 'rgba(88, 166, 255, 0.5)',
                style: LightweightCharts.LineStyle.Dashed,
            },
        },
        rightPriceScale: {
            borderColor: '#30363d',
            scaleMargins: {
                top: 0.1,
                bottom: 0.1,
            },
            autoScale: true,
            minValue: 0,
            maxValue: 100,
        },
        timeScale: {
            borderColor: '#30363d',
            timeVisible: true,
            secondsVisible: false,
            visible: false,
        },
        handleScroll: false,
        handleScale: false,
    });
    
    rsiSeries = rsiChart.addAreaSeries({
        lineColor: '#00bcd4',
        topColor: 'rgba(0, 188, 212, 0.4)',
        bottomColor: 'rgba(0, 188, 212, 0.05)',
        lineWidth: 2,
        priceLineVisible: false,
        lastValueVisible: true,
        crosshairMarkerVisible: true,
    });
    
    window.addEventListener('resize', () => {
        if (chart) {
            chart.applyOptions({ width: container.clientWidth });
        }
        if (rsiChart) {
            rsiChart.applyOptions({ width: rsiContainer.clientWidth });
        }
    });
    
    chart.subscribeCrosshairMove(param => {
        if (param.time && rsiChart) {
            rsiChart.setCrosshairPosition(param.point?.y || 0, param.time, rsiSeries);
        }
    });
    
    rsiChart.subscribeCrosshairMove(param => {
        if (param.time && chart) {
            chart.setCrosshairPosition(param.point?.y || 0, param.time, candlestickSeries);
        }
    });
}

function updateChart(days) {
    if (!allOhlcData.length) return;
    
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - days);
    const cutoffStr = cutoffDate.toISOString().split('T')[0];
    
    const filteredData = allOhlcData.filter(d => d.time >= cutoffStr);
    
    if (filteredData.length === 0) {
        setChartData(allOhlcData);
    } else {
        setChartData(filteredData);
    }
    
    chart.timeScale().fitContent();
    if (rsiChart) {
        rsiChart.timeScale().fitContent();
    }
    updateChartStats(filteredData.length > 0 ? filteredData : allOhlcData);
}

function setChartData(data) {
    const candleData = data.map(d => ({
        time: d.time,
        open: d.open,
        high: d.high,
        low: d.low,
        close: d.close,
    }));
    candlestickSeries.setData(candleData);
    
    const dma50Data = data
        .filter(d => d.dma_50 != null)
        .map(d => ({
            time: d.time,
            value: d.dma_50,
        }));
    dma50Series.setData(dma50Data);
    
    const dma200Data = data
        .filter(d => d.dma_200 != null)
        .map(d => ({
            time: d.time,
            value: d.dma_200,
        }));
    dma200Series.setData(dma200Data);
    
    const volumeData = data.map(d => ({
        time: d.time,
        value: d.volume,
        color: d.close >= d.open ? 'rgba(63, 185, 80, 0.3)' : 'rgba(248, 81, 73, 0.3)',
    }));
    volumeSeries.setData(volumeData);
    
    const rsiData = data
        .filter(d => d.rsi_mktcap != null)
        .map(d => ({
            time: d.time,
            value: d.rsi_mktcap,
        }));
    rsiSeries.setData(rsiData);
    
    const dataTimeSet = new Set(data.map(d => d.time));
    const filteredEarnings = allEarningsData.filter(e => dataTimeSet.has(e.time));
    
    if (filteredEarnings.length > 0) {
        const markers = filteredEarnings.map(earning => {
            const actualText = earning.eps_actual != null ? `A: $${earning.eps_actual}` : '';
            const estText = earning.eps_estimated != null ? `E: $${earning.eps_estimated}` : '';
            let labelText = '';
            if (actualText && estText) {
                labelText = `${actualText} | ${estText}`;
            } else {
                labelText = actualText || estText || 'EPS';
            }
            
            let color = '#f5f5dc';
            if (earning.eps_actual != null && earning.eps_estimated != null) {
                color = earning.eps_actual >= earning.eps_estimated ? '#90EE90' : '#FFB6C1';
            }
            
            return {
                time: earning.time,
                position: 'belowBar',
                color: color,
                shape: 'arrowUp',
                text: labelText,
            };
        });
        
        candlestickSeries.setMarkers(markers);
    } else {
        candlestickSeries.setMarkers([]);
    }
    
    if (rsiChart && chart) {
        rsiChart.timeScale().fitContent();
    }
}

function setupTimeframeButtons() {
    document.querySelectorAll('.timeframe-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentTimeframe = parseInt(this.dataset.days);
            updateChart(currentTimeframe);
        });
    });
}

function updateChartStats(data) {
    if (!data || data.length === 0) return;
    
    const firstPrice = data[0].close;
    const lastPrice = data[data.length - 1].close;
    const changePercent = ((lastPrice - firstPrice) / firstPrice * 100).toFixed(2);
    const highest = Math.max(...data.map(d => d.high));
    const lowest = Math.min(...data.map(d => d.low));
    
    const statsHtml = `
        <div class="chart-stat">Change: <span class="${changePercent >= 0 ? 'text-green' : 'text-red'}">${changePercent >= 0 ? '+' : ''}${changePercent}%</span></div>
        <div class="chart-stat">High: <span>$${highest.toFixed(2)}</span></div>
        <div class="chart-stat">Low: <span>$${lowest.toFixed(2)}</span></div>
        <div class="chart-stat">Range: <span>$${(highest - lowest).toFixed(2)}</span></div>
    `;
    document.getElementById('chartStats').innerHTML = statsHtml;
}

// ============================================
// Notes Functions
// ============================================

let currentNotes = '';
let isEditMode = false;

async function loadNotes() {
    try {
        const response = await fetch(`/api/frontend/stock-notes/${ticker}`);
        const data = await response.json();
        
        currentNotes = data.notes || '';
        updateNotesDisplay();
        
        if (data.updated_at) {
            const date = new Date(data.updated_at);
            document.getElementById('notesMeta').textContent = `Last updated: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        } else {
            document.getElementById('notesMeta').textContent = '';
        }
    } catch (error) {
        console.error('Error loading notes:', error);
        document.getElementById('notesDisplay').textContent = 'Error loading notes';
        document.getElementById('notesDisplay').classList.add('empty');
    }
}

function updateNotesDisplay() {
    const display = document.getElementById('notesDisplay');
    if (currentNotes && currentNotes.trim()) {
        display.textContent = currentNotes;
        display.classList.remove('empty');
    } else {
        display.textContent = 'No notes yet. Click Edit to add your analysis.';
        display.classList.add('empty');
    }
}

function toggleEditMode() {
    isEditMode = true;
    document.getElementById('notesDisplay').style.display = 'none';
    document.getElementById('notesTextarea').style.display = 'block';
    document.getElementById('notesTextarea').value = currentNotes;
    document.getElementById('notesTextarea').focus();
    
    document.getElementById('editNotesBtn').style.display = 'none';
    document.getElementById('saveNotesBtn').style.display = 'inline-block';
    document.getElementById('cancelNotesBtn').style.display = 'inline-block';
    document.getElementById('saveStatus').textContent = '';
}

function cancelEdit() {
    isEditMode = false;
    document.getElementById('notesDisplay').style.display = 'block';
    document.getElementById('notesTextarea').style.display = 'none';
    
    document.getElementById('editNotesBtn').style.display = 'inline-block';
    document.getElementById('saveNotesBtn').style.display = 'none';
    document.getElementById('cancelNotesBtn').style.display = 'none';
    document.getElementById('saveStatus').textContent = '';
}

async function saveNotes() {
    const newNotes = document.getElementById('notesTextarea').value;
    const saveStatus = document.getElementById('saveStatus');
    const saveBtn = document.getElementById('saveNotesBtn');
    
    saveStatus.textContent = 'Saving...';
    saveStatus.className = 'notes-save-status saving';
    saveBtn.disabled = true;
    
    try {
        const response = await fetch(`/api/frontend/stock-notes/${ticker}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ notes: newNotes }),
        });
        
        const data = await response.json();
        
        if (response.ok) {
            currentNotes = newNotes;
            updateNotesDisplay();
            cancelEdit();
            
            saveStatus.textContent = '‚úì Saved';
            saveStatus.className = 'notes-save-status saved';
            
            if (data.updated_at) {
                const date = new Date(data.updated_at);
                document.getElementById('notesMeta').textContent = `Last updated: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
            }
            
            setTimeout(() => {
                saveStatus.textContent = '';
            }, 3000);
        } else {
            throw new Error(data.error || 'Failed to save notes');
        }
    } catch (error) {
        console.error('Error saving notes:', error);
        saveStatus.textContent = '‚úï Error saving';
        saveStatus.className = 'notes-save-status error';
    } finally {
        saveBtn.disabled = false;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadStockData();
    loadNotes();
});
</script>
{% endblock %}
