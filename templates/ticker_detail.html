<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ ticker }} - Stock Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Chart container and headings */
        .chart-container {
            background: #ffffff;
            border: none;
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
        }
        .chart-title {
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #198754;
        }

        /* Candlestick colours */
        .candlestick.up {
            fill: #198754;
            stroke: #198754;
        }
        .candlestick.down {
            fill: #dc3545;
            stroke: #dc3545;
        }
        .wick.up { stroke: #198754; }
        .wick.down { stroke: #dc3545; }

        /* Volume bars */
        .volume-bar.up {
            fill: rgba(25, 135, 84, 0.3);
            stroke: rgba(25, 135, 84, 0.5);
        }
        .volume-bar.down {
            fill: rgba(220, 53, 69, 0.3);
            stroke: rgba(220, 53, 69, 0.5);
        }

        /* Axis + grid */
        .axis line, .axis path { stroke: #6c757d; }
        .axis text { fill: #6c757d; font-size: 11px; }
        .grid line { stroke: #dee2e6; stroke-opacity: 0.5; }

        /* Tooltip */
        .tooltip {
            position: absolute;
            padding: 12px;
            background: rgba(255, 255, 255, 0.95);
            color: #212529;
            border: 1px solid #198754;
            border-radius: 8px;
            pointer-events: none;
            font-size: 13px;
            line-height: 1.5;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
    </style>
    <style>
        /* Remove table outer border while keeping inner borders */
        .stock-info-table {
            border-collapse: collapse;
        }
        .stock-info-table td, .stock-info-table th {
            border: 1px solid #dee2e6;
        }
        .stock-info-table tr:first-child td {
            border-top: 0;
        }
        .stock-info-table tr:last-child td {
            border-bottom: 0;
        }
        .stock-info-table tr td:first-child,
        .stock-info-table tr th:first-child {
            border-left: 0;
        }
        .stock-info-table tr td:last-child,
        .stock-info-table tr th:last-child {
            border-right: 0;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Stocks Assist</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Return1D">1D Returns</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Return5D">5D Returns</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Return20D">20D Returns</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Return60D">60D Returns</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Return120D">120D Returns</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Gapper">Gapper Screen</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Volume">Volume Screen</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/AllReturns">All Returns</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/AbiShortList">Abi ShortList</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/AbiBlackList">Abi BlackList</a>
                    </li>
                </ul>
                <!-- Chat trigger -->
                <button class="btn btn-outline-info me-2" type="button" data-bs-toggle="modal" data-bs-target="#chatModal" title="Chatbot">
                    <i class="fas fa-comments"></i>
                </button>

                <span class="navbar-text" id="market-status"><small id="navbarLatestDate"></small></span>
                <div>
                    <button class="btn btn-back" onclick="window.history.back()">← Back</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Stock Information Table -->
        <div class="row mb-2">
            <div class="col-12">
                <div class="card border-0">
                    <div class="card-body p-1">
                        <table class="table table-sm table-bordered mb-0 stock-info-table">
                            <tbody>
                                <tr>
                                    <td class="bg-light text-muted fw-semibold" style="width: 10%; padding: 0.1rem 0.2rem;">Symbol</td>
                                    <td style="width: 8%; padding: 0.1rem 0.2rem;">
                                        <span class="fw-bold text-success">{{ ticker }}</span>
                                    </td>
                                    <td class="bg-light text-muted fw-semibold" style="width: 10%; padding: 0.1rem 0.2rem;">Company</td>
                                    <td style="width: 22%; padding: 0.1rem 0.2rem;" id="companyName">Loading...</td>
                                    <td class="bg-light text-muted fw-semibold" style="width: 10%; padding: 0.1rem 0.2rem;">Price</td>
                                    <td style="width: 18%; padding: 0.1rem 0.2rem;">
                                        <span class="fw-bold text-success" id="currentPrice">$--</span>
                                        <span class="ms-1" id="priceChange">--</span>
                                    </td>
                                    <td class="bg-light text-muted fw-semibold" style="width: 10%; padding: 0.1rem 0.2rem;">52Wk Range</td>
                                    <td style="width: 12%; padding: 0.1rem 0.2rem;" id="week52Range">--</td>
                                </tr>
                                <tr>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Sector</td>
                                    <td style="padding: 0.1rem 0.2rem;">
                                        <span class="fw-bold text-primary" id="sector">--</span>
                                    </td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Industry</td>
                                    <td style="padding: 0.1rem 0.2rem;" id="industry">--</td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Country</td>
                                    <td style="padding: 0.1rem 0.2rem;">
                                        <span class="badge bg-info" id="country">--</span>
                                    </td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Market Cap</td>
                                    <td style="padding: 0.1rem 0.2rem;">
                                        <span class="badge bg-warning text-dark" id="marketCap">--</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Volume</td>
                                    <td style="padding: 0.1rem 0.2rem;" id="volume">--</td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Avg Volume</td>
                                    <td style="padding: 0.1rem 0.2rem;" id="avgVolume">--</td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Vol Change</td>
                                    <td style="padding: 0.1rem 0.2rem;">
                                        <span class="badge" id="volumeChange">--</span>
                                    </td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Shares Out</td>
                                    <td style="padding: 0.1rem 0.2rem;" id="sharesOutstanding">--</td>
                                </tr>
                                <tr>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">5D Return</td>
                                    <td style="padding: 0.1rem 0.2rem;">
                                        <span class="badge" id="return5d">--</span>
                                    </td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">20D Return</td>
                                    <td style="padding: 0.1rem 0.2rem;">
                                        <span class="badge" id="return20d">--</span>
                                    </td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">60D Return</td>
                                    <td style="padding: 0.1rem 0.2rem;">
                                        <span class="badge" id="return60d">--</span>
                                    </td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Shares Float</td>
                                    <td style="padding: 0.1rem 0.2rem;" id="sharesFloat">--</td>
                                </tr>
                                <tr>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Short Float</td>
                                    <td style="padding: 0.1rem 0.2rem;" id="shortFloat">--</td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Short Ratio</td>
                                    <td style="padding: 0.1rem 0.2rem;" id="shortRatio">--</td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Short Interest</td>
                                    <td style="padding: 0.1rem 0.2rem;" id="shortInterest">--</td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Flags</td>
                                    <td style="padding: 0.1rem 0.2rem;">
                                        <div class="d-flex flex-column gap-1">
                                            <div class="d-flex gap-2 align-items-center" style="font-size: 0.75rem;">
                                                <label class="form-check-label d-flex align-items-center gap-1 mb-0">
                                                    <input type="checkbox" class="form-check-input" id="reviewedCheck" style="margin: 0;">
                                                    <span>Reviewed</span>
                                                </label>
                                                <label class="form-check-label d-flex align-items-center gap-1 mb-0">
                                                    <input type="checkbox" class="form-check-input" id="shortlistCheck" style="margin: 0;">
                                                    <span>Shortlist</span>
                                                </label>
                                                <label class="form-check-label d-flex align-items-center gap-1 mb-0">
                                                    <input type="checkbox" class="form-check-input" id="blacklistCheck" style="margin: 0;">
                                                    <span>Blacklist</span>
                                                </label>
                                            </div>
                                            <div>
                                                <button type="button" class="btn btn-primary btn-sm" onclick="saveFlags()" style="padding: 0.15rem 0.5rem; font-size: 0.7rem;">
                                                    Save Flags
                                                </button>
                                            </div>
                                            <div id="flagsError" class="text-danger" style="display: none; font-size: 0.7rem;"></div>
                                            <div id="flagsSuccess" class="text-success" style="display: none; font-size: 0.7rem;"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="mt-1">
                            <a href="https://seekingalpha.com/symbol/{{ ticker }}/analysis" target="_blank" class="btn btn-outline-secondary btn-sm">
                                View analysis on Seeking Alpha ↗
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Concise Notes Section -->
        <div class="row mb-2">
            <div class="col-12">
                <div class="card border-0">
                    <div class="card-body p-1">
                        <h6 class="card-title mb-1 fs-6">Concise Notes</h6>
                        <div class="mb-2">
                            <textarea class="form-control form-control-sm fs-6" id="conciseNoteText" rows="3" placeholder="Add your concise notes about this stock..."></textarea>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <button type="button" class="btn btn-success btn-sm fs-6" onclick="saveConciseNote()">Save Notes</button>
                                <small class="text-muted" id="noteLastUpdated"></small>
                            </div>
                            <div id="noteError" class="text-danger mt-1 fs-6" style="display: none;"></div>
                            <div id="noteSuccess" class="text-success mt-1 fs-6" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Description Section -->
        <div class="row mb-2">
            <div class="col-12">
                <div class="card border-0">
                    <div class="card-body p-1">
                        <h6 class="card-title mb-1 fs-6">Description</h6>
                        <p class="mb-0 text-muted fs-6" id="description">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="row mb-2">
            <div class="col-12">
                <!-- User Comments Card -->
                <div class="card mb-2 border-0">
                    <div class="card-body p-1">
                        <h6 class="card-title mb-1 fs-6">User Comments</h6>
                        
                        <!-- Add Comment Form -->
                        <div class="mb-2">
                            <textarea class="form-control form-control-sm fs-6" id="commentText" rows="2" placeholder="Add your comment..."></textarea>
                            <button type="button" class="btn btn-success btn-sm mt-1 fs-6" onclick="addComment()">Add Comment</button>
                            <div id="commentError" class="text-danger mt-1 fs-6" style="display: none;"></div>
                        </div>
                        
                        <!-- Comments List -->
                        <div id="commentsContainer">
                            <div id="loadingComments" class="text-center py-1">
                                <div class="spinner-border spinner-border-sm text-success" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <div id="commentsError" class="error-message" style="display: none; font-size: 0.75rem;"></div>
                            <div id="commentsList"></div>
                        </div>
                    </div>
                </div>

                <!-- AI Comments Card -->
                <div class="card border-0">
                    <div class="card-body p-1">
                        <h6 class="card-title mb-1 fs-6">AI Analysis</h6>
                        
                        <!-- Fetch AI Comments Button -->
                        <div class="mb-2">
                            <button type="button" class="btn btn-primary btn-sm fs-6" onclick="fetchAIComments()">Fetch AI Analysis</button>
                        </div>
                        
                        <!-- AI Comments Input -->
                        <div id="aiCommentInput" class="mb-2" style="display: none;">
                            <div id="aiCommentDisplay" class="form-control fs-6" style="min-height: 300px; max-height: 400px; overflow-y: auto; background-color: #f8f9fa; border: 1px solid #ced4da; border-radius: 0.375rem; padding: 0.5rem; white-space: pre-wrap;"></div>
                            <button type="button" class="btn btn-success btn-sm mt-1 fs-6" onclick="saveAIComment()">Save AI Analysis</button>
                        </div>
                        
                        <!-- Pending AI Comments Review Section -->
                        <div id="pendingAIContainer" style="display: none;">
                            <small class="text-warning fs-6">⚠️ Pending Review</small>
                            <div id="pendingAIList"></div>
                            <hr class="my-1">
                        </div>
                        
                        <!-- AI Comments List -->
                        <div id="aiCommentsContainer">
                            <div id="aiCommentsList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- News Section -->
        <div class="row mb-2">
            <div class="col-12">
                <div class="card border-0">
                    <div class="card-body p-1">
                        <h6 class="card-title mb-1 fs-6">Latest News</h6>
                        <div id="newsLoading" class="text-center py-1">
                            <div class="spinner-border spinner-border-sm text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="newsError" class="text-danger fs-6" style="display:none;"></div>
                        <table class="table table-sm mb-0" id="newsTable" style="display:none;">
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Section - Charts (Full Width) -->
        <div class="row">
            <div class="col-12">
                <!-- 3-Month Chart Section -->
                <div class="chart-container">
                    <div class="chart-title" id="chart3MonthTitle">{{ ticker }} - 3 Month Price Chart</div>
                    <div id="loadingChart3Month" class="loading-spinner">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading 3-month chart...</span>
                        </div>
                    </div>
                    <div id="errorMessage3Month" class="error-message" style="display: none;"></div>
                    <div id="chart3Month"></div>
                </div>

                <!-- Yearly Chart Section -->
                <div class="chart-container">
                    <div class="chart-title" id="chartYearlyTitle">{{ ticker }} - Yearly Price Chart</div>
                    <div id="loadingChartYearly" class="loading-spinner">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading yearly chart...</span>
                        </div>
                    </div>
                    <div id="errorMessageYearly" class="error-message" style="display: none;"></div>
                    <div id="chartYearly"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="{{ url_for('static', filename='navbar-date.js') }}"></script>
    <script>
        const ticker = '{{ ticker }}';
        
        // Load ticker details
        function loadTickerDetails() {
            fetch(`/api/stock/${ticker}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    document.getElementById('companyName').textContent = data.company_name || 'N/A';
                    document.getElementById('currentPrice').textContent = data.close_price ? `$${data.close_price.toFixed(2)}` : '$--';
                    document.getElementById('marketCap').textContent = formatMarketCap(data.market_cap);
                    document.getElementById('volume').textContent = formatVolume(data.volume);
                    document.getElementById('sector').textContent = data.sector || 'N/A';
                    document.getElementById('industry').textContent = data.industry || 'N/A';
                    document.getElementById('country').textContent = data.country || 'N/A';
                    document.getElementById('description').textContent = data.description || 'No description available.';
                    
                    // Format price change
                    const priceChangeElement = document.getElementById('priceChange');
                    if (data.price_change !== null && data.price_change_pct !== null) {
                        const changeText = `${data.price_change >= 0 ? '+' : ''}$${data.price_change.toFixed(2)} (${data.price_change_pct >= 0 ? '+' : ''}${data.price_change_pct.toFixed(2)}%)`;
                        priceChangeElement.textContent = changeText;
                        priceChangeElement.className = data.price_change >= 0 ? 'ms-1 text-success fw-bold' : 'ms-1 text-danger fw-bold';
                    } else {
                        priceChangeElement.textContent = '--';
                        priceChangeElement.className = 'ms-1 text-muted';
                    }
                    
                    // 52-week range (combined)
                    const week52RangeElement = document.getElementById('week52Range');
                    if (data.week_52_low && data.week_52_high) {
                        week52RangeElement.textContent = `$${data.week_52_low.toFixed(2)} - $${data.week_52_high.toFixed(2)}`;
                    } else {
                        week52RangeElement.textContent = '--';
                    }
                    
                    // Average volume and volume change with badge styling
                    document.getElementById('avgVolume').textContent = formatVolume(data.avg_volume);
                    const volumeChangeElement = document.getElementById('volumeChange');
                    if (data.volume_change_multiplier) {
                        volumeChangeElement.textContent = `${data.volume_change_multiplier.toFixed(1)}x`;
                        volumeChangeElement.className = 'badge bg-warning text-dark';
                    } else {
                        volumeChangeElement.textContent = '--';
                        volumeChangeElement.className = 'badge bg-warning text-dark';
                    }
                    
                    // Returns with badge color coding
                    const return5dElement = document.getElementById('return5d');
                    if (data.return_5d !== null) {
                        return5dElement.textContent = `${data.return_5d >= 0 ? '+' : ''}${data.return_5d.toFixed(1)}%`;
                        if (data.return_5d >= 5) {
                            return5dElement.className = 'badge bg-success';
                        } else if (data.return_5d >= 0) {
                            return5dElement.className = 'badge bg-success bg-opacity-50';
                        } else if (data.return_5d >= -5) {
                            return5dElement.className = 'badge bg-danger bg-opacity-50';
                        } else {
                            return5dElement.className = 'badge bg-danger';
                        }
                    } else {
                        return5dElement.textContent = '--';
                        return5dElement.className = 'badge bg-secondary';
                    }
                    
                    const return20dElement = document.getElementById('return20d');
                    if (data.return_20d !== null) {
                        return20dElement.textContent = `${data.return_20d >= 0 ? '+' : ''}${data.return_20d.toFixed(1)}%`;
                        if (data.return_20d >= 10) {
                            return20dElement.className = 'badge bg-success';
                        } else if (data.return_20d >= 0) {
                            return20dElement.className = 'badge bg-success bg-opacity-50';
                        } else if (data.return_20d >= -10) {
                            return20dElement.className = 'badge bg-danger bg-opacity-50';
                        } else {
                            return20dElement.className = 'badge bg-danger';
                        }
                    } else {
                        return20dElement.textContent = '--';
                        return20dElement.className = 'badge bg-secondary';
                    }
                    
                    const return60dElement = document.getElementById('return60d');
                    if (data.return_60d !== null) {
                        return60dElement.textContent = `${data.return_60d >= 0 ? '+' : ''}${data.return_60d.toFixed(1)}%`;
                        if (data.return_60d >= 20) {
                            return60dElement.className = 'badge bg-success';
                        } else if (data.return_60d >= 0) {
                            return60dElement.className = 'badge bg-success bg-opacity-50';
                        } else if (data.return_60d >= -20) {
                            return60dElement.className = 'badge bg-danger bg-opacity-50';
                        } else {
                            return60dElement.className = 'badge bg-danger';
                        }
                    } else {
                        return60dElement.textContent = '--';
                        return60dElement.className = 'badge bg-secondary';
                    }
                    
                    // Shares and short interest data (placeholders for now)
                    document.getElementById('sharesOutstanding').textContent = data.shares_outstanding ? formatLargeNumber(data.shares_outstanding) : '--';
                    document.getElementById('sharesFloat').textContent = data.shares_float ? formatLargeNumber(data.shares_float) : '--';
                    document.getElementById('shortFloat').textContent = data.short_float ? `${data.short_float.toFixed(1)}%` : '--';
                    document.getElementById('shortRatio').textContent = data.short_ratio ? data.short_ratio.toFixed(1) : '--';
                    document.getElementById('shortInterest').textContent = data.short_interest ? `${data.short_interest.toFixed(1)}%` : '--';
                })
                .catch(error => {
                    console.error('Error loading ticker details:', error);
                    document.getElementById('companyName').textContent = 'Error loading data';
                });
        }
        
        // Load and create both charts
        function loadCharts() {
            fetch(`/api/stock/${ticker}/prices`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Hide loading indicators
                    document.getElementById('loadingChart3Month').style.display = 'none';
                    document.getElementById('loadingChartYearly').style.display = 'none';
                    
                    // Create both charts
                    create3MonthChart(data);
                    createYearlyChart(data);
                })
                .catch(error => {
                    console.error('Error loading chart data:', error);
                    document.getElementById('loadingChart3Month').style.display = 'none';
                    document.getElementById('loadingChartYearly').style.display = 'none';
                    document.getElementById('errorMessage3Month').style.display = 'block';
                    document.getElementById('errorMessage3Month').textContent = `Error loading charts: ${error.message}`;
                    document.getElementById('errorMessageYearly').style.display = 'block';
                    document.getElementById('errorMessageYearly').textContent = `Error loading charts: ${error.message}`;
                });
        }
        
        function create3MonthChart(priceData) {
            // Filter data for last 3 months
            const now = new Date();
            const threeMonthsAgo = new Date(now.getTime() - (90 * 24 * 60 * 60 * 1000));
            const filteredData = priceData.filter(d => new Date(d.date) >= threeMonthsAgo);
            
            createChart(filteredData, 'chart3Month', 'chart3MonthTitle', '3-Month');
        }

        function createYearlyChart(priceData) {
            createChart(priceData, 'chartYearly', 'chartYearlyTitle', 'Yearly');
        }

        function createChart(priceData, containerId, titleId, chartType) {
            // Configuration
            const margin = {top: 20, right: 90, bottom: 100, left: 20};
            const volumeHeight = 80;
            const width = Math.min(1140, window.innerWidth - 100) - margin.left - margin.right;
            const height = 500; // Price section is exactly 500px tall

            // Process the data
            const data = priceData.map(d => {
                // Parse date as local date to avoid timezone shift
                // Split the date string and create date in local timezone
                const dateParts = d.date.split('-');
                const localDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                
                return {
                    date: localDate,
                    open: +d.open_price,
                    high: +d.high_price,
                    low: +d.low_price,
                    close: +d.close_price,
                    volume: +d.volume
                };
            }).filter(d => 
                !isNaN(d.date.getTime()) && 
                !isNaN(d.open) && 
                !isNaN(d.high) && 
                !isNaN(d.low) && 
                !isNaN(d.close) &&
                !isNaN(d.volume)
            ).sort((a, b) => a.date - b.date);

            if (data.length === 0) {
                document.getElementById(containerId.replace('chart', 'errorMessage')).style.display = 'block';
                document.getElementById(containerId.replace('chart', 'errorMessage')).textContent = 'No valid price data available';
                return;
            }

            // Create SVG
            const svg = d3.select(`#${containerId}`)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + volumeHeight + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Create tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // Format functions
            const formatPrice = d3.format("$,.2f");
            const formatVolume = d3.format(",.0f");
            const formatDate = d3.timeFormat("%B %d, %Y");
            const formatAxisDate = d3.timeFormat("%Y/%m/%d");

            // Set scales
            const x = d3.scaleBand()
                .domain(data.map(d => d.date))
                .range([0, width - 10])
                .padding(0.2);

            const y = d3.scaleLinear()
                .domain([
                    d3.min(data, d => d.low) * 0.995,
                    d3.max(data, d => d.high) * 1.005
                ])
                .range([height, 0]);

            const yVolume = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.volume)])
                .range([height + volumeHeight, height]);

            // Add axes
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0,${height + volumeHeight})`)
                .call(d3.axisBottom(x)
                    .tickFormat(d => formatAxisDate(d))
                    .tickValues(x.domain().filter((d, i) => i % Math.max(1, Math.floor(data.length / 10)) === 0)));

            svg.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(${width},0)`)
                .call(d3.axisRight(y)
                    .tickFormat(d => formatPrice(d)));

            svg.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(${width},0)`)
                .call(d3.axisRight(yVolume)
                    .tickFormat(d => formatVolume(d/1000000) + "M")
                    .ticks(3));

            // Add grid
            svg.append("g")
                .attr("class", "grid")
                .attr("transform", `translate(${width},0)`)
                .call(d3.axisRight(y)
                    .tickSize(-width)
                    .tickFormat(""));

            // Add volume bars
            svg.selectAll("rect.volume-bar")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", d => `volume-bar ${d.close >= d.open ? "up" : "down"}`)
                .attr("x", d => x(d.date))
                .attr("y", d => yVolume(d.volume))
                .attr("width", x.bandwidth())
                .attr("height", d => yVolume(0) - yVolume(d.volume));

            // Add candlesticks
            svg.selectAll("g.candlestick")
                .data(data)
                .enter()
                .append("g")
                .attr("class", "candlestick")
                .each(function(d) {
                    const g = d3.select(this);
                    const isUp = d.close >= d.open;
                    const className = isUp ? "up" : "down";
                    
                    // Draw the wick
                    g.append("line")
                        .attr("class", `wick ${className}`)
                        .attr("x1", x(d.date) + x.bandwidth()/2)
                        .attr("x2", x(d.date) + x.bandwidth()/2)
                        .attr("y1", y(d.high))
                        .attr("y2", y(d.low));
                    
                    // Draw the body
                    g.append("rect")
                        .attr("class", `candlestick ${className}`)
                        .attr("x", x(d.date))
                        .attr("y", y(Math.max(d.open, d.close)))
                        .attr("width", x.bandwidth())
                        .attr("height", Math.max(1, Math.abs(y(d.open) - y(d.close))));
                })
                .on("mouseover", function(event, d) {
                    const pctChange = ((d.close - d.open) / d.open * 100).toFixed(2);
                    const sign = pctChange >= 0 ? "+" : "";
                    
                    tooltip.transition()
                        .duration(100)
                        .style("opacity", .9);
                    tooltip.html(
                        `<strong>${formatDate(d.date)}</strong><br/>` +
                        `Open: ${formatPrice(d.open)}<br/>` +
                        `High: ${formatPrice(d.high)}<br/>` +
                        `Low: ${formatPrice(d.low)}<br/>` +
                        `Close: ${formatPrice(d.close)}<br/>` +
                        `Volume: ${formatVolume(d.volume)}<br/>` +
                        `Change: ${sign}${pctChange}%`
                    )
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", 0);
                });

            // Update chart title with date range
            if (data.length > 0) {
                const startDate = d3.timeFormat("%b %d, %Y")(data[0].date);
                const endDate = d3.timeFormat("%b %d, %Y")(data[data.length - 1].date);
                document.getElementById(titleId).textContent = `${ticker} ${chartType} Price Chart (${startDate} - ${endDate})`;
            }
        }
        
        function formatMarketCap(marketCap) {
            if (!marketCap) return 'N/A';
            if (marketCap >= 1000000000) {
                return `$${(marketCap / 1000000000).toFixed(1)}B`;
            } else if (marketCap >= 1000000) {
                return `$${(marketCap / 1000000).toFixed(0)}M`;
            } else {
                return `$${marketCap.toLocaleString()}`;
            }
        }
        
        function formatVolume(volume) {
            if (!volume) return 'N/A';
            if (volume >= 1000000) {
                return `${(volume / 1000000).toFixed(1)}M`;
            } else if (volume >= 1000) {
                return `${(volume / 1000).toFixed(0)}K`;
            } else {
                return volume.toLocaleString();
            }
        }
        
        function formatLargeNumber(number) {
            if (!number) return 'N/A';
            if (number >= 1000000000) {
                return `${(number / 1000000000).toFixed(1)}B`;
            } else if (number >= 1000000) {
                return `${(number / 1000000).toFixed(1)}M`;
            } else if (number >= 1000) {
                return `${(number / 1000).toFixed(0)}K`;
            } else {
                return number.toLocaleString();
            }
        }
        
        // Comments functions
        function loadComments() {
            fetch(`/api/comments/${ticker}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loadingComments').style.display = 'none';
                    
                    if (data.error) {
                        document.getElementById('commentsError').style.display = 'block';
                        document.getElementById('commentsError').textContent = data.error;
                        return;
                    }
                    
                    displayComments(data);
                })
                .catch(error => {
                    console.error('Error loading comments:', error);
                    document.getElementById('loadingComments').style.display = 'none';
                    document.getElementById('commentsError').style.display = 'block';
                    document.getElementById('commentsError').textContent = 'Error loading comments';
                });
        }
        
        function displayComments(comments) {
            const commentsList = document.getElementById('commentsList');
            const aiCommentsList = document.getElementById('aiCommentsList');
            
            // Separate user and AI comments
            const userComments = comments.filter(c => c.comment_type === 'user');
            const aiComments = comments.filter(c => c.comment_type === 'ai' && c.status === 'approved');
            
            // Display user comments

                commentsList.innerHTML = userComments.map(comment => `
                    <div class="card mb-1" id="comment-${comment.id}">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <p class="card-text mb-0 small flex-grow-1">${escapeHtml(comment.comment_text)} <span class="text-muted">— ${comment.formatted_date}</span></p>
                                <div class="btn-group btn-group-sm ms-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="editComment(${comment.id})">Edit</button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteComment(${comment.id})">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            
            
            // Display AI comments
            if (aiComments.length === 0) {
                aiCommentsList.innerHTML = '<div class="text-muted text-center py-1">No AI analysis available yet.</div>';
            } else {
                aiCommentsList.innerHTML = aiComments.map(comment => `
                    <div class="card mb-1" id="comment-${comment.id}">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="card-text mb-0 small flex-grow-1" style="white-space: pre-wrap;">${renderAICommentContent(comment.comment_text)} <span class="text-muted">— ${comment.formatted_date}</span></div>
                                <div class="btn-group btn-group-sm ms-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="editComment(${comment.id})">Edit</button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteComment(${comment.id})">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function renderAICommentContent(content) {
            // Convert markdown-style formatting to HTML and preserve hyperlinks
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Bold
                .replace(/\n/g, '<br>');  // Line breaks
            // Note: Hyperlinks are already in HTML format from the backend processing
        }
        
        function editComment(commentId) {
            const commentElement = document.getElementById(`comment-${commentId}`);
            const currentText = commentElement.querySelector('.card-text').textContent.split('—')[0].trim();
            
            // Create edit form
            const editForm = `
                <div class="card-body p-2">
                    <textarea class="form-control form-control-sm mb-2">${currentText}</textarea>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-success btn-sm" onclick="saveEdit(${commentId})">Save</button>
                        <button class="btn btn-secondary btn-sm" onclick="cancelEdit(${commentId})">Cancel</button>
                    </div>
                </div>
            `;
            
            commentElement.innerHTML = editForm;
        }

        function saveEdit(commentId) {
            const commentElement = document.getElementById(`comment-${commentId}`);
            const newText = commentElement.querySelector('textarea').value.trim();
            
            if (!newText) {
                alert('Comment cannot be empty');
                return;
            }
            
            fetch(`/api/comments/${commentId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    comment_text: newText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                loadComments(); // Reload all comments
            })
            .catch(error => {
                console.error('Error saving edit:', error);
                alert('Error saving edit: ' + error.message);
            });
        }

        function cancelEdit(commentId) {
            loadComments(); // Reload all comments to restore original state
        }

        function deleteComment(commentId) {
            if (!confirm('Are you sure you want to delete this comment?')) {
                return;
            }
            
            fetch(`/api/comments/${commentId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                loadComments(); // Reload all comments
            })
            .catch(error => {
                console.error('Error deleting comment:', error);
                alert('Error deleting comment: ' + error.message);
            });
        }
        
        function addComment() {
            const commentText = document.getElementById('commentText').value.trim();
            const errorDiv = document.getElementById('commentError');
            
            // Clear any previous errors
            errorDiv.style.display = 'none';
            
            if (!commentText) {
                errorDiv.textContent = 'Please enter a comment';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Disable button during submission
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Adding...';
            
            fetch(`/api/comments/${ticker}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    comment_text: commentText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    errorDiv.textContent = data.error;
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // Clear the text area and reload comments
                document.getElementById('commentText').value = '';
                loadComments();
            })
            .catch(error => {
                console.error('Error adding comment:', error);
                errorDiv.textContent = 'Error adding comment';
                errorDiv.style.display = 'block';
            })
            .finally(() => {
                // Re-enable button
                button.disabled = false;
                button.textContent = 'Add Comment';
            });
        }
        
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;")
                .replace(/\n/g, "<br>");
        }

        // Add these functions before the DOMContentLoaded event listener
        function fetchAIComments() {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Fetching...';
            
            fetch('/api/perplexity', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ticker: ticker
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Show the input area with the AI response
                document.getElementById('aiCommentInput').style.display = 'block';
                
                // Get the display div and set the HTML content
                const aiCommentDisplay = document.getElementById('aiCommentDisplay');
                
                // Convert markdown-style formatting to HTML
                let htmlContent = data.response
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Bold
                    .replace(/\n/g, '<br>');  // Line breaks
                
                aiCommentDisplay.innerHTML = htmlContent;
                
                // Store the original content for saving
                window.aiCommentContent = data.response;
            })
            .catch(error => {
                console.error('Error fetching AI comments:', error);
                alert('Error fetching AI comments: ' + error.message);
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = 'Fetch AI Comments';
            });
        }
        
        function saveAIComment() {
            // Use the stored content instead of trying to get it from a textarea
            const commentText = window.aiCommentContent;
            
            if (!commentText) {
                alert('No AI comment to save');
                return;
            }
            
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Saving...';
            
            fetch(`/api/ai-comments/${ticker}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    comment_text: commentText,
                    ai_source: 'perplexity'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Clear and hide the input area
                const aiCommentDisplay = document.getElementById('aiCommentDisplay');
                if (aiCommentDisplay) {
                    aiCommentDisplay.innerHTML = '';
                }
                document.getElementById('aiCommentInput').style.display = 'none';
                window.aiCommentContent = null;
                
                // Reload comments to show the new AI comment
                loadComments();
            })
            .catch(error => {
                console.error('Error saving AI comment:', error);
                alert('Error saving AI comment: ' + error.message);
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = 'Save AI Comment';
            });
        }

        // Flags functionality
        function loadFlags() {
            fetch(`/api/flags/${ticker}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading flags:', data.error);
                        return;
                    }
                    
                    // Set checkbox states
                    document.getElementById('reviewedCheck').checked = data.is_reviewed || false;
                    document.getElementById('shortlistCheck').checked = data.is_shortlisted || false;
                    document.getElementById('blacklistCheck').checked = data.is_blacklisted || false;
                })
                .catch(error => {
                    console.error('Error loading flags:', error);
                });
        }
        
        function saveFlags() {
            const reviewedCheck = document.getElementById('reviewedCheck').checked;
            const shortlistCheck = document.getElementById('shortlistCheck').checked;  
            const blacklistCheck = document.getElementById('blacklistCheck').checked;
            const errorDiv = document.getElementById('flagsError');
            const successDiv = document.getElementById('flagsSuccess');
            
            // Hide previous messages
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            // Prepare batch changes
            const changes = [];
            
            // Add changes for each flag
            changes.push({ ticker: ticker, flag: 'reviewed', value: reviewedCheck });
            changes.push({ ticker: ticker, flag: 'shortlisted', value: shortlistCheck });
            changes.push({ ticker: ticker, flag: 'blacklisted', value: blacklistCheck });
            
            fetch('/api/flags/batch', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    changes: changes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    errorDiv.textContent = data.error;
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // Show success message
                successDiv.textContent = `Flags saved successfully! (${data.success_count} changes)`;
                successDiv.style.display = 'block';
                
                // Hide success message after 3 seconds
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);
                
                // Log any errors if present
                if (data.errors && data.errors.length > 0) {
                    console.warn('Some flag updates had errors:', data.errors);
                }
            })
            .catch(error => {
                errorDiv.textContent = 'Error saving flags: ' + error.message;
                errorDiv.style.display = 'block';
            });
        }

        // Concise Notes functionality
        function loadConciseNote() {
            fetch(`/api/concise-notes/${ticker}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading concise note:', data.error);
                        return;
                    }
                    
                    document.getElementById('conciseNoteText').value = data.note || '';
                    
                    if (data.updated_at) {
                        document.getElementById('noteLastUpdated').textContent = `Last updated: ${new Date(data.updated_at).toLocaleString()}`;
                    } else {
                        document.getElementById('noteLastUpdated').textContent = '';
                    }
                })
                .catch(error => {
                    console.error('Error loading concise note:', error);
                });
        }
        
        function saveConciseNote() {
            const noteText = document.getElementById('conciseNoteText').value.trim();
            const errorDiv = document.getElementById('noteError');
            const successDiv = document.getElementById('noteSuccess');
            
            // Hide previous messages
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            fetch(`/api/concise-notes/${ticker}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    note: noteText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    errorDiv.textContent = data.error;
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // Show success message
                successDiv.textContent = 'Notes saved successfully!';
                successDiv.style.display = 'block';
                
                // Update last updated timestamp
                if (data.updated_at) {
                    document.getElementById('noteLastUpdated').textContent = `Last updated: ${new Date(data.updated_at).toLocaleString()}`;
                }
                
                // Hide success message after 3 seconds
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);
            })
            .catch(error => {
                errorDiv.textContent = 'Error saving notes: ' + error.message;
                errorDiv.style.display = 'block';
            });
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadTickerDetails();
            loadCharts();
            loadComments();
            loadConciseNote();
            loadFlags();
            fetchNews();
        });

        function fetchNews() {
            fetch(`/api/finviz-news/${ticker}`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('newsLoading').style.display = 'none';
                    if (data.error) {
                        document.getElementById('newsError').textContent = data.error;
                        document.getElementById('newsError').style.display = 'block';
                        return;
                    }
                    if (!data.length) {
                        document.getElementById('newsError').textContent = 'No news found';
                        document.getElementById('newsError').style.display = 'block';
                        return;
                    }
                    const tbody = document.querySelector('#newsTable tbody');
                    data.slice(0, 15).forEach(item => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td style="white-space:nowrap;">${item.date} ${item.time}</td><td><a href="${item.url}" target="_blank">${item.headline}</a></td>`;
                        tbody.appendChild(tr);
                    });
                    document.getElementById('newsTable').style.display = 'table';
                })
                .catch(err => {
                    document.getElementById('newsLoading').style.display = 'none';
                    document.getElementById('newsError').textContent = err.message;
                    document.getElementById('newsError').style.display = 'block';
                });
        }
    </script>
    <!-- Chat script and modal -->
    <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chatModalLabel">Stocks-Assist Chatbot</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height:500px; overflow-y:auto;" id="chatMessages">
                </div>
                <div class="modal-footer d-flex">
                    <input type="text" class="form-control" id="chatInput" placeholder="Ask me anything..." autocomplete="off" />
                    <button class="btn btn-primary ms-2" id="sendChatBtn">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='chat.js') }}"></script>
</body>
</html> 