<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ ticker }} - Stock Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            background-color: #ffffff;
            color: #212529;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
        }
        
        /* Compact ticker symbol and company name */
        .ticker-symbol {
            font-size: 1.25rem;
            font-weight: bold;
            color: #198754;
            margin-bottom: 2px;
        }
        
        .company-name {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0;
        }
        
        /* Compact stock details info styling */
        .compact-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: #6c757d;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .info-value {
            color: #212529;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: right;
        }
        
        .current-price {
            font-size: 0.9rem;
            font-weight: bold;
            color: #198754;
        }
        
        .price-change {
            font-size: 1rem;
            font-weight: 600;
        }
        
        .price-up {
            color: #00ff41;
        }
        
        .price-down {
            color: #ff0040;
        }
        
        .chart-container {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
        }
        
        .chart-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #198754;
        }
        
        .candlestick.up {
            fill: #198754;
            stroke: #198754;
        }
        
        .candlestick.down {
            fill: #dc3545;
            stroke: #dc3545;
        }
        
        .wick.up {
            stroke: #198754;
        }
        
        .wick.down {
            stroke: #dc3545;
        }
        
        .volume-bar.up {
            fill: rgba(25, 135, 84, 0.3);
            stroke: rgba(25, 135, 84, 0.5);
        }
        
        .volume-bar.down {
            fill: rgba(220, 53, 69, 0.3);
            stroke: rgba(220, 53, 69, 0.5);
        }
        
        .axis line, .axis path {
            stroke: #6c757d;
        }
        
        .axis text {
            fill: #6c757d;
            font-size: 11px;
        }
        
        .grid line {
            stroke: #dee2e6;
            stroke-opacity: 0.5;
        }
        
        .tooltip {
            position: absolute;
            padding: 12px;
            background: rgba(255, 255, 255, 0.95);
            color: #212529;
            border: 1px solid #198754;
            border-radius: 8px;
            pointer-events: none;
            font-size: 13px;
            line-height: 1.5;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
        }
        
        .error-message {
            color: #dc3545;
            text-align: center;
            padding: 20px;
            font-size: 1.1rem;
        }
        
        .btn-back {
            background: #198754;
            border: none;
            color: #ffffff;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-back:hover {
            background: #157347;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(25, 135, 84, 0.3);
            color: #ffffff;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Stocks Assist</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Return1D">1D Returns</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Return5D">5D Returns</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Return20D">20D Returns</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Return60D">60D Returns</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Return120D">120D Returns</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Gapper">Gapper Screen</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Volume">Volume Screen</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/AllReturns">All Returns</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/AbiShortList">Abi ShortList</a>
                    </li>
                </ul>
                <span class="navbar-text me-3">
                    <small>lastTrade: <span id="navbarLatestDate">Loading...</span></small>
                </span>
                <div>
                    <button class="btn btn-back" onclick="window.history.back()">‚Üê Back</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Top Section -->
        <div class="row mb-4">
            <!-- Left Section - Ticker Info (25%) -->
            <div class="col-md-3">
                <!-- Compact Header -->
                <div class="mb-2">
                    <h4 class="ticker-symbol" id="tickerSymbol">{{ ticker }}</h4>
                    <small class="company-name" id="companyName">Loading...</small>
                </div>

                <!-- Stock Details Card -->
                <div class="card">
                    <div class="card-body p-2">
                        <h6 class="card-title mb-2 fs-6">Details</h6>
                        <div class="compact-info">
                            <div class="info-item">
                                <span class="info-label">Price</span>
                                <span class="info-value current-price" id="currentPrice">$--</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Market Cap</span>
                                <span class="info-value" id="marketCap">--</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Volume</span>
                                <span class="info-value" id="volume">--</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Sector</span>
                                <span class="info-value" id="sector">--</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Industry</span>
                                <span class="info-value" id="industry">--</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Shortlist Button -->
                <div class="mt-3">
                    <button type="button" class="btn btn-outline-success btn-sm w-100" id="shortlistBtn" onclick="toggleShortlist()">
                        <span id="shortlistIcon">+</span> <span id="shortlistText">Add to ShortList</span>
                    </button>
                </div>
            </div>

            <!-- Right Section - Comments (75%) -->
            <div class="col-md-9">
                <!-- User Comments Card -->
                <div class="card mb-4">
                    <div class="card-body p-2">
                        <h6 class="card-title mb-2 fs-6">User Comments</h6>
                        
                        <!-- Add Comment Form -->
                        <div class="mb-2">
                            <textarea class="form-control form-control-sm" id="commentText" rows="1" placeholder="Add comment..."></textarea>
                            <button type="button" class="btn btn-success btn-sm mt-1" onclick="addComment()">Add</button>
                            <div id="commentError" class="text-danger small mt-1" style="display: none;"></div>
                        </div>
                        
                        <!-- Comments List -->
                        <div id="commentsContainer">
                            <div id="loadingComments" class="text-center py-1">
                                <div class="spinner-border spinner-border-sm text-success" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <div id="commentsError" class="error-message small" style="display: none;"></div>
                            <div id="commentsList"></div>
                        </div>
                    </div>
                </div>

                <!-- AI Comments Card -->
                <div class="card">
                    <div class="card-body p-2">
                        <h6 class="card-title mb-2 fs-6">AI Analysis</h6>
                        
                        <!-- Fetch AI Comments Button -->
                        <div class="mb-3">
                            <button type="button" class="btn btn-primary btn-sm" onclick="fetchAIComments()">Fetch AI Comments</button>
                        </div>
                        
                        <!-- AI Comments Input -->
                        <div id="aiCommentInput" class="mb-3" style="display: none;">
                            <div id="aiCommentDisplay" class="form-control" style="min-height: 400px; max-height: 600px; overflow-y: auto; background-color: #f8f9fa; border: 1px solid #ced4da; border-radius: 0.375rem; padding: 0.375rem 0.75rem; white-space: pre-wrap;"></div>
                            <button type="button" class="btn btn-success btn-sm mt-2" onclick="saveAIComment()">Save AI Comment</button>
                        </div>
                        
                        <!-- Pending AI Comments Review Section -->
                        <div id="pendingAIContainer" style="display: none;">
                            <small class="text-warning">‚ö†Ô∏è Pending Review</small>
                            <div id="pendingAIList"></div>
                            <hr class="my-1">
                        </div>
                        
                        <!-- AI Comments List -->
                        <div id="aiCommentsContainer">
                            <div id="aiCommentsList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Section - Charts (Full Width) -->
        <div class="row">
            <div class="col-12">
                <!-- 3-Month Chart Section -->
                <div class="chart-container">
                    <div class="chart-title" id="chart3MonthTitle">{{ ticker }} - 3 Month Price Chart</div>
                    <div id="loadingChart3Month" class="loading-spinner">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading 3-month chart...</span>
                        </div>
                    </div>
                    <div id="errorMessage3Month" class="error-message" style="display: none;"></div>
                    <div id="chart3Month"></div>
                </div>

                <!-- Yearly Chart Section -->
                <div class="chart-container">
                    <div class="chart-title" id="chartYearlyTitle">{{ ticker }} - Yearly Price Chart</div>
                    <div id="loadingChartYearly" class="loading-spinner">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading yearly chart...</span>
                        </div>
                    </div>
                    <div id="errorMessageYearly" class="error-message" style="display: none;"></div>
                    <div id="chartYearly"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='navbar-date.js') }}"></script>
    <script>
        const ticker = '{{ ticker }}';
        
        // Load ticker details
        function loadTickerDetails() {
            fetch(`/api/stock/${ticker}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    document.getElementById('companyName').textContent = data.company_name || 'N/A';
                    document.getElementById('currentPrice').textContent = data.close_price ? `$${data.close_price.toFixed(2)}` : '$--';
                    document.getElementById('marketCap').textContent = formatMarketCap(data.market_cap);
                    document.getElementById('volume').textContent = formatVolume(data.volume);
                    document.getElementById('sector').textContent = data.sector || 'N/A';
                    document.getElementById('industry').textContent = data.industry || 'N/A';
                })
                .catch(error => {
                    console.error('Error loading ticker details:', error);
                    document.getElementById('companyName').textContent = 'Error loading data';
                });
        }
        
        // Load and create both charts
        function loadCharts() {
            fetch(`/api/stock/${ticker}/prices`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Hide loading indicators
                    document.getElementById('loadingChart3Month').style.display = 'none';
                    document.getElementById('loadingChartYearly').style.display = 'none';
                    
                    // Create both charts
                    create3MonthChart(data);
                    createYearlyChart(data);
                })
                .catch(error => {
                    console.error('Error loading chart data:', error);
                    document.getElementById('loadingChart3Month').style.display = 'none';
                    document.getElementById('loadingChartYearly').style.display = 'none';
                    document.getElementById('errorMessage3Month').style.display = 'block';
                    document.getElementById('errorMessage3Month').textContent = `Error loading charts: ${error.message}`;
                    document.getElementById('errorMessageYearly').style.display = 'block';
                    document.getElementById('errorMessageYearly').textContent = `Error loading charts: ${error.message}`;
                });
        }
        
        function create3MonthChart(priceData) {
            // Filter data for last 3 months
            const now = new Date();
            const threeMonthsAgo = new Date(now.getTime() - (90 * 24 * 60 * 60 * 1000));
            const filteredData = priceData.filter(d => new Date(d.date) >= threeMonthsAgo);
            
            createChart(filteredData, 'chart3Month', 'chart3MonthTitle', '3-Month');
        }

        function createYearlyChart(priceData) {
            createChart(priceData, 'chartYearly', 'chartYearlyTitle', 'Yearly');
        }

        function createChart(priceData, containerId, titleId, chartType) {
            // Configuration
            const margin = {top: 20, right: 90, bottom: 100, left: 20};
            const volumeHeight = 80;
            const width = Math.min(1140, window.innerWidth - 100) - margin.left - margin.right;
            const height = 500; // Price section is exactly 500px tall

            // Process the data
            const data = priceData.map(d => {
                // Parse date as local date to avoid timezone shift
                // Split the date string and create date in local timezone
                const dateParts = d.date.split('-');
                const localDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                
                return {
                    date: localDate,
                    open: +d.open_price,
                    high: +d.high_price,
                    low: +d.low_price,
                    close: +d.close_price,
                    volume: +d.volume
                };
            }).filter(d => 
                !isNaN(d.date.getTime()) && 
                !isNaN(d.open) && 
                !isNaN(d.high) && 
                !isNaN(d.low) && 
                !isNaN(d.close) &&
                !isNaN(d.volume)
            ).sort((a, b) => a.date - b.date);

            if (data.length === 0) {
                document.getElementById(containerId.replace('chart', 'errorMessage')).style.display = 'block';
                document.getElementById(containerId.replace('chart', 'errorMessage')).textContent = 'No valid price data available';
                return;
            }

            // Create SVG
            const svg = d3.select(`#${containerId}`)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + volumeHeight + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Create tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // Format functions
            const formatPrice = d3.format("$,.2f");
            const formatVolume = d3.format(",.0f");
            const formatDate = d3.timeFormat("%B %d, %Y");
            const formatAxisDate = d3.timeFormat("%Y/%m/%d");

            // Set scales
            const x = d3.scaleBand()
                .domain(data.map(d => d.date))
                .range([0, width - 10])
                .padding(0.2);

            const y = d3.scaleLinear()
                .domain([
                    d3.min(data, d => d.low) * 0.995,
                    d3.max(data, d => d.high) * 1.005
                ])
                .range([height, 0]);

            const yVolume = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.volume)])
                .range([height + volumeHeight, height]);

            // Add axes
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0,${height + volumeHeight})`)
                .call(d3.axisBottom(x)
                    .tickFormat(d => formatAxisDate(d))
                    .tickValues(x.domain().filter((d, i) => i % Math.max(1, Math.floor(data.length / 10)) === 0)));

            svg.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(${width},0)`)
                .call(d3.axisRight(y)
                    .tickFormat(d => formatPrice(d)));

            svg.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(${width},0)`)
                .call(d3.axisRight(yVolume)
                    .tickFormat(d => formatVolume(d/1000000) + "M")
                    .ticks(3));

            // Add grid
            svg.append("g")
                .attr("class", "grid")
                .attr("transform", `translate(${width},0)`)
                .call(d3.axisRight(y)
                    .tickSize(-width)
                    .tickFormat(""));

            // Add volume bars
            svg.selectAll("rect.volume-bar")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", d => `volume-bar ${d.close >= d.open ? "up" : "down"}`)
                .attr("x", d => x(d.date))
                .attr("y", d => yVolume(d.volume))
                .attr("width", x.bandwidth())
                .attr("height", d => yVolume(0) - yVolume(d.volume));

            // Add candlesticks
            svg.selectAll("g.candlestick")
                .data(data)
                .enter()
                .append("g")
                .attr("class", "candlestick")
                .each(function(d) {
                    const g = d3.select(this);
                    const isUp = d.close >= d.open;
                    const className = isUp ? "up" : "down";
                    
                    // Draw the wick
                    g.append("line")
                        .attr("class", `wick ${className}`)
                        .attr("x1", x(d.date) + x.bandwidth()/2)
                        .attr("x2", x(d.date) + x.bandwidth()/2)
                        .attr("y1", y(d.high))
                        .attr("y2", y(d.low));
                    
                    // Draw the body
                    g.append("rect")
                        .attr("class", `candlestick ${className}`)
                        .attr("x", x(d.date))
                        .attr("y", y(Math.max(d.open, d.close)))
                        .attr("width", x.bandwidth())
                        .attr("height", Math.max(1, Math.abs(y(d.open) - y(d.close))));
                })
                .on("mouseover", function(event, d) {
                    const pctChange = ((d.close - d.open) / d.open * 100).toFixed(2);
                    const sign = pctChange >= 0 ? "+" : "";
                    
                    tooltip.transition()
                        .duration(100)
                        .style("opacity", .9);
                    tooltip.html(
                        `<strong>${formatDate(d.date)}</strong><br/>` +
                        `Open: ${formatPrice(d.open)}<br/>` +
                        `High: ${formatPrice(d.high)}<br/>` +
                        `Low: ${formatPrice(d.low)}<br/>` +
                        `Close: ${formatPrice(d.close)}<br/>` +
                        `Volume: ${formatVolume(d.volume)}<br/>` +
                        `Change: ${sign}${pctChange}%`
                    )
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", 0);
                });

            // Update chart title with date range
            if (data.length > 0) {
                const startDate = d3.timeFormat("%b %d, %Y")(data[0].date);
                const endDate = d3.timeFormat("%b %d, %Y")(data[data.length - 1].date);
                document.getElementById(titleId).textContent = `${ticker} ${chartType} Price Chart (${startDate} - ${endDate})`;
            }
        }
        
        function formatMarketCap(marketCap) {
            if (!marketCap) return 'N/A';
            if (marketCap >= 1000000000) {
                return `$${(marketCap / 1000000000).toFixed(1)}B`;
            } else if (marketCap >= 1000000) {
                return `$${(marketCap / 1000000).toFixed(0)}M`;
            } else {
                return `$${marketCap.toLocaleString()}`;
            }
        }
        
        function formatVolume(volume) {
            if (!volume) return 'N/A';
            if (volume >= 1000000) {
                return `${(volume / 1000000).toFixed(1)}M`;
            } else if (volume >= 1000) {
                return `${(volume / 1000).toFixed(0)}K`;
            } else {
                return volume.toLocaleString();
            }
        }
        
        // Comments functions
        function loadComments() {
            fetch(`/api/comments/${ticker}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loadingComments').style.display = 'none';
                    
                    if (data.error) {
                        document.getElementById('commentsError').style.display = 'block';
                        document.getElementById('commentsError').textContent = data.error;
                        return;
                    }
                    
                    displayComments(data);
                })
                .catch(error => {
                    console.error('Error loading comments:', error);
                    document.getElementById('loadingComments').style.display = 'none';
                    document.getElementById('commentsError').style.display = 'block';
                    document.getElementById('commentsError').textContent = 'Error loading comments';
                });
        }
        
        function displayComments(comments) {
            const commentsList = document.getElementById('commentsList');
            const aiCommentsList = document.getElementById('aiCommentsList');
            
            // Separate user and AI comments
            const userComments = comments.filter(c => c.comment_type === 'user');
            const aiComments = comments.filter(c => c.comment_type === 'ai' && c.status === 'approved');
            
            // Display user comments
            if (userComments.length === 0) {
                commentsList.innerHTML = '<div class="text-muted text-center py-1">No comments yet. Be the first to add one!</div>';
            } else {
                commentsList.innerHTML = userComments.map(comment => `
                    <div class="card mb-1" id="comment-${comment.id}">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <p class="card-text mb-0 small flex-grow-1">${escapeHtml(comment.comment_text)} <span class="text-muted">‚Äî ${comment.formatted_date}</span></p>
                                <div class="btn-group btn-group-sm ms-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="editComment(${comment.id})">Edit</button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteComment(${comment.id})">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            // Display AI comments
            if (aiComments.length === 0) {
                aiCommentsList.innerHTML = '<div class="text-muted text-center py-1">No AI analysis available yet.</div>';
            } else {
                aiCommentsList.innerHTML = aiComments.map(comment => `
                    <div class="card mb-1" id="comment-${comment.id}">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="card-text mb-0 small flex-grow-1" style="white-space: pre-wrap;">${renderAICommentContent(comment.comment_text)} <span class="text-muted">‚Äî ${comment.formatted_date}</span></div>
                                <div class="btn-group btn-group-sm ms-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="editComment(${comment.id})">Edit</button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteComment(${comment.id})">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function renderAICommentContent(content) {
            // Convert markdown-style formatting to HTML and preserve hyperlinks
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Bold
                .replace(/\n/g, '<br>');  // Line breaks
            // Note: Hyperlinks are already in HTML format from the backend processing
        }
        
        function editComment(commentId) {
            const commentElement = document.getElementById(`comment-${commentId}`);
            const currentText = commentElement.querySelector('.card-text').textContent.split('‚Äî')[0].trim();
            
            // Create edit form
            const editForm = `
                <div class="card-body p-2">
                    <textarea class="form-control form-control-sm mb-2">${currentText}</textarea>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-success btn-sm" onclick="saveEdit(${commentId})">Save</button>
                        <button class="btn btn-secondary btn-sm" onclick="cancelEdit(${commentId})">Cancel</button>
                    </div>
                </div>
            `;
            
            commentElement.innerHTML = editForm;
        }

        function saveEdit(commentId) {
            const commentElement = document.getElementById(`comment-${commentId}`);
            const newText = commentElement.querySelector('textarea').value.trim();
            
            if (!newText) {
                alert('Comment cannot be empty');
                return;
            }
            
            fetch(`/api/comments/${commentId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    comment_text: newText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                loadComments(); // Reload all comments
            })
            .catch(error => {
                console.error('Error saving edit:', error);
                alert('Error saving edit: ' + error.message);
            });
        }

        function cancelEdit(commentId) {
            loadComments(); // Reload all comments to restore original state
        }

        function deleteComment(commentId) {
            if (!confirm('Are you sure you want to delete this comment?')) {
                return;
            }
            
            fetch(`/api/comments/${commentId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                loadComments(); // Reload all comments
            })
            .catch(error => {
                console.error('Error deleting comment:', error);
                alert('Error deleting comment: ' + error.message);
            });
        }
        
        function addComment() {
            const commentText = document.getElementById('commentText').value.trim();
            const errorDiv = document.getElementById('commentError');
            
            // Clear any previous errors
            errorDiv.style.display = 'none';
            
            if (!commentText) {
                errorDiv.textContent = 'Please enter a comment';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Disable button during submission
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Adding...';
            
            fetch(`/api/comments/${ticker}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    comment_text: commentText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    errorDiv.textContent = data.error;
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // Clear the text area and reload comments
                document.getElementById('commentText').value = '';
                loadComments();
            })
            .catch(error => {
                console.error('Error adding comment:', error);
                errorDiv.textContent = 'Error adding comment';
                errorDiv.style.display = 'block';
            })
            .finally(() => {
                // Re-enable button
                button.disabled = false;
                button.textContent = 'Add Comment';
            });
        }
        
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;")
                .replace(/\n/g, "<br>");
        }

        // Add these functions before the DOMContentLoaded event listener
        function fetchAIComments() {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Fetching...';
            
            fetch('/api/perplexity', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ticker: ticker
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Show the input area with the AI response
                document.getElementById('aiCommentInput').style.display = 'block';
                
                // Get the display div and set the HTML content
                const aiCommentDisplay = document.getElementById('aiCommentDisplay');
                
                // Convert markdown-style formatting to HTML
                let htmlContent = data.response
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Bold
                    .replace(/\n/g, '<br>');  // Line breaks
                
                aiCommentDisplay.innerHTML = htmlContent;
                
                // Store the original content for saving
                window.aiCommentContent = data.response;
            })
            .catch(error => {
                console.error('Error fetching AI comments:', error);
                alert('Error fetching AI comments: ' + error.message);
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = 'Fetch AI Comments';
            });
        }
        
        function saveAIComment() {
            // Use the stored content instead of trying to get it from a textarea
            const commentText = window.aiCommentContent;
            
            if (!commentText) {
                alert('No AI comment to save');
                return;
            }
            
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Saving...';
            
            fetch(`/api/ai-comments/${ticker}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    comment_text: commentText,
                    ai_source: 'perplexity'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Clear and hide the input area
                const aiCommentDisplay = document.getElementById('aiCommentDisplay');
                if (aiCommentDisplay) {
                    aiCommentDisplay.innerHTML = '';
                }
                document.getElementById('aiCommentInput').style.display = 'none';
                window.aiCommentContent = null;
                
                // Reload comments to show the new AI comment
                loadComments();
            })
            .catch(error => {
                console.error('Error saving AI comment:', error);
                alert('Error saving AI comment: ' + error.message);
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = 'Save AI Comment';
            });
        }

        // Shortlist functionality
        function checkShortlistStatus() {
            fetch(`/api/shortlist/${ticker}/check`)
                .then(response => response.json())
                .then(data => {
                    const btn = document.getElementById('shortlistBtn');
                    const icon = document.getElementById('shortlistIcon');
                    const text = document.getElementById('shortlistText');
                    
                    if (data.in_shortlist) {
                        btn.className = 'btn btn-success btn-sm w-100';
                        icon.textContent = '‚úì';
                        text.textContent = 'In ShortList';
                    } else {
                        btn.className = 'btn btn-outline-success btn-sm w-100';
                        icon.textContent = '+';
                        text.textContent = 'Add to ShortList';
                    }
                })
                .catch(error => {
                    console.error('Error checking shortlist status:', error);
                });
        }
        
        function toggleShortlist() {
            const btn = document.getElementById('shortlistBtn');
            const icon = document.getElementById('shortlistIcon');
            const text = document.getElementById('shortlistText');
            
            // Check current status
            const isInShortlist = btn.className.includes('btn-success');
            
            if (isInShortlist) {
                // Remove from shortlist
                fetch(`/api/shortlist/${ticker}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error removing from shortlist: ' + data.error);
                        return;
                    }
                    
                    btn.className = 'btn btn-outline-success btn-sm w-100';
                    icon.textContent = '+';
                    text.textContent = 'Add to ShortList';
                    
                    // Show success message briefly
                    const originalText = text.textContent;
                    text.textContent = 'Removed!';
                    setTimeout(() => {
                        text.textContent = originalText;
                    }, 1500);
                })
                .catch(error => {
                    alert('Error removing from shortlist: ' + error.message);
                });
            } else {
                // Add to shortlist
                const notes = prompt('Optional notes for this stock (leave blank if none):') || '';
                
                fetch('/api/shortlist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tickers: [ticker],
                        notes: notes
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error adding to shortlist: ' + data.error);
                        return;
                    }
                    
                    btn.className = 'btn btn-success btn-sm w-100';
                    icon.textContent = '‚úì';
                    text.textContent = 'In ShortList';
                    
                    // Show success message briefly
                    const originalText = text.textContent;
                    text.textContent = 'Added!';
                    setTimeout(() => {
                        text.textContent = originalText;
                    }, 1500);
                })
                .catch(error => {
                    alert('Error adding to shortlist: ' + error.message);
                });
            }
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadTickerDetails();
            loadCharts();
            loadComments();
            checkShortlistStatus();
        });
    </script>
</body>
</html> 