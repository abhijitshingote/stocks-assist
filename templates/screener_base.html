{% extends "base.html" %}

{% block content %}

            <div>
                <button type="button" class="btn btn-success btn-sm me-2" id="commitFlagsBtn" onclick="commitFlags()" style="display: none;">
                    <i class="fas fa-save"></i> Commit Flags (0)
                </button>

            </div>

<!-- Above 200M Section -->
<div class="mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="text-primary mb-0">Above $200M Market Cap</h2>
            <p class="text-muted mb-0" id="subtitleAbove"></p>
        </div>
        <button type="button" class="btn btn-outline-primary btn-sm select-all-btn" onclick="selectAllAbove()">
            Select All Above 200M
        </button>
    </div>
    
    <div id="loading-above" class="loading">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Loading stocks above $200M...</p>
    </div>
    
    <div id="error-above" class="error" style="display: none;"></div>
    
    <div id="results-above" style="display: none;">
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead class="table-dark sticky-top" id="tableHeaderAbove">
                    <!-- Table header will be generated by JavaScript -->
                </thead>
                <tbody id="stockTableBodyAbove">
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="section-divider"></div>

<!-- Below 200M Section -->
<div class="mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="text-success mb-0">Below $200M Market Cap</h2>
            <p class="text-muted mb-0" id="subtitleBelow"></p>
        </div>
        <button type="button" class="btn btn-outline-success btn-sm select-all-btn" onclick="selectAllBelow()">
            Select All Below 200M
        </button>
    </div>
    
    <div id="loading-below" class="loading">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Loading stocks below $200M...</p>
    </div>
    
    <div id="error-below" class="error" style="display: none;"></div>
    
    <div id="results-below" style="display: none;">
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead class="table-dark sticky-top" id="tableHeaderBelow">
                    <!-- Table header will be generated by JavaScript -->
                </thead>
                <tbody id="stockTableBodyBelow">
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Page configuration - to be overridden by individual pages
    let pageConfig = {
        type: 'returns',
        returnDays: '',
        apiAbove: '',
        apiBelow: ''
    };

    // Global subtitle helpers
    const RETURN_THRESHOLDS = {1:5,5:10,20:15,60:20,120:30};
    let thresholdPct = null;
    let countAboveVal = null;
    let countBelowVal = null;

    function updateSubtitles() {
        const descEl = document.getElementById('pageDescription');
        if (!descEl) return;

        const thresholdStr = thresholdPct !== null ? thresholdPct + '%' : '';
        const aboveStr = countAboveVal !== null ? countAboveVal : '...';
        const belowStr = countBelowVal !== null ? countBelowVal : '...';

        let text = '';
        if (pageConfig.type === 'returns' && thresholdStr) {
            text += `Threshold applied - ${thresholdStr}. `;
        } else if (pageConfig.type === 'sea_change') {
            text += `SeaChange Criteria: Dollar Volume >$200M, Volume >3x 20D avg, Low >5% above prev close OR Close >15% above prev close (Last 120 days). `;
        }
        text += `Count Above 200M: ${aboveStr}  Below 200M: ${belowStr}`;

        descEl.textContent = text;
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
        loadStocksAbove();
        loadStocksBelow();
    });

    function initializePage() {
        const columns = COLUMN_CONFIGS[pageConfig.type].columns;
        
        // Set the return period label for returns pages
        if (pageConfig.type === 'returns' && pageConfig.returnDays) {
            const returnColumn = columns.find(col => col.key === 'price_change_pct');
            if (returnColumn) {
                returnColumn.label = `${pageConfig.returnDays} Return`;
            }
        }
        
        // Generate table headers
        document.getElementById('tableHeaderAbove').innerHTML = generateTableHeader(columns);
        document.getElementById('tableHeaderBelow').innerHTML = generateTableHeaderBelow(columns);

        // Determine threshold based on page configuration
        function determineThreshold() {
            if (pageConfig.type === 'returns') {
                const days = parseInt(pageConfig.returnDays);
                thresholdPct = RETURN_THRESHOLDS[days] || null;
            } else {
                thresholdPct = null;
            }
        }

        determineThreshold();
    }

    function loadStocksAbove() {
        const loading = document.getElementById('loading-above');
        const error = document.getElementById('error-above');
        const results = document.getElementById('results-above');
        
        loading.style.display = 'block';
        error.style.display = 'none';
        results.style.display = 'none';
        
        fetch(pageConfig.apiAbove)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                loading.style.display = 'none';
                
                if (data.error) {
                    error.textContent = data.error;
                    error.style.display = 'block';
                    return;
                }
                
                // For SeaChange page, sort by latest event date before display
                if (pageConfig.type === 'sea_change') {
                    data = sortStockData(data, 'sea_change_events', 'desc');
                }
                displayStocks(data, 'stockTableBodyAbove');
                results.style.display = 'block';
                countAboveVal = data.length;
                updateSubtitles();
            })
            .catch(err => {
                loading.style.display = 'none';
                error.textContent = 'Error loading stocks: ' + err.message;
                error.style.display = 'block';
            });
    }

    function loadStocksBelow() {
        const loading = document.getElementById('loading-below');
        const error = document.getElementById('error-below');
        const results = document.getElementById('results-below');
        
        loading.style.display = 'block';
        error.style.display = 'none';
        results.style.display = 'none';
        
        fetch(pageConfig.apiBelow)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                loading.style.display = 'none';
                
                if (data.error) {
                    error.textContent = data.error;
                    error.style.display = 'block';
                    return;
                }
                
                // For SeaChange page, sort by latest event date before display
                if (pageConfig.type === 'sea_change') {
                    data = sortStockData(data, 'sea_change_events', 'desc');
                }
                displayStocks(data, 'stockTableBodyBelow');
                results.style.display = 'block';
                countBelowVal = data.length;
                updateSubtitles();
            })
            .catch(err => {
                loading.style.display = 'none';
                error.textContent = 'Error loading stocks: ' + err.message;
                error.style.display = 'block';
            });
    }

    // displayStocks function is now defined in base.html with sorting support
</script>
{% endblock %} 