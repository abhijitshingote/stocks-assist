<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ ticker }} - Stock Detail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Use v4.x where addCandlestickSeries API is available -->
    <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        /* Chart container and headings */
        .chart-container {
            background: #ffffff;
            border: none;
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
        }
        .chart-title {
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #198754;
        }

        /* Candlestick colours */
        .candlestick.up {
            fill: #198754;
            stroke: #198754;
        }
        .candlestick.down {
            fill: #dc3545;
            stroke: #dc3545;
        }
        .wick.up { stroke: #198754; }
        .wick.down { stroke: #dc3545; }

        /* Volume bars */
        .volume-bar.up {
            fill: rgba(25, 135, 84, 0.3);
            stroke: rgba(25, 135, 84, 0.5);
        }
        .volume-bar.down {
            fill: rgba(220, 53, 69, 0.3);
            stroke: rgba(220, 53, 69, 0.5);
        }

        /* Earnings legend */
        .earnings-legend {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .earnings-legend h6 {
            margin: 0 0 8px 0;
            color: #198754;
            font-weight: 600;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            font-size: 0.85rem;
        }
        .legend-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }
        .legend-marker.confirmed { background-color: #000000; }
        .legend-marker.estimated { background-color: #000000; }

        /* Axis + grid */
        .axis line, .axis path { stroke: #6c757d; }
        .axis text { fill: #6c757d; font-size: 11px; }
        .grid line { stroke: #dee2e6; stroke-opacity: 0.5; }

        /* Tooltip */
        .tooltip {
            position: absolute;
            padding: 12px;
            background: rgba(255, 255, 255, 0.95);
            color: #212529;
            border: 1px solid #198754;
            border-radius: 8px;
            pointer-events: none;
            font-size: 13px;
            line-height: 1.5;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        /* Enhanced Comment Styling */
        .user-comment {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            border-left: 4px solid #198754;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }

        .user-comment:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .ai-comment {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            border: none;
            border-left: 4px solid #0d6efd;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }

        .ai-comment:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .comment-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .comment-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
        }

        .user-avatar {
            background: linear-gradient(135deg, #198754, #20c997);
        }

        .ai-avatar {
            background: linear-gradient(135deg, #0d6efd, #6610f2);
        }

        .comment-content {
            line-height: 1.6;
            color: #495057;
            font-size: 0.9rem;
        }

        .ai-comment .comment-content {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }

        .comment-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .comment-date {
            font-size: 0.75rem;
            color: #6c757d;
            font-style: italic;
        }

        .comment-actions {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .user-comment:hover .comment-actions,
        .ai-comment:hover .comment-actions {
            opacity: 1;
        }

        .comment-actions .btn {
            padding: 2px 8px;
            font-size: 0.7rem;
            border-radius: 6px;
            margin-left: 4px;
        }

        .ai-source-badge {
            background: linear-gradient(135deg, #6610f2, #e83e8c);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 500;
            margin-left: 8px;
        }

        .no-comments-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #dee2e6;
        }

        /* AI content specific styling */
        .ai-comment .comment-content h1,
        .ai-comment .comment-content h2,
        .ai-comment .comment-content h3,
        .ai-comment .comment-content h4 {
            color: #0d6efd;
            margin-top: 16px;
            margin-bottom: 8px;
        }

        .ai-comment .comment-content strong {
            color: #0d6efd;
        }
    </style>
    <style>
        /* Remove table outer border while keeping inner borders */
        .stock-info-table {
            border-collapse: collapse;
        }
        .stock-info-table td, .stock-info-table th {
            border: 1px solid #dee2e6;
        }
        .stock-info-table tr:first-child td {
            border-top: 0;
        }
        .stock-info-table tr:last-child td {
            border-bottom: 0;
        }
        .stock-info-table tr td:first-child,
        .stock-info-table tr th:first-child {
            border-left: 0;
        }
        .stock-info-table tr td:last-child,
        .stock-info-table tr th:last-child {
            border-right: 0;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Stocks Assist</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Return1D">1D Returns</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Return5D">5D Returns</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Return20D">20D Returns</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Return60D">60D Returns</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Return120D">120D Returns</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Gapper">Gapper Screen</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/Volume">Volume Screen</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/SeaChange">SeaChange</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/AllReturns">All Returns</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/AbiShortList">Abi ShortList</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/AbiBlackList">Abi BlackList</a>
                    </li>
                </ul>
                <!-- Rewind Date Selector -->
                <div class="navbar-text me-3">
                    <small>
                        <label for="rewindDate" class="form-label text-white-50 me-1">Rewind to:</label>
                        <input type="date" id="rewindDate" class="form-control form-control-sm d-inline-block" style="width: auto;" title="View data as of this date">
                        <button id="clearRewind" class="btn btn-outline-secondary btn-sm ms-1" title="Clear rewind and view latest data">
                            <i class="fas fa-times"></i>
                        </button>
                    </small>
                </div>

                <!-- Chat trigger -->
                <button class="btn btn-outline-info me-2" type="button" data-bs-toggle="modal" data-bs-target="#chatModal" title="Chatbot">
                    <i class="fas fa-comments"></i>
                </button>

                <span class="navbar-text" id="market-status"><small id="navbarLatestDate"></small></span>
                <div>
                    <button class="btn btn-back" onclick="window.history.back()">← Back</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Stock Information Table -->
        <div class="row mb-2">
            <div class="col-12">
                <div class="card border-0">
                    <div class="card-body p-1">
                        <table class="table table-sm table-bordered mb-0 stock-info-table">
                            <tbody>
                                <tr>
                                    <td class="bg-light text-muted fw-semibold" style="width: 10%; padding: 0.1rem 0.2rem;">Symbol</td>
                                    <td style="width: 8%; padding: 0.1rem 0.2rem;">
                                        <span class="fw-bold text-success">{{ ticker }}</span>
                                    </td>
                                    <td class="bg-light text-muted fw-semibold" style="width: 10%; padding: 0.1rem 0.2rem;">Company</td>
                                    <td style="width: 22%; padding: 0.1rem 0.2rem;" id="companyName">Loading...</td>
                                    <td class="bg-light text-muted fw-semibold" style="width: 10%; padding: 0.1rem 0.2rem;">Price</td>
                                    <td style="width: 18%; padding: 0.1rem 0.2rem;">
                                        <span class="fw-bold text-success" id="currentPrice">$--</span>
                                        <span class="ms-1" id="priceChange">--</span>
                                    </td>
                                    <td class="bg-light text-muted fw-semibold" style="width: 10%; padding: 0.1rem 0.2rem;">52Wk Range</td>
                                    <td style="width: 12%; padding: 0.1rem 0.2rem;" id="week52Range">--</td>
                                </tr>
                                <tr>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Sector</td>
                                    <td style="padding: 0.1rem 0.2rem;">
                                        <span class="fw-bold text-primary" id="sector">--</span>
                                    </td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Industry</td>
                                    <td style="padding: 0.1rem 0.2rem;" id="industry">--</td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Country</td>
                                    <td style="padding: 0.1rem 0.2rem;">
                                        <span class="badge bg-info" id="country">--</span>
                                    </td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Market Cap</td>
                                    <td style="padding: 0.1rem 0.2rem;">
                                        <span class="badge bg-warning text-dark" id="marketCap">--</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Volume</td>
                                    <td style="padding: 0.1rem 0.2rem;" id="volume">--</td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Avg Volume</td>
                                    <td style="padding: 0.1rem 0.2rem;" id="avgVolume">--</td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Vol Change</td>
                                    <td style="padding: 0.1rem 0.2rem;">
                                        <span class="badge" id="volumeChange">--</span>
                                    </td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Shares Out</td>
                                    <td style="padding: 0.1rem 0.2rem;" id="sharesOutstanding">--</td>
                                </tr>
                                <tr>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">5D Return</td>
                                    <td style="padding: 0.1rem 0.2rem;">
                                        <span class="badge" id="return5d">--</span>
                                    </td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">20D Return</td>
                                    <td style="padding: 0.1rem 0.2rem;">
                                        <span class="badge" id="return20d">--</span>
                                    </td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">60D Return</td>
                                    <td style="padding: 0.1rem 0.2rem;">
                                        <span class="badge" id="return60d">--</span>
                                    </td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Shares Float</td>
                                    <td style="padding: 0.1rem 0.2rem;" id="sharesFloat">--</td>
                                </tr>
                                <tr>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Short Float</td>
                                    <td style="padding: 0.1rem 0.2rem;" id="shortFloat">--</td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Short Ratio</td>
                                    <td style="padding: 0.1rem 0.2rem;" id="shortRatio">--</td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Short Interest</td>
                                    <td style="padding: 0.1rem 0.2rem;" id="shortInterest">--</td>
                                    <td class="bg-light text-muted fw-semibold" style="padding: 0.1rem 0.2rem;">Flags</td>
                                    <td style="padding: 0.1rem 0.2rem;">
                                        <div class="d-flex flex-column gap-1">
                                            <div class="d-flex gap-2 align-items-center" style="font-size: 0.75rem;">
                                                <label class="form-check-label d-flex align-items-center gap-1 mb-0">
                                                    <input type="checkbox" class="form-check-input" id="reviewedCheck" style="margin: 0;">
                                                    <span>Reviewed</span>
                                                </label>
                                                <label class="form-check-label d-flex align-items-center gap-1 mb-0">
                                                    <input type="checkbox" class="form-check-input" id="shortlistCheck" style="margin: 0;">
                                                    <span>Shortlist</span>
                                                </label>
                                                <label class="form-check-label d-flex align-items-center gap-1 mb-0">
                                                    <input type="checkbox" class="form-check-input" id="blacklistCheck" style="margin: 0;">
                                                    <span>Blacklist</span>
                                                </label>
                                            </div>
                                            <div>
                                                <button type="button" class="btn btn-primary btn-sm" onclick="saveFlags()" style="padding: 0.15rem 0.5rem; font-size: 0.7rem;">
                                                    Save Flags
                                                </button>
                                            </div>
                                            <div id="flagsError" class="text-danger" style="display: none; font-size: 0.7rem;"></div>
                                            <div id="flagsSuccess" class="text-success" style="display: none; font-size: 0.7rem;"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="mt-1">
                            <a href="https://seekingalpha.com/symbol/{{ ticker }}/analysis" target="_blank" class="btn btn-outline-secondary btn-sm">
                                View analysis on Seeking Alpha ↗
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Concise Notes Section -->
        <div class="row mb-2">
            <div class="col-12">
                <div class="card border-0">
                    <div class="card-body p-1">
                        <h6 class="card-title mb-1 fs-6">Concise Notes</h6>
                        <div class="mb-2">
                            <textarea class="form-control form-control-sm fs-6" id="conciseNoteText" rows="3" placeholder="Add your concise notes about this stock..."></textarea>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <button type="button" class="btn btn-success btn-sm fs-6" onclick="saveConciseNote()">Save Notes</button>
                                <small class="text-muted" id="noteLastUpdated"></small>
                            </div>
                            <div id="noteError" class="text-danger mt-1 fs-6" style="display: none;"></div>
                            <div id="noteSuccess" class="text-success mt-1 fs-6" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Description Section -->
        <div class="row mb-2">
            <div class="col-12">
                <div class="card border-0">
                    <div class="card-body p-1">
                        <h6 class="card-title mb-1 fs-6">Description</h6>
                        <p class="mb-0 text-muted fs-6" id="description">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="row mb-2">
            <div class="col-12">
                <!-- User Comments Card -->
                <div class="card mb-2 border-0">
                    <div class="card-body p-1">
                        <h6 class="card-title mb-1 fs-6">User Comments</h6>
                        
                        <!-- Add Comment Form -->
                        <div class="mb-2">
                            <textarea class="form-control form-control-sm fs-6" id="commentText" rows="2" placeholder="Add your comment..."></textarea>
                            <button type="button" class="btn btn-success btn-sm mt-1 fs-6" onclick="addComment()">Add Comment</button>
                            <div id="commentError" class="text-danger mt-1 fs-6" style="display: none;"></div>
                        </div>
                        
                        <!-- Comments List -->
                        <div id="commentsContainer">
                            <div id="loadingComments" class="text-center py-1">
                                <div class="spinner-border spinner-border-sm text-success" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <div id="commentsError" class="error-message" style="display: none; font-size: 0.75rem;"></div>
                            <div id="commentsList"></div>
                        </div>
                    </div>
                </div>

                <!-- AI Comments Card -->
                <div class="card border-0">
                    <div class="card-body p-1">
                        <h6 class="card-title mb-1 fs-6">AI Analysis</h6>
                        
                        <!-- Fetch AI Comments Button -->
                        <div class="mb-2">
                            <button type="button" class="btn btn-primary btn-sm fs-6" onclick="fetchAIComments()">Fetch AI Analysis</button>
                        </div>
                        
                        <!-- AI Comments Input -->
                        <div id="aiCommentInput" class="mb-2" style="display: none;">
                            <div id="aiCommentDisplay" class="form-control fs-6" style="min-height: 300px; max-height: 400px; overflow-y: auto; background-color: #f8f9fa; border: 1px solid #ced4da; border-radius: 0.375rem; padding: 0.5rem; white-space: pre-wrap;"></div>
                            <button type="button" class="btn btn-success btn-sm mt-1 fs-6" onclick="saveAIComment()">Save AI Analysis</button>
                        </div>
                        
                        <!-- Pending AI Comments Review Section -->
                        <div id="pendingAIContainer" style="display: none;">
                            <small class="text-warning fs-6">⚠️ Pending Review</small>
                            <div id="pendingAIList"></div>
                            <hr class="my-1">
                        </div>
                        
                        <!-- AI Comments List -->
                        <div id="aiCommentsContainer">
                            <div id="aiCommentsList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- News Section -->
        <div class="row mb-2">
            <div class="col-12">
                <div class="card border-0">
                    <div class="card-body p-1">
                        <h6 class="card-title mb-1 fs-6">Latest News</h6>
                        <div id="newsLoading" class="text-center py-1">
                            <div class="spinner-border spinner-border-sm text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="newsError" class="text-danger fs-6" style="display:none;"></div>
                        <table class="table table-sm mb-0" id="newsTable" style="display:none;">
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Section - Charts (Full Width) -->
        <div class="row">
            <div class="col-12">
                <!-- Yearly Chart Section -->
                <div class="chart-container">
                    <div class="chart-title" id="chartYearlyTitle">{{ ticker }} - Yearly Chart</div>
                    <div style="text-align: center; font-size: 0.8rem; color: #6c757d; margin-bottom: 10px;">
                        Hold Ctrl+scroll to zoom • Hold Ctrl+drag to pan • Double-click to reset zoom
                    </div>
                    
                    <!-- Earnings Legend -->
                    <div class="earnings-legend" id="earningsLegend" style="display: none;">
                        <h6>Earnings Announcements</h6>
                        <div class="legend-item">
                            <div class="legend-marker confirmed"></div>
                            <span>Confirmed earnings dates</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker estimated"></div>
                            <span>Estimated earnings dates</span>
                        </div>
                        <div style="font-size: 0.8rem; color: #6c757d; margin-top: 4px;">
                            Hover over markers for details • Hold Ctrl+scroll to zoom • Hold Ctrl+drag to pan
                        </div>
                    </div>
                    
                    <div id="loadingChartYearly" class="loading-spinner">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading yearly chart...</span>
                        </div>
                    </div>
                    <div id="errorMessageYearly" class="error-message" style="display: none;"></div>
                    <div id="chartYearly"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="{{ url_for('static', filename='navbar-date.js') }}"></script>
    <script>
        const ticker = '{{ ticker }}';
        
        // Helper functions for rewind functionality
        function getRewindDate() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('rewind_date');
        }
        
        function appendRewindDate(apiUrl) {
            const rewindDate = getRewindDate();
            if (!rewindDate) {
                return apiUrl;
            }
            
            const url = new URL(apiUrl, window.location.origin);
            url.searchParams.set('rewind_date', rewindDate);
            return url.toString();
        }
        
        // Rewind functionality
        function initializeRewindControls() {
            const rewindInput = document.getElementById('rewindDate');
            const clearRewindBtn = document.getElementById('clearRewind');
            
            // Get current rewind date from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const currentRewindDate = urlParams.get('rewind_date');
            if (currentRewindDate) {
                rewindInput.value = currentRewindDate;
            }
            
            // Handle rewind date change
            rewindInput.addEventListener('change', function() {
                const selectedDate = this.value;
                if (selectedDate) {
                    // Add rewind_date parameter to current URL and reload
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('rewind_date', selectedDate);
                    window.location.href = newUrl.toString();
                }
            });
            
            // Handle clear rewind button
            clearRewindBtn.addEventListener('click', function() {
                // Remove rewind_date parameter from URL and reload
                const newUrl = new URL(window.location);
                newUrl.searchParams.delete('rewind_date');
                window.location.href = newUrl.toString();
            });
            
            // Update navbar latest date text when in rewind mode
            if (currentRewindDate) {
                const navbarLatestDate = document.getElementById('navbarLatestDate');
                if (navbarLatestDate) {
                    navbarLatestDate.innerHTML = `<span class="badge bg-warning text-dark ms-1">Rewound to ${currentRewindDate}</span>`;
                }
            }
        }
        
        // Load ticker details
        function loadTickerDetails() {
            fetch(appendRewindDate(`/api/frontend/stock/${ticker}`))
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    document.getElementById('companyName').textContent = data.company_name || 'N/A';
                    document.getElementById('currentPrice').textContent = data.close_price ? `$${data.close_price.toFixed(2)}` : '$--';
                    document.getElementById('marketCap').textContent = formatMarketCap(data.market_cap);
                    document.getElementById('volume').textContent = formatVolume(data.volume);
                    document.getElementById('sector').textContent = data.sector || 'N/A';
                    document.getElementById('industry').textContent = data.industry || 'N/A';
                    document.getElementById('country').textContent = data.country || 'N/A';
                    document.getElementById('description').textContent = data.description || 'No description available.';
                    
                    // Format price change
                    const priceChangeElement = document.getElementById('priceChange');
                    if (data.price_change !== null && data.price_change_pct !== null) {
                        const changeText = `${data.price_change >= 0 ? '+' : ''}$${data.price_change.toFixed(2)} (${data.price_change_pct >= 0 ? '+' : ''}${data.price_change_pct.toFixed(2)}%)`;
                        priceChangeElement.textContent = changeText;
                        priceChangeElement.className = data.price_change >= 0 ? 'ms-1 text-success fw-bold' : 'ms-1 text-danger fw-bold';
                    } else {
                        priceChangeElement.textContent = '--';
                        priceChangeElement.className = 'ms-1 text-muted';
                    }
                    
                    // 52-week range (combined)
                    const week52RangeElement = document.getElementById('week52Range');
                    if (data.week_52_low && data.week_52_high) {
                        week52RangeElement.textContent = `$${data.week_52_low.toFixed(2)} - $${data.week_52_high.toFixed(2)}`;
                    } else {
                        week52RangeElement.textContent = '--';
                    }
                    
                    // Average volume and volume change with badge styling
                    document.getElementById('avgVolume').textContent = formatVolume(data.avg_volume);
                    const volumeChangeElement = document.getElementById('volumeChange');
                    if (data.volume_change_multiplier) {
                        volumeChangeElement.textContent = `${data.volume_change_multiplier.toFixed(1)}x`;
                        volumeChangeElement.className = 'badge bg-warning text-dark';
                    } else {
                        volumeChangeElement.textContent = '--';
                        volumeChangeElement.className = 'badge bg-warning text-dark';
                    }
                    
                    // Returns with badge color coding
                    const return5dElement = document.getElementById('return5d');
                    if (data.return_5d !== null) {
                        return5dElement.textContent = `${data.return_5d >= 0 ? '+' : ''}${data.return_5d.toFixed(1)}%`;
                        if (data.return_5d >= 5) {
                            return5dElement.className = 'badge bg-success';
                        } else if (data.return_5d >= 0) {
                            return5dElement.className = 'badge bg-success bg-opacity-50';
                        } else if (data.return_5d >= -5) {
                            return5dElement.className = 'badge bg-danger bg-opacity-50';
                        } else {
                            return5dElement.className = 'badge bg-danger';
                        }
                    } else {
                        return5dElement.textContent = '--';
                        return5dElement.className = 'badge bg-secondary';
                    }
                    
                    const return20dElement = document.getElementById('return20d');
                    if (data.return_20d !== null) {
                        return20dElement.textContent = `${data.return_20d >= 0 ? '+' : ''}${data.return_20d.toFixed(1)}%`;
                        if (data.return_20d >= 10) {
                            return20dElement.className = 'badge bg-success';
                        } else if (data.return_20d >= 0) {
                            return20dElement.className = 'badge bg-success bg-opacity-50';
                        } else if (data.return_20d >= -10) {
                            return20dElement.className = 'badge bg-danger bg-opacity-50';
                        } else {
                            return20dElement.className = 'badge bg-danger';
                        }
                    } else {
                        return20dElement.textContent = '--';
                        return20dElement.className = 'badge bg-secondary';
                    }
                    
                    const return60dElement = document.getElementById('return60d');
                    if (data.return_60d !== null) {
                        return60dElement.textContent = `${data.return_60d >= 0 ? '+' : ''}${data.return_60d.toFixed(1)}%`;
                        if (data.return_60d >= 20) {
                            return60dElement.className = 'badge bg-success';
                        } else if (data.return_60d >= 0) {
                            return60dElement.className = 'badge bg-success bg-opacity-50';
                        } else if (data.return_60d >= -20) {
                            return60dElement.className = 'badge bg-danger bg-opacity-50';
                        } else {
                            return60dElement.className = 'badge bg-danger';
                        }
                    } else {
                        return60dElement.textContent = '--';
                        return60dElement.className = 'badge bg-secondary';
                    }
                    
                    // Shares and short interest data (placeholders for now)
                    document.getElementById('sharesOutstanding').textContent = data.shares_outstanding ? formatLargeNumber(data.shares_outstanding) : '--';
                    document.getElementById('sharesFloat').textContent = data.shares_float ? formatLargeNumber(data.shares_float) : '--';
                    document.getElementById('shortFloat').textContent = data.short_float ? `${data.short_float.toFixed(1)}%` : '--';
                    document.getElementById('shortRatio').textContent = data.short_ratio ? data.short_ratio.toFixed(1) : '--';
                    document.getElementById('shortInterest').textContent = data.short_interest ? `${data.short_interest.toFixed(1)}%` : '--';
                })
                .catch(error => {
                    console.error('Error loading ticker details:', error);
                    document.getElementById('companyName').textContent = 'Error loading data';
                });
        }
        
        // Load and create both charts
        function loadCharts() {
            // Fetch both price data and earnings data in parallel
            Promise.all([
                fetch(appendRewindDate(`/api/frontend/stock/${ticker}/prices`)).then(response => response.json()),
                fetchEarningsData(ticker)
            ])
                .then(([priceData, earningsData]) => {
                    if (priceData.error) {
                        throw new Error(priceData.error);
                    }
                    
                    // Store earnings data globally so chart creation can access it
                    window.earningsData = earningsData;
                    
                    // Show/hide earnings legend based on data availability
                    const earningsLegend = document.getElementById('earningsLegend');
                    if (earningsData && earningsData.length > 0) {
                        earningsLegend.style.display = 'block';
                    } else {
                        earningsLegend.style.display = 'none';
                    }
                    
                    // Hide loading indicators
                    document.getElementById('loadingChartYearly').style.display = 'none';
                    
                    // Create charts
                    createYearlyChart(priceData);
                })
                .catch(error => {
                    console.error('Error loading chart data:', error);
                    document.getElementById('loadingChartYearly').style.display = 'none';
                    document.getElementById('errorMessageYearly').style.display = 'block';
                    document.getElementById('errorMessageYearly').textContent = `Error loading charts: ${error.message}`;
                });
        }
        
        function create3MonthChart(priceData) {
            // 3-month chart removed - only using yearly chart
            return;
        }

        function createYearlyChart(priceData) {
            createPolishedChart(priceData, 'chartYearly', 'chartYearlyTitle', 'Yearly');
        }

        // New polished chart using Lightweight Charts
        function createPolishedChart(priceData, containerId, titleId, chartType) {
            const container = document.getElementById(containerId);
            // Clear any previous chart content
            container.innerHTML = '';

            // Build data, ensure required fields are present & numeric, convert time to UTC timestamp (seconds)
            const processed = priceData
                .filter(d => d.date && d.open_price != null && d.high_price != null && d.low_price != null && d.close_price != null)
                .map(d => ({
                    time: Math.floor(new Date(d.date + 'T00:00:00Z').getTime() / 1000), // UTCTimestamp expected by library
                    open: +d.open_price,
                    high: +d.high_price,
                    low: +d.low_price,
                    close: +d.close_price,
                    volume: d.volume != null ? +d.volume : undefined
                }))
                .filter(d => [d.open, d.high, d.low, d.close].every(v => !isNaN(v)))
                .sort((a,b) => a.time - b.time);

            if (processed.length === 0) {
                const err = document.getElementById(containerId.replace('chart', 'errorMessage'));
                if (err) {
                    err.style.display = 'block';
                    err.textContent = 'No valid price data available';
                }
                return;
            }

            // Create chart
            const chart = LightweightCharts.createChart(container, {
                width: container.clientWidth || 800,
                height: 1000,
                layout: {
                    background: { color: '#ffffff' },
                    textColor: '#495057',
                    fontSize: 12
                },
                grid: {
                    vertLines: { color: '#edeff1' },
                    horLines: { color: '#edeff1' }
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal
                },
                rightPriceScale: { borderColor: '#dee2e6' },
                timeScale: { 
                    borderColor: '#dee2e6',
                    visible: true,
                    borderVisible: true,
                    // Tactful date labels on the x-axis
                    tickMarkFormatter: (time, tickMarkType) => {
                        // time is UTCTimestamp (seconds) in our data
                        const d = new Date(time * 1000);
                        // Format in UTC to prevent local timezone shifts
                        const fmt = (options) => new Intl.DateTimeFormat('en-US', { timeZone: 'UTC', ...options }).format(d);
                        // Show fewer details for larger intervals to reduce clutter
                        switch (tickMarkType) {
                            case LightweightCharts.TickMarkType.Year:
                                return fmt({ year: 'numeric' });
                            case LightweightCharts.TickMarkType.Month:
                                return fmt({ month: 'short' });
                            case LightweightCharts.TickMarkType.DayOfMonth:
                            default:
                                return fmt({ month: 'short', day: '2-digit' });
                        }
                    },
                    // Disable default wheel scrolling but allow other interactions
                    handleScroll: {
                        mouseWheel: false,
                        pressedMouseMove: true,  // Allow Ctrl+drag panning
                        horzTouchDrag: true,
                        vertTouchDrag: false
                    },
                    handleScale: {
                        mouseWheel: false,  // We'll handle this manually
                        pinch: true,
                        axisPressedMouseMove: {
                            time: true,  // Allow axis dragging
                            price: false
                        },
                        axisDoubleClickReset: true
                    }
                },
                // Global chart interaction settings
                handleScroll: {
                    mouseWheel: false,  // We'll handle this manually
                    pressedMouseMove: true,  // Allow drag panning with qualifier
                    horzTouchDrag: true,
                    vertTouchDrag: false
                },
                handleScale: {
                    mouseWheel: false,  // We'll handle this manually
                    pinch: true,
                    axisPressedMouseMove: {
                        time: false,  // Prevent accidental scaling
                        price: false
                    }
                }
            });

            // Add custom event handling for Ctrl+wheel zooming and Ctrl+drag panning
            let isDragging = false;
            let dragStartX = 0;
            let dragStartRange = null;

            // Handle Ctrl+scroll for zooming
            container.addEventListener('wheel', (event) => {
                if (event.ctrlKey) {
                    // Allow chart zooming when Ctrl is held
                    event.preventDefault();
                    
                    // Manually handle the zoom
                    const timeScale = chart.timeScale();
                    const logicalRange = timeScale.getVisibleLogicalRange();
                    if (logicalRange) {
                        const zoomFactor = event.deltaY > 0 ? 1.1 : 0.9;
                        const center = (logicalRange.from + logicalRange.to) / 2;
                        const newRange = (logicalRange.to - logicalRange.from) * zoomFactor;
                        
                        timeScale.setVisibleLogicalRange({
                            from: center - newRange / 2,
                            to: center + newRange / 2
                        });
                    }
                }
                // If Ctrl is not held, let the event bubble up for normal page scrolling
            }, { passive: false });

            // Handle Ctrl+drag for panning
            container.addEventListener('mousedown', (event) => {
                if (event.ctrlKey) {
                    event.preventDefault();
                    isDragging = true;
                    dragStartX = event.clientX;
                    
                    const timeScale = chart.timeScale();
                    dragStartRange = timeScale.getVisibleLogicalRange();
                    
                    container.style.cursor = 'grabbing';
                }
            });

            container.addEventListener('mousemove', (event) => {
                if (isDragging && event.ctrlKey && dragStartRange) {
                    event.preventDefault();
                    
                    const deltaX = event.clientX - dragStartX;
                    const containerWidth = container.clientWidth;
                    const rangeWidth = dragStartRange.to - dragStartRange.from;
                    
                    // Calculate how much to pan based on mouse movement
                    const panAmount = (deltaX / containerWidth) * rangeWidth;
                    
                    const timeScale = chart.timeScale();
                    timeScale.setVisibleLogicalRange({
                        from: dragStartRange.from - panAmount,
                        to: dragStartRange.to - panAmount
                    });
                }
            });

            container.addEventListener('mouseup', (event) => {
                if (isDragging) {
                    isDragging = false;
                    dragStartRange = null;
                    container.style.cursor = 'default';
                }
            });

            container.addEventListener('mouseleave', (event) => {
                if (isDragging) {
                    isDragging = false;
                    dragStartRange = null;
                    container.style.cursor = 'default';
                }
            });

            // Show grabbing cursor when Ctrl is held over the chart
            container.addEventListener('mouseenter', (event) => {
                if (event.ctrlKey && !isDragging) {
                    container.style.cursor = 'grab';
                }
            });

            container.addEventListener('mouseleave', (event) => {
                if (!isDragging) {
                    container.style.cursor = 'default';
                }
            });

            // Update cursor based on Ctrl key state
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Control' && container.matches(':hover') && !isDragging) {
                    container.style.cursor = 'grab';
                }
            });

            document.addEventListener('keyup', (event) => {
                if (event.key === 'Control' && !isDragging) {
                    container.style.cursor = 'default';
                }
            });

            // Add double-click to reset zoom
            container.addEventListener('dblclick', (event) => {
                event.preventDefault();
                chart.timeScale().fitContent();
            });

            // --- Prepare datasets ---
            const candlesTmp = processed.filter(b => {
                if (!Number.isFinite(b.time) || !Number.isFinite(b.open) || !Number.isFinite(b.high) || !Number.isFinite(b.low) || !Number.isFinite(b.close)) {
                    return false;
                }
                // Basic sanity: all prices positive and high >= max(open,close) >= min(open,close) >= low
                if (b.open <= 0 || b.high <= 0 || b.low <= 0 || b.close <= 0) {
                    return false;
                }
                const top = Math.max(b.open, b.close);
                const bottom = Math.min(b.open, b.close);
                return b.high >= top && b.low <= bottom;
            });
            const volumesTmp = processed.filter(b => Number.isFinite(b.time) && b.volume != null && Number.isFinite(b.volume) && b.volume > 0);

            // Deduplicate by timestamp (Lightweight Charts expects unique times)
            const dedup = (arr) => {
                const seen = new Set();
                const out = [];
                for (const bar of arr) {
                    if (!seen.has(bar.time)) {
                        seen.add(bar.time);
                        out.push(bar);
                    }
                }
                return out;
            };

            const candles = dedup(candlesTmp);
            const volumes = dedup(volumesTmp);

            // Add candlestick series (uses main price scale with top 75% of chart)
            const candleSeries = chart.addCandlestickSeries({
                upColor: '#198754',
                downColor: '#dc3545',
                borderUpColor: '#198754',
                borderDownColor: '#dc3545',
                wickUpColor: '#198754',
                wickDownColor: '#dc3545',
                priceScaleId: 'right'
            });

            candleSeries.setData(candles.map(d => ({
                time: d.time,
                open: d.open,
                high: d.high,
                low: d.low,
                close: d.close
            })));

            // Configure main price scale to use top 75% of chart
            chart.priceScale('right').applyOptions({
                scaleMargins: { top: 0.05, bottom: 0.2 }
            });

            // Add volume series with separate scale in bottom 25% of chart
            const volumeSeries = chart.addHistogramSeries({
                priceFormat: { type: 'volume' },
                priceScaleId: 'volume'
            });

            volumeSeries.setData(volumes.map(d => ({
                time: d.time,
                value: d.volume,
                color: d.close >= d.open ? 'rgba(25,135,84,0.6)' : 'rgba(220,53,69,0.6)'
            })));

            // Configure volume price scale to use bottom 15% of chart and be invisible
            chart.priceScale('volume').applyOptions({
                scaleMargins: { top: 0.85, bottom: 0.05 },
                visible: false
            });

            // Add earnings markers if available
            if (window.earningsData && window.earningsData.length > 0) {
                addEarningsMarkers(chart, candleSeries, window.earningsData, processed[0].time, processed[processed.length - 1].time);
            }

            chart.timeScale().fitContent();

            // Add custom tooltip for hover information
            const tooltip = document.createElement('div');
            tooltip.style.position = 'absolute';
            tooltip.style.padding = '12px';
            tooltip.style.background = 'rgba(255, 255, 255, 0.95)';
            tooltip.style.color = '#212529';
            tooltip.style.border = '1px solid #198754';
            tooltip.style.borderRadius = '8px';
            tooltip.style.pointerEvents = 'none';
            tooltip.style.fontSize = '13px';
            tooltip.style.lineHeight = '1.5';
            tooltip.style.boxShadow = '0 0 15px rgba(0,0,0,0.1)';
            tooltip.style.display = 'none';
            tooltip.style.zIndex = '10000';
            tooltip.style.minWidth = '200px';
            tooltip.style.maxWidth = '250px';
            tooltip.style.whiteSpace = 'nowrap';
            
            container.style.position = 'relative'; // Ensure container is positioned
            container.appendChild(tooltip);

            // Subscribe to crosshair move to show tooltip
            chart.subscribeCrosshairMove(param => {
                // Hide tooltip if no valid crosshair position
                if (param.point === undefined || !param.time) {
                    tooltip.style.display = 'none';
                    return;
                }

                // Get price data at the crosshair position
                const priceData = param.seriesData.get(candleSeries);
                const volumeData = param.seriesData.get(volumeSeries);
                
                // Show tooltip even if only price data is available
                if (!priceData) {
                    tooltip.style.display = 'none';
                    return;
                }

                // Format the date in UTC to avoid timezone shifting the trading day
                const date = new Date(param.time * 1000);
                const dateStr = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    timeZone: 'UTC'
                });

                // Format price values with safety checks
                const open = (priceData.open !== undefined) ? priceData.open.toFixed(2) : 'N/A';
                const high = (priceData.high !== undefined) ? priceData.high.toFixed(2) : 'N/A';
                const low = (priceData.low !== undefined) ? priceData.low.toFixed(2) : 'N/A';
                const close = (priceData.close !== undefined) ? priceData.close.toFixed(2) : 'N/A';
                
                // Calculate price change
                let change = 'N/A';
                let changePercent = 'N/A';
                if (priceData.close !== undefined && priceData.open !== undefined) {
                    change = (priceData.close - priceData.open).toFixed(2);
                    changePercent = (((priceData.close - priceData.open) / priceData.open) * 100).toFixed(2);
                }
                
                // Format volume
                const volume = (volumeData && volumeData.value !== undefined) ? 
                    volumeData.value.toLocaleString() : 'N/A';

                // Build tooltip content
                const changeColor = (change !== 'N/A' && parseFloat(change) >= 0) ? '#198754' : '#dc3545';
                tooltip.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px; color: #198754;">${dateStr}</div>
                    <div><strong>Open:</strong> $${open}</div>
                    <div><strong>High:</strong> $${high}</div>
                    <div><strong>Low:</strong> $${low}</div>
                    <div><strong>Close:</strong> $${close}</div>
                    <div style="color: ${changeColor};"><strong>Change:</strong> $${change} (${changePercent}%)</div>
                    <div><strong>Volume:</strong> ${volume}</div>
                `;

                // Position tooltip relative to chart container
                const tooltipWidth = 200;
                const tooltipHeight = 160;
                
                let left = param.point.x + 15;
                let top = param.point.y - 10;
                
                // Keep tooltip within container bounds
                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;
                
                if (left + tooltipWidth > containerWidth) {
                    left = param.point.x - tooltipWidth - 15;
                }
                if (top + tooltipHeight > containerHeight) {
                    top = param.point.y - tooltipHeight + 10;
                }
                if (top < 0) {
                    top = 10;
                }
                if (left < 0) {
                    left = 10;
                }

                tooltip.style.left = `${left}px`;
                tooltip.style.top = `${top}px`;
                tooltip.style.display = 'block';
            });

            // Update title with date range
            const startDate = processed[0].time;
            const endDate = processed[processed.length - 1].time;
            document.getElementById(titleId).textContent = `${ticker} ${chartType} Chart`;
        }

        function addEarningsMarkers(chart, candleSeries, earningsData, startTime, endTime) {
            const markers = [];
            
            earningsData.forEach(earning => {
                const earningDate = new Date(earning.earnings_date + 'T00:00:00Z');
                const earningTime = Math.floor(earningDate.getTime() / 1000);
                
                // Only add markers for dates that fall within the chart's time range
                if (earningTime >= startTime && earningTime <= endTime) {
                    // Create more informative marker text
                    let markerText = 'E';
                    if (earning.quarter) {
                        markerText += ` ${earning.quarter}`;
                    }
                    if (earning.estimated_eps) {
                        markerText += ` ($${earning.estimated_eps})`;
                    }
                    
                    const marker = {
                        time: earningTime,
                        position: 'aboveBar',
                                                    color: '#000000',
                        shape: 'circle',
                        text: markerText,
                        size: 1.8
                    };
                    markers.push(marker);
                }
            });
            
            if (markers.length > 0) {
                candleSeries.setMarkers(markers);
            }
        }

        function fetchEarningsData(ticker) {
            return fetch(appendRewindDate(`/api/frontend/stock/${ticker}/earnings`))
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 404) {
                            console.log(`No earnings data found for ${ticker}`);
                            return [];
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Loaded ${data.length} earnings entries for ${ticker}`);
                    return data;
                })
                .catch(error => {
                    console.error('Error fetching earnings data:', error);
                    return [];
                });
        }
        
        function formatMarketCap(marketCap) {
            if (!marketCap) return 'N/A';
            if (marketCap >= 1000000000) {
                return `$${(marketCap / 1000000000).toFixed(1)}B`;
            } else if (marketCap >= 1000000) {
                return `$${(marketCap / 1000000).toFixed(0)}M`;
            } else {
                return `$${marketCap.toLocaleString()}`;
            }
        }
        
        function formatVolume(volume) {
            if (!volume) return 'N/A';
            if (volume >= 1000000) {
                return `${(volume / 1000000).toFixed(1)}M`;
            } else if (volume >= 1000) {
                return `${(volume / 1000).toFixed(0)}K`;
            } else {
                return volume.toLocaleString();
            }
        }
        
        function formatLargeNumber(number) {
            if (!number) return 'N/A';
            if (number >= 1000000000) {
                return `${(number / 1000000000).toFixed(1)}B`;
            } else if (number >= 1000000) {
                return `${(number / 1000000).toFixed(1)}M`;
            } else if (number >= 1000) {
                return `${(number / 1000).toFixed(0)}K`;
            } else {
                return number.toLocaleString();
            }
        }
        
        // Comments functions
        function loadComments() {
            fetch(`/api/frontend/comments/${ticker}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loadingComments').style.display = 'none';
                    
                    if (data.error) {
                        document.getElementById('commentsError').style.display = 'block';
                        document.getElementById('commentsError').textContent = data.error;
                        return;
                    }
                    
                    displayComments(data);
                })
                .catch(error => {
                    console.error('Error loading comments:', error);
                    document.getElementById('loadingComments').style.display = 'none';
                    document.getElementById('commentsError').style.display = 'block';
                    document.getElementById('commentsError').textContent = 'Error loading comments';
                });
        }
        
        function displayComments(comments) {
            const commentsList = document.getElementById('commentsList');
            const aiCommentsList = document.getElementById('aiCommentsList');
            
            // Separate user and AI comments
            const userComments = comments.filter(c => c.comment_type === 'user');
            const aiComments = comments.filter(c => c.comment_type === 'ai' && c.status === 'approved');
            
            // Display user comments
            if (userComments.length === 0) {
                commentsList.innerHTML = '<div class="no-comments-message">No user comments yet. Be the first to share your thoughts!</div>';
            } else {
                commentsList.innerHTML = userComments.map(comment => `
                    <div class="user-comment" id="comment-${comment.id}">
                        <div class="card-body p-3">
                            <div class="comment-header">
                                <div class="comment-avatar user-avatar">👤</div>
                                <span>You</span>
                            </div>
                            <div class="comment-content">${escapeHtml(comment.comment_text)}</div>
                            <div class="comment-meta">
                                <div class="comment-date">${comment.formatted_date}</div>
                                <div class="comment-actions">
                                    <button class="btn btn-outline-primary btn-sm" onclick="editComment(${comment.id})">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteComment(${comment.id})">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            // Display AI comments
            if (aiComments.length === 0) {
                aiCommentsList.innerHTML = '<div class="no-comments-message">No AI analysis available yet. Click "Fetch AI Analysis" to generate insights!</div>';
            } else {
                aiCommentsList.innerHTML = aiComments.map(comment => `
                    <div class="ai-comment" id="comment-${comment.id}">
                        <div class="card-body p-3">
                            <div class="comment-header">
                                <div class="comment-avatar ai-avatar">🤖</div>
                                <span>AI Assistant</span>
                                <span class="ai-source-badge">${comment.ai_source || 'AI'}</span>
                            </div>
                            <div class="comment-content">${renderAICommentContent(comment.comment_text)}</div>
                            <div class="comment-meta">
                                <div class="comment-date">${comment.formatted_date}</div>
                                <div class="comment-actions">
                                    <button class="btn btn-outline-primary btn-sm" onclick="editComment(${comment.id})">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteComment(${comment.id})">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function renderAICommentContent(content) {
            // Convert markdown-style formatting to HTML and preserve hyperlinks
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Bold
                .replace(/\n/g, '<br>');  // Line breaks
            // Note: Hyperlinks are already in HTML format from the backend processing
        }
        
        function editComment(commentId) {
            const commentElement = document.getElementById(`comment-${commentId}`);
            const currentText = commentElement.querySelector('.comment-content').textContent.trim();
            
            // Create edit form with prettier styling
            const editForm = `
                <div class="card-body p-3">
                    <div class="comment-header">
                        <div class="comment-avatar user-avatar">✏️</div>
                        <span>Editing...</span>
                    </div>
                    <textarea class="form-control mb-3" rows="4" style="font-size: 0.9rem;">${currentText}</textarea>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success btn-sm" onclick="saveEdit(${commentId})">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="cancelEdit(${commentId})">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            `;
            
            commentElement.innerHTML = editForm;
        }

        function saveEdit(commentId) {
            const commentElement = document.getElementById(`comment-${commentId}`);
            const newText = commentElement.querySelector('textarea').value.trim();
            
            if (!newText) {
                alert('Comment cannot be empty');
                return;
            }
            
            fetch(`/api/frontend/comments/${commentId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    comment_text: newText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                loadComments(); // Reload all comments
            })
            .catch(error => {
                console.error('Error saving edit:', error);
                alert('Error saving edit: ' + error.message);
            });
        }

        function cancelEdit(commentId) {
            loadComments(); // Reload all comments to restore original state
        }

        function deleteComment(commentId) {
            if (!confirm('Are you sure you want to delete this comment?')) {
                return;
            }
            
            fetch(`/api/frontend/comments/${commentId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                loadComments(); // Reload all comments
            })
            .catch(error => {
                console.error('Error deleting comment:', error);
                alert('Error deleting comment: ' + error.message);
            });
        }
        
        function addComment() {
            const commentText = document.getElementById('commentText').value.trim();
            const errorDiv = document.getElementById('commentError');
            
            // Clear any previous errors
            errorDiv.style.display = 'none';
            
            if (!commentText) {
                errorDiv.textContent = 'Please enter a comment';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Disable button during submission
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Adding...';
            
            fetch(`/api/frontend/comments/${ticker}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    comment_text: commentText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    errorDiv.textContent = data.error;
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // Clear the text area and reload comments
                document.getElementById('commentText').value = '';
                loadComments();
            })
            .catch(error => {
                console.error('Error adding comment:', error);
                errorDiv.textContent = 'Error adding comment';
                errorDiv.style.display = 'block';
            })
            .finally(() => {
                // Re-enable button
                button.disabled = false;
                button.textContent = 'Add Comment';
            });
        }
        
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;")
                .replace(/\n/g, "<br>");
        }

        // Add these functions before the DOMContentLoaded event listener
        function fetchAIComments() {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Fetching...';
            
            fetch('/api/perplexity', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ticker: ticker
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Show the input area with the AI response
                document.getElementById('aiCommentInput').style.display = 'block';
                
                // Get the display div and set the HTML content
                const aiCommentDisplay = document.getElementById('aiCommentDisplay');
                
                // Convert markdown-style formatting to HTML
                let htmlContent = data.response
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Bold
                    .replace(/\n/g, '<br>');  // Line breaks
                
                aiCommentDisplay.innerHTML = htmlContent;
                
                // Store the original content for saving
                window.aiCommentContent = data.response;
            })
            .catch(error => {
                console.error('Error fetching AI comments:', error);
                alert('Error fetching AI comments: ' + error.message);
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = 'Fetch AI Comments';
            });
        }
        
        function saveAIComment() {
            // Use the stored content instead of trying to get it from a textarea
            const commentText = window.aiCommentContent;
            
            if (!commentText) {
                alert('No AI comment to save');
                return;
            }
            
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Saving...';
            
            fetch(`/api/ai-comments/${ticker}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    comment_text: commentText,
                    ai_source: 'perplexity'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Clear and hide the input area
                const aiCommentDisplay = document.getElementById('aiCommentDisplay');
                if (aiCommentDisplay) {
                    aiCommentDisplay.innerHTML = '';
                }
                document.getElementById('aiCommentInput').style.display = 'none';
                window.aiCommentContent = null;
                
                // Reload comments to show the new AI comment
                loadComments();
            })
            .catch(error => {
                console.error('Error saving AI comment:', error);
                alert('Error saving AI comment: ' + error.message);
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = 'Save AI Comment';
            });
        }

        // Flags functionality
        function loadFlags() {
            fetch(appendRewindDate(`/api/frontend/flags/${ticker}`))
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading flags:', data.error);
                        return;
                    }
                    
                    // Set checkbox states
                    document.getElementById('reviewedCheck').checked = data.is_reviewed || false;
                    document.getElementById('shortlistCheck').checked = data.is_shortlisted || false;
                    document.getElementById('blacklistCheck').checked = data.is_blacklisted || false;
                })
                .catch(error => {
                    console.error('Error loading flags:', error);
                });
        }
        
        function saveFlags() {
            const reviewedCheck = document.getElementById('reviewedCheck').checked;
            const shortlistCheck = document.getElementById('shortlistCheck').checked;  
            const blacklistCheck = document.getElementById('blacklistCheck').checked;
            const errorDiv = document.getElementById('flagsError');
            const successDiv = document.getElementById('flagsSuccess');
            
            // Hide previous messages
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            // Prepare batch changes
            const changes = [];
            
            // Add changes for each flag
            changes.push({ ticker: ticker, flag: 'reviewed', value: reviewedCheck });
            changes.push({ ticker: ticker, flag: 'shortlisted', value: shortlistCheck });
            changes.push({ ticker: ticker, flag: 'blacklisted', value: blacklistCheck });
            
            fetch('/api/frontend/flags/batch', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    changes: changes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    errorDiv.textContent = data.error;
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // Show success message
                successDiv.textContent = `Flags saved successfully! (${data.success_count} changes)`;
                successDiv.style.display = 'block';
                
                // Hide success message after 3 seconds
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);
                
                // Log any errors if present
                if (data.errors && data.errors.length > 0) {
                    console.warn('Some flag updates had errors:', data.errors);
                }
            })
            .catch(error => {
                errorDiv.textContent = 'Error saving flags: ' + error.message;
                errorDiv.style.display = 'block';
            });
        }

        // Concise Notes functionality
        function loadConciseNote() {
            fetch(appendRewindDate(`/api/frontend/concise-notes/${ticker}`))
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading concise note:', data.error);
                        return;
                    }
                    
                    document.getElementById('conciseNoteText').value = data.note || '';
                    
                    if (data.updated_at) {
                        document.getElementById('noteLastUpdated').textContent = `Last updated: ${new Date(data.updated_at).toLocaleString()}`;
                    } else {
                        document.getElementById('noteLastUpdated').textContent = '';
                    }
                })
                .catch(error => {
                    console.error('Error loading concise note:', error);
                });
        }
        
        function saveConciseNote() {
            const noteText = document.getElementById('conciseNoteText').value.trim();
            const errorDiv = document.getElementById('noteError');
            const successDiv = document.getElementById('noteSuccess');
            
            // Hide previous messages
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            fetch(`/api/frontend/concise-notes/${ticker}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    note: noteText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    errorDiv.textContent = data.error;
                    errorDiv.style.display = 'block';
                    return;
                }
                
                // Show success message
                successDiv.textContent = 'Notes saved successfully!';
                successDiv.style.display = 'block';
                
                // Update last updated timestamp
                if (data.updated_at) {
                    document.getElementById('noteLastUpdated').textContent = `Last updated: ${new Date(data.updated_at).toLocaleString()}`;
                }
                
                // Hide success message after 3 seconds
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);
            })
            .catch(error => {
                errorDiv.textContent = 'Error saving notes: ' + error.message;
                errorDiv.style.display = 'block';
            });
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeRewindControls();
            loadTickerDetails();
            loadCharts();
            loadComments();
            loadConciseNote();
            loadFlags();
            fetchNews();
        });

        function fetchNews() {
            fetch(`/api/frontend/finviz-news/${ticker}`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('newsLoading').style.display = 'none';
                    if (data.error) {
                        document.getElementById('newsError').textContent = data.error;
                        document.getElementById('newsError').style.display = 'block';
                        return;
                    }
                    if (!data.length) {
                        document.getElementById('newsError').textContent = 'No news found';
                        document.getElementById('newsError').style.display = 'block';
                        return;
                    }
                    const tbody = document.querySelector('#newsTable tbody');
                    data.slice(0, 15).forEach(item => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td style="white-space:nowrap;">${item.time || 'N/A'}</td><td><a href="${item.link}" target="_blank">${item.headline}</a></td>`;
                        tbody.appendChild(tr);
                    });
                    document.getElementById('newsTable').style.display = 'table';
                })
                .catch(err => {
                    document.getElementById('newsLoading').style.display = 'none';
                    document.getElementById('newsError').textContent = err.message;
                    document.getElementById('newsError').style.display = 'block';
                });
        }
    </script>
    <!-- Chat script and modal -->
    <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chatModalLabel">Stocks-Assist Chatbot</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height:500px; overflow-y:auto;" id="chatMessages">
                </div>
                <div class="modal-footer d-flex">
                    <input type="text" class="form-control" id="chatInput" placeholder="Ask me anything..." autocomplete="off" />
                    <button class="btn btn-primary ms-2" id="sendChatBtn">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='chat.js') }}"></script>
</body>
</html> 