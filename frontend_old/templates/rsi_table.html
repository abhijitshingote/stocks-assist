{% extends "base.html" %}

{% block title %}RSI Analysis - Stock Screener{% endblock %}

{% block page_title %}RSI Analysis{% endblock %}
{% block page_description %}Relative Strength Index vs SPX and QQQ across different time horizons{% endblock %}

{% set active_page = 'rsi' %}

{% block extra_css %}
<style>
    .rsi-table {
        font-size: 0.85rem;
    }
    .rsi-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
        white-space: nowrap;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    .rsi-table td {
        vertical-align: middle;
        white-space: nowrap;
    }
    .positive { color: #28a745; }
    .negative { color: #dc3545; }
    .ticker-link {
        color: #007bff;
        text-decoration: none;
        font-weight: 600;
    }
    .ticker-link:hover {
        text-decoration: underline;
    }
    .rsi-value {
        font-weight: 500;
    }
    .percentile-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.4rem;
    }
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
    }
    .table-container {
        max-height: 80vh;
        overflow-y: auto;
    }
    .rsi-positive {
        background-color: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }
    .rsi-negative {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }
    /* Force percentile badges to be visible */
    .table .badge.percentile-badge.percentile-high,
    .badge.percentile-badge.percentile-high {
        background-color: #000000 !important;
        color: #ffffff !important;
        border: none !important;
        font-weight: bold !important;
    }
    .table .badge.percentile-badge.percentile-medium,
    .badge.percentile-badge.percentile-medium {
        background-color: #333333 !important;
        color: #ffffff !important;
        border: none !important;
        font-weight: bold !important;
    }
    .table .badge.percentile-badge.percentile-low,
    .badge.percentile-badge.percentile-low {
        background-color: #666666 !important;
        color: #ffffff !important;
        border: none !important;
        font-weight: bold !important;
    }
    .correction-highlight {
        background-color: rgba(255, 193, 7, 0.2);
        border-left: 3px solid #ffc107;
    }
    
    /* Fallback - make ALL percentile badges visible */
    span.badge.percentile-badge {
        background-color: #000000 !important;
        color: #ffffff !important;
        border: 1px solid #333333 !important;
        font-weight: bold !important;
        font-size: 0.75rem !important;
        padding: 0.25rem 0.4rem !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <small class="text-muted">
            RSI values show excess returns vs benchmarks (stock return - benchmark return) Ã— 100
        </small>
    </div>
    <div>
        <button class="btn btn-outline-primary btn-sm" onclick="refreshRSIData()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
</div>

<!-- Filters Row -->
<div class="row mb-3">
    <div class="col-md-3">
        <label for="marketCapFilter" class="form-label">Market Cap</label>
        <select class="form-select form-select-sm" id="marketCapFilter" onchange="applyFilters()">
            <option value="">All Market Caps</option>
            <option value="mega">Mega Cap (>$200B)</option>
            <option value="large">Large Cap ($10B-$200B)</option>
            <option value="mid">Mid Cap ($2B-$10B)</option>
            <option value="small">Small Cap ($300M-$2B)</option>
            <option value="micro">Micro Cap (<$300M)</option>
        </select>
    </div>
    <div class="col-md-3">
        <label for="sectorFilter" class="form-label">Sector</label>
        <select class="form-select form-select-sm" id="sectorFilter" onchange="applyFilters()">
            <option value="">All Sectors</option>
        </select>
    </div>
    <div class="col-md-3">
        <label for="industryFilter" class="form-label">Industry</label>
        <select class="form-select form-select-sm" id="industryFilter" onchange="applyFilters()">
            <option value="">All Industries</option>
        </select>
    </div>
    <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-outline-secondary btn-sm me-2" onclick="clearFilters()">
            <i class="fas fa-times"></i> Clear Filters
        </button>
        <span id="filteredCount" class="text-muted small"></span>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="loading-spinner">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading RSI data...</span>
    </div>
</div>

<!-- Error Message -->
<div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

<!-- Empty State -->
<div id="emptyState" class="empty-state" style="display: none;">
    <h4>No RSI data available</h4>
    <p>Run the RSI update script to populate this data.</p>
</div>

<!-- RSI Table -->
<div class="table-container" id="rsiTableContainer" style="display: none;">
    <table class="table table-striped table-hover table-sm rsi-table">
        <thead class="table-dark">
            <tr>
                <th class="sortable-header" onclick="sortRSITable('ticker')" style="cursor: pointer;">
                    Ticker <i class="fas fa-sort text-muted" id="sort-icon-ticker"></i>
                </th>
                <th class="sortable-header" onclick="sortRSITable('company_name')" style="cursor: pointer;">
                    Company <i class="fas fa-sort text-muted" id="sort-icon-company_name"></i>
                </th>
                <th class="sortable-header" onclick="sortRSITable('sector')" style="cursor: pointer;">
                    Sector <i class="fas fa-sort text-muted" id="sort-icon-sector"></i>
                </th>
                <th class="sortable-header" onclick="sortRSITable('rsi_spx_1week')" style="cursor: pointer;">
                    SPX 1W <i class="fas fa-sort text-muted" id="sort-icon-rsi_spx_1week"></i>
                </th>
                <th class="sortable-header" onclick="sortRSITable('rsi_spx_1month')" style="cursor: pointer;">
                    SPX 1M <i class="fas fa-sort text-muted" id="sort-icon-rsi_spx_1month"></i>
                </th>
                <th class="sortable-header" onclick="sortRSITable('rsi_spx_3month')" style="cursor: pointer;">
                    SPX 3M <i class="fas fa-sort text-muted" id="sort-icon-rsi_spx_3month"></i>
                </th>
                <th class="sortable-header" onclick="sortRSITable('rsi_qqq_1week')" style="cursor: pointer;">
                    QQQ 1W <i class="fas fa-sort text-muted" id="sort-icon-rsi_qqq_1week"></i>
                </th>
                <th class="sortable-header" onclick="sortRSITable('rsi_qqq_1month')" style="cursor: pointer;">
                    QQQ 1M <i class="fas fa-sort text-muted" id="sort-icon-rsi_qqq_1month"></i>
                </th>
                <th class="sortable-header" onclick="sortRSITable('rsi_qqq_3month')" style="cursor: pointer;">
                    QQQ 3M <i class="fas fa-sort text-muted" id="sort-icon-rsi_qqq_3month"></i>
                </th>
                <th class="sortable-header correction-highlight" onclick="sortRSITable('rsi_spx_correction')" style="cursor: pointer;">
                    SPX Correction <i class="fas fa-sort text-muted" id="sort-icon-rsi_spx_correction"></i>
                </th>
            </tr>
        </thead>
        <tbody id="rsiTableBody">
        </tbody>
    </table>
</div>

<!-- Data Last Updated -->
<div id="lastUpdated" class="text-muted text-center mt-3" style="display: none;">
    <small>Data last updated: <span id="lastUpdatedTime"></span></small>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
    // Variables for sorting and filtering functionality
    let rsiData = [];
    let filteredRsiData = [];
    let rsiSortState = { column: null, direction: 'asc' };

    // Load RSI data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadRSIData();
    });

    function loadRSIData() {
        console.log('Loading RSI data...');
        showLoading();
        
        fetch('/api/frontend/rsi')
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('RSI data:', data);
                hideLoading();
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                if (data.length === 0) {
                    showEmptyState();
                    return;
                }
                
                displayRSIData(data);
            })
            .catch(error => {
                console.error('Error loading RSI data:', error);
                hideLoading();
                showError('Failed to load RSI data: ' + error.message);
            });
    }

    function refreshRSIData() {
        loadRSIData();
    }

    function showLoading() {
        document.getElementById('loadingSpinner').style.display = 'flex';
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('rsiTableContainer').style.display = 'none';
        document.getElementById('lastUpdated').style.display = 'none';
    }

    function hideLoading() {
        document.getElementById('loadingSpinner').style.display = 'none';
    }

    function showError(message) {
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('rsiTableContainer').style.display = 'none';
        document.getElementById('lastUpdated').style.display = 'none';
    }

    function showEmptyState() {
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('rsiTableContainer').style.display = 'none';
        document.getElementById('lastUpdated').style.display = 'none';
    }


    
    function updateRSISortIcons(activeColumn, direction) {
        // Reset all icons
        const allIcons = document.querySelectorAll('[id^="sort-icon-"]');
        allIcons.forEach(icon => {
            icon.className = 'fas fa-sort text-muted';
        });
        
        // Set active icon
        const activeIcon = document.getElementById(`sort-icon-${activeColumn}`);
        if (activeIcon) {
            activeIcon.className = direction === 'asc' ? 'fas fa-sort-up text-primary' : 'fas fa-sort-down text-primary';
        }
    }
    
    function sortRSIData(data, column, direction) {
        return [...data].sort((a, b) => {
            let aVal = a[column];
            let bVal = b[column];
            
            // Handle null/undefined values - put them at the end
            if (aVal == null && bVal == null) return 0;
            if (aVal == null) return 1;
            if (bVal == null) return -1;
            
            // Handle different data types
            if (typeof aVal === 'string' && typeof bVal === 'string') {
                // String comparison
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }
            
            // Numeric comparison
            if (typeof aVal === 'number' && typeof bVal === 'number') {
                return direction === 'asc' ? aVal - bVal : bVal - aVal;
            }
            
            // String comparison
            if (aVal < bVal) return direction === 'asc' ? -1 : 1;
            if (aVal > bVal) return direction === 'asc' ? 1 : -1;
            return 0;
        });
    }
    
    function renderRSITable(stocks) {
        const tbody = document.getElementById('rsiTableBody');
        tbody.innerHTML = '';
        
        stocks.forEach((stock, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <a href="/ticker/${stock.ticker}" class="ticker-link">
                        ${stock.ticker}
                    </a>
                </td>
                <td title="${stock.company_name || 'N/A'}">${truncateText(stock.company_name || 'N/A', 30)}</td>
                <td><span class="badge bg-info">${stock.sector || 'N/A'}</span></td>
                <td>${formatRSIValue(stock.rsi_spx_1week, stock.rsi_spx_1week_percentile)}</td>
                <td>${formatRSIValue(stock.rsi_spx_1month, stock.rsi_spx_1month_percentile)}</td>
                <td>${formatRSIValue(stock.rsi_spx_3month, stock.rsi_spx_3month_percentile)}</td>
                <td>${formatRSIValue(stock.rsi_qqq_1week, stock.rsi_qqq_1week_percentile)}</td>
                <td>${formatRSIValue(stock.rsi_qqq_1month, stock.rsi_qqq_1month_percentile)}</td>
                <td>${formatRSIValue(stock.rsi_qqq_3month, stock.rsi_qqq_3month_percentile)}</td>
                <td class="correction-highlight">${formatRSIValue(stock.rsi_spx_correction, stock.rsi_spx_correction_percentile)}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function displayRSIData(stocks) {
        // Store data for sorting and filtering
        rsiData = stocks;
        filteredRsiData = stocks;
        
        // Populate filter dropdowns
        populateFilterDropdowns(stocks);
        
        document.getElementById('rsiTableContainer').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
        
        // Show last updated time
        if (stocks.length > 0 && stocks[0].last_updated) {
            const lastUpdated = new Date(stocks[0].last_updated);
            document.getElementById('lastUpdatedTime').textContent = lastUpdated.toLocaleString();
            document.getElementById('lastUpdated').style.display = 'block';
        }
        
        // Default sort by SPX 1-week RSI descending
        rsiSortState = { column: 'rsi_spx_1week', direction: 'desc' };
        updateRSISortIcons('rsi_spx_1week', 'desc');
        const sortedData = sortRSIData(filteredRsiData, 'rsi_spx_1week', 'desc');
        
        renderRSITable(sortedData);
        updateFilteredCount();
    }

    function formatRSIValue(rsiValue, percentile) {
        if (rsiValue == null) return '<span class="text-muted">N/A</span>';
        
        const rsiClass = rsiValue >= 0 ? 'rsi-positive' : 'rsi-negative';
        
        let html = `<span class="rsi-value ${rsiClass}">${rsiValue.toFixed(2)}</span>`;
        
        if (percentile != null) {
            // Force inline styles - no CSS classes that Bootstrap can override
            const inlineStyle = 'background-color: #000000 !important; color: #ffffff !important; padding: 0.25rem 0.4rem !important; font-size: 0.75rem !important; font-weight: bold !important; border-radius: 0.375rem !important; display: inline-block !important; margin-left: 0.25rem !important;';
            html += ` <span style="${inlineStyle}" title="Percentile rank">${percentile.toFixed(1)}%</span>`;
        }
        
        return html;
    }

    function getPercentileBadgeClass(percentile) {
        if (percentile == null) return 'bg-secondary';
        if (percentile >= 80) return 'percentile-high';
        if (percentile >= 20) return 'percentile-medium';
        return 'percentile-low';
    }

    function truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    // Filter Functions
    function populateFilterDropdowns(stocks) {
        // Get unique sectors and industries
        const sectors = [...new Set(stocks.map(s => s.sector).filter(s => s))].sort();
        const industries = [...new Set(stocks.map(s => s.industry).filter(s => s))].sort();
        
        // Populate sector dropdown
        const sectorSelect = document.getElementById('sectorFilter');
        sectorSelect.innerHTML = '<option value="">All Sectors</option>';
        sectors.forEach(sector => {
            sectorSelect.innerHTML += `<option value="${sector}">${sector}</option>`;
        });
        
        // Populate industry dropdown
        const industrySelect = document.getElementById('industryFilter');
        industrySelect.innerHTML = '<option value="">All Industries</option>';
        industries.forEach(industry => {
            industrySelect.innerHTML += `<option value="${industry}">${industry}</option>`;
        });
    }

    function applyFilters() {
        const marketCapFilter = document.getElementById('marketCapFilter').value;
        const sectorFilter = document.getElementById('sectorFilter').value;
        const industryFilter = document.getElementById('industryFilter').value;
        
        filteredRsiData = rsiData.filter(stock => {
            // Market cap filter
            if (marketCapFilter) {
                const marketCap = stock.market_cap || 0;
                switch (marketCapFilter) {
                    case 'mega':
                        if (marketCap < 200000000000) return false;
                        break;
                    case 'large':
                        if (marketCap < 10000000000 || marketCap >= 200000000000) return false;
                        break;
                    case 'mid':
                        if (marketCap < 2000000000 || marketCap >= 10000000000) return false;
                        break;
                    case 'small':
                        if (marketCap < 300000000 || marketCap >= 2000000000) return false;
                        break;
                    case 'micro':
                        if (marketCap >= 300000000) return false;
                        break;
                }
            }
            
            // Sector filter
            if (sectorFilter && stock.sector !== sectorFilter) return false;
            
            // Industry filter
            if (industryFilter && stock.industry !== industryFilter) return false;
            
            return true;
        });
        
        // Re-sort and render
        const sortedData = sortRSIData(filteredRsiData, rsiSortState.column || 'rsi_spx_1week', rsiSortState.direction || 'desc');
        renderRSITable(sortedData);
        updateFilteredCount();
    }

    function clearFilters() {
        document.getElementById('marketCapFilter').value = '';
        document.getElementById('sectorFilter').value = '';
        document.getElementById('industryFilter').value = '';
        applyFilters();
    }

    function updateFilteredCount() {
        const total = rsiData.length;
        const filtered = filteredRsiData.length;
        const countElement = document.getElementById('filteredCount');
        
        if (filtered === total) {
            countElement.textContent = `${total} stocks`;
        } else {
            countElement.textContent = `${filtered} of ${total} stocks`;
        }
    }

    // Update sort function to work with filtered data
    function sortRSITable(column) {
        // Toggle direction if same column, otherwise default to descending for RSI values
        if (rsiSortState.column === column) {
            rsiSortState.direction = rsiSortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            // Default to descending for RSI columns (highest values first)
            rsiSortState.direction = column.includes('rsi_') ? 'desc' : 'asc';
        }
        rsiSortState.column = column;
        
        // Update sort icons
        updateRSISortIcons(column, rsiSortState.direction);
        
        // Sort the filtered data
        const sortedData = sortRSIData(filteredRsiData, column, rsiSortState.direction);
        
        // Re-render the table
        renderRSITable(sortedData);
    }
</script>
{% endblock %}
